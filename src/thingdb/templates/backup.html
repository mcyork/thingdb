{% extends "base.html" %}

{% block title %}Backup & Restore{% endblock %}

{% block styles %}
<style>
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 12px;
        margin-bottom: 16px;
    }
    .stat-card {
        background: var(--background-light);
        border-radius: 8px;
        padding: 12px;
        text-align: center;
    }
    .stat-value {
        font-size: 20px;
        font-weight: 700;
        color: var(--primary-color);
    }
    .stat-label {
        font-size: 12px;
        color: var(--text-light);
        margin-top: 4px;
    }
    
    /* File Upload Zone with Visual States */
    .file-upload {
        border: 2px dashed var(--border-color);
        border-radius: 8px;
        padding: 32px 16px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        position: relative;
        min-height: 120px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }
    .file-upload:hover { 
        border-color: var(--primary-color); 
        background: var(--background-light); 
    }
    .file-upload.dragover { 
        border-color: var(--primary-color); 
        background: #e3f2fd;
        transform: scale(1.02);
    }
    .file-upload.has-file {
        border-color: #4caf50;
        background: #e8f5e9;
        border-style: solid;
    }
    .file-upload-icon {
        font-size: 32px;
        opacity: 0.6;
    }
    .file-upload.has-file .file-upload-icon {
        opacity: 1;
    }
    .file-upload-text {
        font-size: 14px;
        color: var(--text-light);
    }
    .file-upload.has-file .file-upload-text {
        color: #2e7d32;
        font-weight: 600;
    }
    .file-selected-info {
        display: none;
        background: white;
        border-radius: 6px;
        padding: 12px;
        margin-top: 8px;
    }
    .file-selected-info.show {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
    }
    .file-info-text {
        flex: 1;
        text-align: left;
        font-size: 13px;
    }
    .file-name {
        font-weight: 600;
        color: #333;
    }
    .file-size {
        color: #666;
        font-size: 12px;
    }
    
    /* Progress Bar */
    .progress-container {
        display: none;
        margin-top: 12px;
    }
    .progress-container.show {
        display: block;
    }
    .progress-bar-wrapper {
        background: #e0e0e0;
        border-radius: 4px;
        height: 8px;
        overflow: hidden;
        margin-bottom: 8px;
    }
    .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #4caf50, #81c784);
        transition: width 0.3s;
        border-radius: 4px;
    }
    .progress-text {
        font-size: 12px;
        color: var(--text-light);
        text-align: center;
    }
    
    /* Status Messages */
    .status-message {
        padding: 10px 12px;
        border-radius: 6px;
        font-size: 13px;
        margin-top: 12px;
        display: none;
        animation: slideIn 0.3s;
    }
    .status-message.show {
        display: block;
    }
    .status-success {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
    }
    .status-error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
    }
    .status-info {
        background: #d1ecf1;
        border: 1px solid #bee5eb;
        color: #0c5460;
    }
    .status-warning {
        background: #fff3cd;
        border: 1px solid #ffc107;
        color: #856404;
    }
    
    /* Backup List */
    .backup-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px;
        border-bottom: 1px solid var(--border-color);
        transition: background 0.2s;
    }
    .backup-item:hover {
        background: var(--background-light);
    }
    .backup-item:last-child { border-bottom: none; }
    .backup-info { flex: 1; }
    .backup-name { font-weight: 600; font-size: 14px; }
    .backup-meta { font-size: 12px; color: var(--text-light); margin-top: 2px; }
    .backup-actions-item { 
        display: flex; 
        gap: 6px;
    }
    
    /* Action Buttons */
    .btn-icon {
        padding: 8px 12px;
        font-size: 16px;
    }
    
    /* Inline Confirmation */
    .confirm-actions {
        display: none;
        gap: 8px;
        margin-top: 8px;
    }
    .confirm-actions.show {
        display: flex;
    }
    
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}

{% block app_content %}
<div class="sub-header">
    <div class="sub-header-content">
        <button onclick="history.back()" class="sub-header-back-btn">‚Üê</button>
        <h1 class="sub-header-title">Backup & Restore</h1>
    </div>
</div>

<div class="app-content">
    <!-- Stats Overview -->
    <div class="card">
        <div class="stats-grid" id="backup-stats">
            <div class="stat-card"><div class="stat-value" id="db-size">-</div><div class="stat-label">DB Size</div></div>
            <div class="stat-card"><div class="stat-value" id="item-count">-</div><div class="stat-label">Items</div></div>
            <div class="stat-card"><div class="stat-value" id="image-count">-</div><div class="stat-label">Images</div></div>
            <div class="stat-card"><div class="stat-value" id="backup-count">-</div><div class="stat-label">Backups</div></div>
        </div>
        <button class="btn btn-primary btn-block" onclick="createBackup()" id="create-backup-btn">üíæ Create New Backup</button>
    </div>

    <!-- Restore Section -->
    <div class="card">
        <h3 style="margin-bottom: 16px;">üîÑ Restore Backup</h3>
        
        <!-- File Upload with Visual Feedback -->
        <div class="file-upload" id="file-upload-zone" 
             onclick="document.getElementById('restore-file').click()" 
             ondrop="handleFileDrop(event)" 
             ondragover="handleDragOver(event)" 
             ondragleave="handleDragLeave(event)">
            <input type="file" id="restore-file" accept=".zip" onchange="handleFileSelect(event)" style="display:none;">
            <div class="file-upload-icon" id="upload-icon">üìÅ</div>
            <div class="file-upload-text" id="upload-text">Drop backup file here or click to select</div>
            <div style="font-size: 11px; color: #999; margin-top: 4px;">Maximum upload size: <span id="upload-limit-display">Loading...</span></div>
        </div>
        
        <!-- Selected File Info -->
        <div class="file-selected-info" id="file-selected-info">
            <div class="file-info-text">
                <div class="file-name" id="selected-file-name">-</div>
                <div class="file-size" id="selected-file-size-text">-</div>
            </div>
            <button class="btn btn-secondary btn-sm" onclick="clearSelectedFile()">‚úï Clear</button>
        </div>
        
        <!-- Progress Bar -->
        <div class="progress-container" id="progress-container">
            <div class="progress-bar-wrapper">
                <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
            </div>
            <div class="progress-text" id="progress-text">Uploading...</div>
        </div>
        
        <!-- Status Messages -->
        <div class="status-message" id="status-message"></div>
        
        <!-- Inline Confirmation -->
        <div class="confirm-actions" id="confirm-actions">
            <button class="btn btn-danger btn-block" onclick="confirmRestore()">‚ö†Ô∏è Yes, Replace All Data</button>
            <button class="btn btn-secondary btn-block" onclick="cancelRestore()">Cancel</button>
        </div>
        
        <!-- Restore Button -->
        <button class="btn btn-primary btn-block" style="margin-top: 12px;" onclick="initiateRestore()" id="restore-btn" disabled>
            Restore from File
        </button>
        
        <!-- Or restore from existing -->
        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color);">
            <label class="form-label" style="font-size: 13px; margin-bottom: 8px;">Or restore from saved backup:</label>
            <select id="restore-backup-select" class="form-input" style="margin-bottom: 8px;">
                <option value="">Select a backup...</option>
            </select>
            <button class="btn btn-secondary btn-block" onclick="restoreFromExisting()" id="restore-existing-btn" disabled>
                Restore Selected
            </button>
        </div>
    </div>

    <!-- Available Backups List -->
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <h3 style="margin: 0;">üìã Saved Backups</h3>
            <button class="btn btn-secondary btn-sm" onclick="loadBackupStatus()">üîÑ Refresh</button>
        </div>
        <div id="backup-list">
            <div style="text-align: center; padding: 20px; color: var(--text-light);">
                <span style="font-size: 32px;">üì¶</span>
                <p>Loading backups...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let selectedFile = null;
let maxUploadSize = 0;

document.addEventListener('DOMContentLoaded', loadBackupStatus);

function loadBackupStatus() {
    fetch('/api/backup/status')
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                updateBackupStats(data);
                updateBackupList(data.backups);
            } else {
                showStatus('Error loading backup status: ' + data.error, 'error');
            }
        }).catch(err => showStatus('Failed to load backup status', 'error'));
}

function updateBackupStats(data) {
    document.getElementById('db-size').textContent = data.database_info.size;
    document.getElementById('item-count').textContent = data.database_info.item_count;
    document.getElementById('image-count').textContent = data.database_info.image_count;
    document.getElementById('backup-count').textContent = data.backups.length;
    
    // Store and display upload limit
    maxUploadSize = data.max_upload_size || 0;
    document.getElementById('upload-limit-display').textContent = data.max_upload_size_human || 'Unknown';
}

function showStatus(message, type) {
    const statusEl = document.getElementById('status-message');
    statusEl.textContent = message;
    statusEl.className = 'status-message status-' + type + ' show';
    
    // Auto-hide success messages
    if (type === 'success') {
        setTimeout(() => {
            statusEl.classList.remove('show');
        }, 5000);
    }
}

function hideStatus() {
    document.getElementById('status-message').classList.remove('show');
}

function showProgress(percent, text) {
    const container = document.getElementById('progress-container');
    const bar = document.getElementById('progress-bar');
    const textEl = document.getElementById('progress-text');
    
    container.classList.add('show');
    bar.style.width = percent + '%';
    textEl.textContent = text || `${percent}%`;
}

function hideProgress() {
    document.getElementById('progress-container').classList.remove('show');
    document.getElementById('progress-bar').style.width = '0%';
}

function updateBackupList(backups) {
    const listEl = document.getElementById('backup-list');
    const selectEl = document.getElementById('restore-backup-select');
    listEl.innerHTML = '';
    selectEl.innerHTML = '<option value="">Select a backup...</option>';

    if (backups.length === 0) {
        listEl.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-light);"><span style="font-size: 32px;">üì¶</span><p style="margin-top: 8px;">No backups found</p></div>';
        return;
    }

    backups.forEach(backup => {
        const itemEl = document.createElement('div');
        itemEl.className = 'backup-item';
        itemEl.innerHTML = `
            <div class="backup-info">
                <div class="backup-name">${backup.filename}</div>
                <div class="backup-meta">${new Date(backup.created).toLocaleString()} ‚Ä¢ ${backup.size_human}</div>
            </div>
            <div class="backup-actions-item">
                <button class="btn btn-secondary btn-icon" onclick="downloadBackup('${backup.filename}')" title="Download">üì•</button>
                <button class="btn btn-danger btn-icon" onclick="confirmDeleteBackup('${backup.filename}')" title="Delete">üóëÔ∏è</button>
            </div>
        `;
        listEl.appendChild(itemEl);

        const option = document.createElement('option');
        option.value = backup.filename;
        option.textContent = `${backup.filename} (${backup.size_human})`;
        selectEl.appendChild(option);
    });
}

function confirmDeleteBackup(filename) {
    if (confirm(`Delete backup "${filename}"?\n\nThis cannot be undone.`)) {
        deleteBackup(filename);
    }
}

function createBackup() {
    const btn = document.getElementById('create-backup-btn');
    const originalHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '‚è≥ Creating Backup...';
    
    showStatus('üì¶ Creating backup...', 'info');
    
    fetch('/api/backup/create', { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                showStatus(`‚úÖ Backup created: ${data.backup_file}`, 'success');
                loadBackupStatus();
            } else {
                showStatus('‚ùå Failed to create backup: ' + data.error, 'error');
            }
        })
        .catch(err => showStatus('‚ùå Failed to create backup', 'error'))
        .finally(() => { 
            btn.disabled = false; 
            btn.innerHTML = originalHtml; 
        });
}

function downloadBackup(filename) { window.location.href = `/api/backup/download/${filename}`; }

function deleteBackup(filename) {
    showStatus(`üóëÔ∏è Deleting ${filename}...`, 'info');
    
    fetch(`/api/backup/delete/${filename}`, { method: 'DELETE' })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                showStatus('‚úÖ Backup deleted', 'success');
                loadBackupStatus();
            } else {
                showStatus('‚ùå Failed to delete backup: ' + data.error, 'error');
            }
        }).catch(err => showStatus('‚ùå Failed to delete backup', 'error'));
}

document.getElementById('restore-backup-select').addEventListener('change', function() {
    document.getElementById('restore-existing-btn').disabled = !this.value;
});

function restoreFromExisting() {
    const filename = document.getElementById('restore-backup-select').value;
    if (!filename) return showStatus('‚ö†Ô∏è Please select a backup file', 'warning');
    if (!confirm(`Restore from "${filename}"?\n\nThis will replace ALL current data!`)) return;
    
    const btn = document.getElementById('restore-existing-btn');
    btn.disabled = true;
    btn.innerHTML = '‚è≥ Restoring...';
    
    showStatus('üì¶ Restoring from backup...', 'info');

    fetch(`/api/backup/restore-existing/${filename}`, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                showStatus('‚úÖ ' + data.message, 'success');
                setTimeout(() => loadBackupStatus(), 2000);
            } else {
                showStatus('‚ùå Restore failed: ' + data.error, 'error');
            }
        })
        .catch(err => showStatus('‚ùå Restore failed', 'error'))
        .finally(() => { 
            btn.disabled = false; 
            btn.innerHTML = 'Restore Selected'; 
        });
}

// Step 1: User clicks "Restore from File" - show inline confirmation
function initiateRestore() {
    if (!selectedFile) return showStatus('No file selected', 'error');
    
    // Hide restore button, show confirmation
    document.getElementById('restore-btn').style.display = 'none';
    document.getElementById('confirm-actions').classList.add('show');
    showStatus(`‚ö†Ô∏è This will replace ALL current data with backup: ${selectedFile.name}`, 'warning');
}

// Step 2: User confirms - start upload
function confirmRestore() {
    if (!selectedFile) return;
    
    // Hide confirmation
    document.getElementById('confirm-actions').classList.remove('show');
    
    // Disable all controls
    const restoreBtn = document.getElementById('restore-btn');
    restoreBtn.disabled = true;
    restoreBtn.textContent = 'Restoring...';
    
    // Show progress
    showProgress(0, 'Starting upload...');
    showStatus('üì§ Uploading backup file...', 'info');
    
    const formData = new FormData();
    formData.append('backup_file', selectedFile);
    
    // Create XMLHttpRequest for progress tracking
    const xhr = new XMLHttpRequest();
    
    xhr.upload.addEventListener('progress', (e) => {
        if (e.lengthComputable) {
            const percent = Math.round((e.loaded / e.total) * 100);
            showProgress(percent, `Uploading: ${percent}%`);
        }
    });
    
    xhr.addEventListener('load', () => {
        if (xhr.status === 200) {
            try {
                const data = JSON.parse(xhr.responseText);
                if (data.success) {
                    showProgress(100, 'Restore complete!');
                    showStatus('‚úÖ ' + data.message, 'success');
                    setTimeout(() => {
                        clearSelectedFile();
                        loadBackupStatus();
                    }, 2000);
                } else {
                    showStatus('‚ùå Restore failed: ' + data.error, 'error');
                    hideProgress();
                }
            } catch (e) {
                showStatus('‚ùå Restore failed: Invalid response', 'error');
                hideProgress();
            }
        } else {
            showStatus(`‚ùå Restore failed: HTTP ${xhr.status}`, 'error');
            hideProgress();
        }
        
        // Re-enable controls
        restoreBtn.disabled = false;
        restoreBtn.textContent = 'Restore from File';
        restoreBtn.style.display = 'block';
    });
    
    xhr.addEventListener('error', () => {
        showStatus('‚ùå Network error during restore', 'error');
        hideProgress();
        restoreBtn.disabled = false;
        restoreBtn.textContent = 'Restore from File';
        restoreBtn.style.display = 'block';
    });
    
    xhr.open('POST', '/api/backup/restore');
    xhr.send(formData);
}

// Step 3: User cancels - hide confirmation
function cancelRestore() {
    document.getElementById('confirm-actions').classList.remove('show');
    document.getElementById('restore-btn').style.display = 'block';
    showStatus('Restore cancelled', 'info');
}

function handleFileSelect(event) {
    const file = event.target.files[0];
    if (file) {
        selectFile(file);
    }
}

function selectFile(file) {
    selectedFile = file;
    
    // Update visual state of upload zone
    const uploadZone = document.getElementById('file-upload-zone');
    const icon = document.getElementById('upload-icon');
    const text = document.getElementById('upload-text');
    
    uploadZone.classList.add('has-file');
    icon.textContent = '‚úÖ';
    text.textContent = 'File ready to restore';
    
    // Show file info
    const fileInfo = document.getElementById('file-selected-info');
    document.getElementById('selected-file-name').textContent = file.name;
    document.getElementById('selected-file-size-text').textContent = formatBytes(file.size);
    fileInfo.classList.add('show');
    
    // Check size and enable/disable restore button
    const restoreBtn = document.getElementById('restore-btn');
    
    if (maxUploadSize > 0 && file.size > maxUploadSize) {
        // File too large
        restoreBtn.disabled = true;
        showStatus(`‚ö†Ô∏è File too large! ${formatBytes(file.size)} exceeds ${formatBytes(maxUploadSize)} limit.`, 'warning');
    } else {
        // File OK
        restoreBtn.disabled = false;
        showStatus(`‚úì Selected: ${file.name} (${formatBytes(file.size)})`, 'success');
    }
}

function clearSelectedFile() {
    selectedFile = null;
    
    // Reset upload zone
    const uploadZone = document.getElementById('file-upload-zone');
    const icon = document.getElementById('upload-icon');
    const text = document.getElementById('upload-text');
    
    uploadZone.classList.remove('has-file');
    icon.textContent = 'üìÅ';
    text.textContent = 'Drop backup file here or click to select';
    
    // Hide file info
    document.getElementById('file-selected-info').classList.remove('show');
    document.getElementById('restore-btn').disabled = true;
    
    // Reset file input
    document.getElementById('restore-file').value = '';
    
    hideStatus();
    hideProgress();
}

function formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

function handleDragOver(event) { 
    event.preventDefault(); 
    event.currentTarget.classList.add('dragover'); 
}

function handleDragLeave(event) { 
    event.preventDefault(); 
    event.currentTarget.classList.remove('dragover'); 
}

function handleFileDrop(event) {
    event.preventDefault();
    event.currentTarget.classList.remove('dragover');
    const file = event.dataTransfer.files[0];
    if (file && file.name.endsWith('.zip')) {
        selectFile(file);
    } else {
        showStatus('‚ö†Ô∏è Please select a .zip backup file', 'warning');
    }
}
</script>
{% endblock %}
