{% extends "base.html" %}

{% block title %}Backup & Restore{% endblock %}

{% block styles %}
<style>
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 16px;
        margin-bottom: 16px;
    }
    .stat-card {
        background: var(--background-light);
        border-radius: 8px;
        padding: 16px;
        text-align: center;
    }
    .stat-value {
        font-size: 24px;
        font-weight: 700;
        color: var(--primary-color);
    }
    .stat-label {
        font-size: 13px;
        color: var(--text-light);
        margin-top: 4px;
    }
    .actions-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
    }
    .backup-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 0;
        border-bottom: 1px solid var(--border-color);
    }
    .backup-item:last-child { border-bottom: none; }
    .backup-info { flex: 1; }
    .backup-name { font-weight: 600; }
    .backup-meta { font-size: 13px; color: var(--text-light); }
    .backup-actions-item { display: flex; gap: 8px; }
    .file-upload {
        border: 2px dashed var(--border-color);
        border-radius: 8px;
        padding: 24px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
    }
    .file-upload:hover { border-color: var(--primary-color); background: var(--background-light); }
    .file-upload.dragover { border-color: var(--primary-color); background: #e3f2fd; }
    .loading { text-align: center; padding: 16px; display: none; }
    .alert {
        padding: 12px; border-radius: 8px; margin-top: 16px;
        border: 1px solid;
    }
    .alert-success { background: #d4edda; border-color: #c3e6cb; color: #155724; }
    .alert-danger { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }
</style>
{% endblock %}

{% block app_content %}
<div class="sub-header">
    <div class="sub-header-content">
        <button onclick="history.back()" class="sub-header-back-btn">‚Üê</button>
        <h1 class="sub-header-title">Backup & Restore</h1>
    </div>
</div>

<div class="app-content">
    <div id="messages"></div>

    <div class="card">
        <div class="stats-grid" id="backup-stats">
            <div class="stat-card"><div class="stat-value" id="db-size">-</div><div class="stat-label">DB Size</div></div>
            <div class="stat-card"><div class="stat-value" id="item-count">-</div><div class="stat-label">Items</div></div>
            <div class="stat-card"><div class="stat-value" id="image-count">-</div><div class="stat-label">Images</div></div>
            <div class="stat-card"><div class="stat-value" id="backup-count">-</div><div class="stat-label">Backups</div></div>
        </div>
        <div class="actions-grid">
            <button class="btn btn-primary" onclick="createBackup()" id="create-backup-btn">üíæ Create Backup</button>
            <button class="btn btn-secondary" onclick="loadBackupStatus()" id="refresh-btn">üîÑ Refresh</button>
        </div>
    </div>

    <div class="card">
        <h3>üîÑ Restore from File</h3>
        <div style="background: #e3f2fd; border: 1px solid #1976d2; border-radius: 8px; padding: 12px; margin-bottom: 16px; font-size: 13px;">
            <strong>‚ÑπÔ∏è Upload Limit:</strong> <span id="upload-limit-display">Loading...</span>
            <div style="margin-top: 4px; color: #555;">
                If your backup is larger, contact your administrator to increase the limit.
            </div>
        </div>
        <div class="form-group">
            <label for="restore-backup-select" class="form-label">Restore from an existing backup:</label>
            <select id="restore-backup-select" class="form-input" style="margin-bottom: 8px;"><option value="">Select a backup...</option></select>
            <button class="btn btn-secondary btn-block" onclick="restoreFromExisting()" id="restore-existing-btn" disabled>Restore from Selection</button>
        </div>
        <div class="form-group">
            <label class="form-label">Or upload a new backup file:</label>
            <div class="file-upload" onclick="document.getElementById('restore-file').click()" ondrop="handleFileDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                <input type="file" id="restore-file" accept=".zip" onchange="handleFileSelect(event)" style="display:none;">
                <span>üìÅ Drop backup file or click to select</span>
            </div>
            <div id="file-size-warning" style="display: none; background: #fff3cd; border: 1px solid #ffc107; border-radius: 6px; padding: 8px; margin-top: 8px; font-size: 13px; color: #856404;">
                ‚ö†Ô∏è <strong>File too large!</strong> Your file is <span id="selected-file-size"></span>, but the upload limit is <span id="limit-size"></span>.
            </div>
            <button class="btn btn-secondary btn-block" onclick="restoreFromUpload()" id="restore-upload-btn" style="margin-top: 8px;" disabled>Upload and Restore</button>
        </div>
    </div>

    <div class="card">
        <h3>üìã Available Backups</h3>
        <div id="backup-list">
            <div class="no-backups" style="text-align: center; padding: 20px; color: var(--text-light);">
                <span>üì¶</span>
                <p>No backups found</p>
            </div>
        </div>
    </div>
    <div class="loading" id="loading"><span>‚è≥</span> Processing...</div>
</div>
{% endblock %}

{% block scripts %}
<script>
let selectedFile = null;
let maxUploadSize = 0;

document.addEventListener('DOMContentLoaded', loadBackupStatus);

function loadBackupStatus() {
    fetch('/api/backup/status')
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                updateBackupStats(data);
                updateBackupList(data.backups);
            } else {
                showMessage('Error loading backup status: ' + data.error, 'danger');
            }
        }).catch(err => showMessage('Failed to load backup status', 'danger'));
}

function updateBackupStats(data) {
    document.getElementById('db-size').textContent = data.database_info.size;
    document.getElementById('item-count').textContent = data.database_info.item_count;
    document.getElementById('image-count').textContent = data.database_info.image_count;
    document.getElementById('backup-count').textContent = data.backups.length;
    
    // Store and display upload limit
    maxUploadSize = data.max_upload_size || 0;
    document.getElementById('upload-limit-display').textContent = data.max_upload_size_human || 'Unknown';
}

function updateBackupList(backups) {
    const listEl = document.getElementById('backup-list');
    const selectEl = document.getElementById('restore-backup-select');
    listEl.innerHTML = '';
    selectEl.innerHTML = '<option value="">Select a backup...</option>';

    if (backups.length === 0) {
        listEl.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-light);">üì¶ No backups found</div>';
        return;
    }

    backups.forEach(backup => {
        const itemEl = document.createElement('div');
        itemEl.className = 'backup-item';
        itemEl.innerHTML = `
            <div class="backup-info">
                <div class="backup-name">${backup.filename}</div>
                <div class="backup-meta">${new Date(backup.created).toLocaleString()} ‚Ä¢ ${backup.size_human}</div>
            </div>
            <div class="backup-actions-item">
                <button class="btn btn-secondary" onclick="downloadBackup('${backup.filename}')">üì•</button>
                <button class="btn btn-danger" onclick="deleteBackup('${backup.filename}')">üóëÔ∏è</button>
            </div>
        `;
        listEl.appendChild(itemEl);

        const option = document.createElement('option');
        option.value = backup.filename;
        option.textContent = `${backup.filename} (${backup.size_human})`;
        selectEl.appendChild(option);
    });
}

function createBackup() {
    const btn = document.getElementById('create-backup-btn');
    const originalHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = 'Creating...';
    
    fetch('/api/backup/create', { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                showMessage(`Backup created: ${data.backup_file}`, 'success');
                loadBackupStatus();
            } else {
                showMessage('Failed to create backup: ' + data.error, 'danger');
            }
        })
        .catch(err => showMessage('Failed to create backup', 'danger'))
        .finally(() => { btn.disabled = false; btn.innerHTML = originalHtml; });
}

function downloadBackup(filename) { window.location.href = `/api/backup/download/${filename}`; }

function deleteBackup(filename) {
    if (!confirm(`Delete backup "${filename}"?`)) return;
    fetch(`/api/backup/delete/${filename}`, { method: 'DELETE' })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                showMessage('Backup deleted.', 'success');
                loadBackupStatus();
            } else {
                showMessage('Failed to delete backup: ' + data.error, 'danger');
            }
        }).catch(err => showMessage('Failed to delete backup.', 'danger'));
}

document.getElementById('restore-backup-select').addEventListener('change', function() {
    document.getElementById('restore-existing-btn').disabled = !this.value;
});

function restoreFromExisting() {
    const filename = document.getElementById('restore-backup-select').value;
    if (!filename) return showMessage('Please select a backup file.', 'danger');
    if (!confirm(`Restore from "${filename}"? This will replace all current data.`)) return;
    
    const btn = document.getElementById('restore-existing-btn');
    btn.disabled = true;
    btn.innerHTML = 'Restoring...';

    fetch(`/api/backup/restore-existing/${filename}`, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                showMessage(data.message, 'success');
                if (data.message.includes('restart')) {
                    setTimeout(() => showMessage('Page will refresh when the app restarts.', 'info'), 3000);
                }
            } else {
                showMessage('Restore failed: ' + data.error, 'danger');
            }
        })
        .catch(err => showMessage('Restore failed.', 'danger'))
        .finally(() => { btn.disabled = false; btn.innerHTML = 'Restore from Selection'; });
}

function restoreFromUpload() {
    if (!selectedFile) return showMessage('Please select a backup file to upload.', 'danger');
    if (!confirm(`Restore from uploaded file "${selectedFile.name}"? This will replace all current data.`)) return;

    const btn = document.getElementById('restore-upload-btn');
    btn.disabled = true;
    btn.innerHTML = 'Restoring...';

    const formData = new FormData();
    formData.append('backup_file', selectedFile);

    fetch('/api/backup/restore', { method: 'POST', body: formData })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                showMessage(data.message, 'success');
                if (data.message.includes('restart')) {
                    setTimeout(() => showMessage('Page will refresh when the app restarts.', 'info'), 3000);
                }
            } else {
                showMessage('Restore failed: ' + data.error, 'danger');
            }
        })
        .catch(err => showMessage('Restore failed.', 'danger'))
        .finally(() => { btn.disabled = false; btn.innerHTML = 'Upload and Restore'; });
}

function handleFileSelect(event) {
    const file = event.target.files[0];
    if (file) {
        selectedFile = file;
        checkFileSize(file);
    }
}

function checkFileSize(file) {
    const warning = document.getElementById('file-size-warning');
    const uploadBtn = document.getElementById('restore-upload-btn');
    
    if (maxUploadSize > 0 && file.size > maxUploadSize) {
        // File too large
        warning.style.display = 'block';
        document.getElementById('selected-file-size').textContent = formatBytes(file.size);
        document.getElementById('limit-size').textContent = formatBytes(maxUploadSize);
        uploadBtn.disabled = true;
        showMessage(`File "${file.name}" is too large (${formatBytes(file.size)}). Limit is ${formatBytes(maxUploadSize)}.`, 'danger');
    } else {
        // File OK
        warning.style.display = 'none';
        uploadBtn.disabled = false;
        showMessage(`Selected file: ${file.name} (${formatBytes(file.size)})`, 'success');
    }
}

function formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

function handleDragOver(event) { event.preventDefault(); event.currentTarget.classList.add('dragover'); }
function handleDragLeave(event) { event.preventDefault(); event.currentTarget.classList.remove('dragover'); }
function handleFileDrop(event) {
    event.preventDefault();
    event.currentTarget.classList.remove('dragover');
    const file = event.dataTransfer.files[0];
    if (file && file.name.endsWith('.zip')) {
        selectedFile = file;
        checkFileSize(file);
    } else {
        showMessage('Please select a .zip backup file.', 'danger');
    }
}
</script>
{% endblock %}
