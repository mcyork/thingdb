<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{% block title %}Inventory Management System{% endblock %}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#007bff">
    <link rel="icon" href="/static/favicon.svg" type="image/svg+xml">
    
    <!-- iOS specific meta tags for better app-like experience -->
    <meta name="format-detection" content="telephone=no">
    <link rel="apple-touch-icon" href="/static/icon-192.png">
    
    {% block extra_head %}{% endblock %}
    
    <style>
        /* 1. Global Design System (CSS Variables) */
        :root {
            --primary-color: #007bff;
            --primary-hover: #0056b3;
            --secondary-color: #6c757d;
            --background-light: #f8f9fa;
            --background-white: #ffffff;
            --text-dark: #212529;
            --text-medium: #495057;
            --text-light: #6c757d;
            --border-color: #dee2e6;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --font-sans-serif: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
        }

        /* 2. CSS Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        html, body {
            height: 100%;
            width: 100%;
            overflow-x: hidden;
        }
        
        body {
            font-family: var(--font-sans-serif);
            background: var(--background-light);
            color: var(--text-dark);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            touch-action: manipulation;
        }
        
        /* 3. App Container & Layout */
        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background: var(--background-white);
        }
        
        .app-content {
            flex: 1;
            padding: 16px;
            padding-bottom: env(safe-area-inset-bottom);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* 4. Component Library */

        /* Header Styles */
        .app-header {
            background: var(--primary-color);
            color: white;
            padding: env(safe-area-inset-top) 0 0 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 4px var(--shadow-color);
        }
        
        .app-header-content {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .app-header h1 {
            font-size: 20px;
            font-weight: 600;
            margin: 0;
        }
        
        .app-version {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 2px;
        }

        /* Unified Sub-Header for Inner Pages */
        .sub-header {
            background: var(--background-white);
            color: var(--text-dark);
            padding: env(safe-area-inset-top) 0 0 0;
            position: sticky;
            top: 0;
            z-index: 999;
            box-shadow: 0 2px 4px var(--shadow-color);
        }

        .sub-header-content {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sub-header-back-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--primary-color);
            cursor: pointer;
            padding: 4px;
        }

        .sub-header-title {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }
        
        /* Button System */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 20px;
            border: 1px solid transparent;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            text-align: center;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s;
            -webkit-appearance: none;
            user-select: none;
        }
        
        .btn:active {
            transform: scale(0.97);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background: var(--primary-hover);
            border-color: var(--primary-hover);
        }
        
        .btn-secondary {
            background: transparent;
            color: var(--text-medium);
            border-color: var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--background-light);
            border-color: #b0b6bc;
        }
        
        .btn-danger {
            background: transparent;
            color: var(--danger-color);
            border-color: var(--danger-color);
        }

        .btn-danger:hover {
            background: var(--danger-color);
            color: white;
        }
        
        .btn-block {
            display: flex;
            width: 100%;
        }
        
        /* Card Component */
        .card {
            background: var(--background-white);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px var(--shadow-color);
            border: 1px solid var(--border-color);
        }
        
        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-medium);
            margin-bottom: 8px;
        }
        
        .form-input {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            background: var(--background-light);
            transition: all 0.2s;
            -webkit-appearance: none;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            background: var(--background-white);
            box-shadow: 0 0 0 3px rgba(0,123,255,0.15);
        }
        
        /* 5. Desktop Styles */
        @media (min-width: 768px) {
            .app-container {
                max-width: 768px;
                margin: 0 auto;
                box-shadow: 0 0 20px rgba(0,0,0,0.1);
            }
            
            .app-content {
                padding: 24px;
            }
            
            .app-header h1 {
                font-size: 24px;
            }
        }
    </style>
    {% block styles %}{% endblock %}
</head>
<body>
    <div class="app-container">
        {% block app_content %}{% endblock %}
    </div>
    
    {% block scripts %}{% endblock %}
    
    <script>
// Dumb scanner polling (for DS2800 and ESP32 dumb mode) - Global across all pages
let lastScanTimestamp = null;
let scanPollInterval = null;
let processedScans = new Set(); // Track scans we've already shown notifications for
let scanNotificationShown = false; // Track if we've shown a notification on this page load

function startScanPolling() {
    // Poll every 2 seconds for new scans
    scanPollInterval = setInterval(pollForScans, 2000);
    // Also poll immediately
    pollForScans();
}

function stopScanPolling() {
    if (scanPollInterval) {
        clearInterval(scanPollInterval);
        scanPollInterval = null;
    }
}

function pollForScans() {
    fetch('/api/scanner/recent-scans?since=5&max=10')
        .then(res => res.json())
        .then(data => {
            if (data.success && data.scans && data.scans.length > 0) {
                // Process new scans (only ones we haven't seen)
                data.scans.forEach(scan => {
                    const scanTime = new Date(scan.timestamp);
                    const scanKey = `${scan.timestamp}-${scan.scanned_data}`;
                    
                    // Skip if we've already processed this scan
                    if (processedScans.has(scanKey)) {
                        return;
                    }
                    
                    // Skip if we're already on the item page for this scan (prevents duplicate dialogs)
                    if (scan.item_found && scan.item_guid) {
                        const currentPath = window.location.pathname;
                        if (currentPath === `/item/${scan.item_guid}`) {
                            processedScans.add(scanKey);
                            return;
                        }
                    }
                    
                    // Skip if we're on a new item page (association banner will handle it)
                    const urlParams = new URLSearchParams(window.location.search);
                    if (urlParams.has('new_item') || urlParams.has('edit_title')) {
                        // We're on a new item page, don't show duplicate notification
                        processedScans.add(scanKey);
                        return;
                    }
                    
                    // Skip if we've already shown a notification for this scan on this page
                    if (processedScans.has(scanKey)) {
                        return;
                    }
                    
                    if (!lastScanTimestamp || scanTime > lastScanTimestamp) {
                        handleScanNotification(scan);
                        lastScanTimestamp = scanTime;
                        processedScans.add(scanKey);
                        scanNotificationShown = true;
                    }
                });
            }
        })
        .catch(err => {
            console.error('Error polling for scans:', err);
        });
}

function handleScanNotification(scan) {
    console.log('New scan received:', scan);
    
    // Request browser notification permission if not already granted
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
    }
    
    // Show browser notification
    if ('Notification' in window && Notification.permission === 'granted') {
        let notificationText = `Scanner: ${scan.scanned_data}`;
        if (scan.item_found) {
            notificationText = `Found: ${scan.item_name || scan.item_guid}`;
        } else if (scan.is_valid_guid) {
            notificationText = `New QR code: ${scan.scanned_data}`;
        }
        
        const notification = new Notification('ThingDB Scanner', {
            body: notificationText,
            icon: '/static/favicon.svg',
            tag: `scan-${scan.timestamp}` // Prevent duplicate notifications
        });
        
        // Click notification to navigate to item or handle scan
        notification.onclick = function() {
            window.focus();
            if (scan.item_found && scan.item_guid) {
                window.location.href = `/item/${scan.item_guid}`;
            } else if (scan.is_valid_guid) {
                // Use process-guid POST endpoint to create item if it doesn't exist
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/process-guid';
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'guid';
                input.value = scan.extracted_guid;
                form.appendChild(input);
                document.body.appendChild(form);
                form.submit();
            }
            notification.close();
        };
    }
    
    // Also show in-page notification/modal
    showScanNotification(scan);
}

function showScanNotification(scan) {
    let title = 'üì∑ Scanner Detected';
    let message = `Scanned: ${scan.scanned_data}`;
    let icon = 'üì∑';
    let action = null;
    
    if (scan.item_found) {
        // Existing item - show notification and navigate
        title = '‚úÖ Item Found';
        message = `${scan.item_name || 'Unnamed Item'}\nGUID: ${scan.item_guid}`;
        icon = '‚úÖ';
        action = {
            text: 'View Item',
            url: `/item/${scan.item_guid}`
        };
    } else if (scan.is_valid_guid) {
        // New GUID - automatically navigate to process-guid
        // This will show the association banner, so we don't need a dialog here
        // Just navigate directly to avoid double prompts
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/process-guid';
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'guid';
        input.value = scan.extracted_guid;
        form.appendChild(input);
        document.body.appendChild(form);
        form.submit();
        return; // Don't show dialog, just navigate
    } else {
        // Invalid format - show alert
        title = '‚ö†Ô∏è Invalid Scan';
        message = `Scanned data is not a valid GUID format: ${scan.scanned_data}`;
        icon = '‚ö†Ô∏è';
    }
    
    // Show notification with action button (only for existing items or invalid scans)
    if (action) {
        if (confirm(`${icon} ${title}\n\n${message}\n\nWould you like to ${action.text.toLowerCase()}?`)) {
            window.location.href = action.url;
        }
    } else if (!scan.is_valid_guid) {
        // Only show alert for invalid scans (valid new GUIDs navigate automatically)
        alert(`${icon} ${title}\n\n${message}`);
    }
}

// Start polling when page loads (works on all pages)
document.addEventListener('DOMContentLoaded', function() {
    // Reset processed scans when page loads (but keep tracking to prevent duplicates within same page)
    // Don't reset processedScans - we want to prevent showing the same scan twice even after navigation
    
    startScanPolling();
    
    // Stop polling when page is hidden (save resources)
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            stopScanPolling();
        } else {
            startScanPolling();
        }
    });
    
    // Clear processed scans when navigating away (but only after a delay to prevent immediate re-show)
    window.addEventListener('beforeunload', function() {
        // Keep processedScans for a bit to prevent showing same scan on new page
        // They'll naturally expire as new scans come in
    });
});
    </script>
</body>
</html>
