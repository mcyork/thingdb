{% extends "base.html" %}

{% block title %}{{ item_data.item[1] or ('Item_' + guid[:8]) }}{% endblock %}

{% block styles %}
<style>
    /* Make app content scrollable, with padding for the fixed action bar */
    .app-content {
        padding-bottom: calc(80px + env(safe-area-inset-bottom));
    }

    /* Header Editing */
    .header-edit-name-form { display: flex; align-items: center; gap: 8px; flex: 1; }
    .header-edit-name-input {
        flex: 1; padding: 6px 12px; border: 1px solid rgba(255,255,255,0.3);
        border-radius: 6px; font-size: 18px; font-weight: 600;
        background: rgba(255,255,255,0.9); color: #333;
    }
    .header-edit-btn {
        background: rgba(255,255,255,0.2); border: none; border-radius: 6px;
        padding: 6px 10px; cursor: pointer; font-size: 14px; color: white;
    }

    /* Breadcrumbs */
    .breadcrumb-nav {
        display: flex; align-items: center; gap: 8px; font-size: 14px;
        padding: 12px 16px; background: var(--background-light);
        border-bottom: 1px solid var(--border-color);
        overflow-x: auto; white-space: nowrap;
    }
    .breadcrumb-item { color: var(--primary-color); text-decoration: none; }
    .breadcrumb-separator { color: var(--text-light); }
    .breadcrumb-current { color: var(--text-dark); font-weight: 600; }

    /* Image Gallery */
    .image-gallery {
        display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 8px; padding: 16px;
    }
    .image-item {
        position: relative; aspect-ratio: 1; border-radius: 8px;
        overflow: hidden; background: var(--background-light);
    }
    .image-item img { width: 100%; height: 100%; object-fit: cover; }
    .image-controls {
        position: absolute; bottom: 0; left: 0; right: 0;
        background: rgba(0,0,0,0.6); padding: 4px;
        display: none; justify-content: center; gap: 4px;
    }
    .image-gallery.controls-visible .image-controls { display: flex; }
    .image-control-btn {
        background: white; border: none; border-radius: 50%;
        width: 28px; height: 28px; display: flex; align-items: center;
        justify-content: center; cursor: pointer;
    }
    .primary-radio { cursor: pointer; }

    /* Content Sections */
    .content-card {
        padding: 16px;
        border-bottom: 1px solid var(--border-color);
    }
    .content-card:last-child { border-bottom: none; }
    .section-header {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 12px;
    }
    .section-title {
        font-size: 14px; font-weight: 600; color: var(--text-light);
        text-transform: uppercase; letter-spacing: 0.5px;
    }
    .content-text { line-height: 1.6; }
    .empty-content { color: var(--text-light); font-style: italic; }

    /* Tags */
    .tags-list { display: flex; flex-wrap: wrap; gap: 8px; }
    .tag {
        background: var(--primary-color); color: white; padding: 6px 12px;
        border-radius: 16px; font-size: 13px; font-weight: 500;
        display: flex; align-items: center; gap: 6px;
    }
    .tag-delete {
        background: rgba(255,255,255,0.3); border: none; color: white;
        border-radius: 50%; width: 18px; height: 18px; font-size: 12px;
        cursor: pointer; display: flex; align-items: center; justify-content: center;
    }

    /* Action Bar */
    .action-bar {
        position: fixed; bottom: 0; left: 0; right: 0;
        background: var(--background-white);
        border-top: 1px solid var(--border-color);
        padding: 12px 16px;
        padding-bottom: calc(12px + env(safe-area-inset-bottom));
        display: flex; gap: 12px; z-index: 1000;
    }
    .action-bar .btn { flex: 1; }

    /* Button Styles */
    .btn {
        padding: 8px 16px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
        display: inline-block;
        text-align: center;
    }
    .btn-secondary {
        background: var(--background-white);
        color: var(--text-dark);
        border-color: var(--border-color);
    }
    .btn-secondary:hover {
        background: var(--background-light);
        border-color: var(--primary-color);
        color: var(--primary-color);
    }
    .btn-primary {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }
    .btn-primary:hover {
        background: var(--primary-hover);
        border-color: var(--primary-hover);
    }
    .btn-danger {
        background: var(--danger-color);
        color: white;
        border-color: var(--danger-color);
    }
    .btn-danger:hover {
        background: #c82333;
        border-color: #bd2130;
    }
    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .btn.active {
        background: #6c757d;
        color: white;
        border-color: #6c757d;
    }

    /* Image Modal */
    .image-modal {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.9); z-index: 2000; display: none;
        align-items: center; justify-content: center;
    }
    .image-modal.active { display: flex; }
    .image-modal-content {
        position: relative; max-width: 90%; max-height: 90%;
        display: flex; align-items: center; justify-content: center;
    }
    .image-modal-close {
        position: absolute; top: -40px; right: 0;
        background: rgba(255,255,255,0.2); border: none;
        color: white; font-size: 24px; width: 40px; height: 40px;
        border-radius: 50%; cursor: pointer; z-index: 2001;
    }
    .image-modal-close:hover { background: rgba(255,255,255,0.3); }
    #modal-image {
        max-width: 100%; max-height: 100%; object-fit: contain;
        border-radius: 8px;
    }

    /* Upload Area */
    .upload-area {
        border: 2px dashed var(--border-color);
        border-radius: 8px;
        padding: 40px 20px;
        text-align: center;
        background: var(--background-light);
        transition: all 0.3s ease;
        cursor: pointer;
    }
    .upload-area:hover {
        border-color: var(--primary-color);
        background: rgba(0, 123, 255, 0.05);
    }
    .upload-area.dragover {
        border-color: var(--primary-color);
        background: rgba(0, 123, 255, 0.1);
        transform: scale(1.02);
    }
    .upload-content {
        pointer-events: none;
    }
    .upload-icon {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.6;
    }
    .upload-text {
        font-size: 16px;
        color: var(--text-dark);
        margin-bottom: 8px;
    }
    .upload-link {
        color: var(--primary-color);
        text-decoration: underline;
        cursor: pointer;
    }
    .upload-subtext {
        font-size: 14px;
        color: var(--text-light);
        margin: 0;
    }
    .upload-progress {
        margin-top: 16px;
    }
    .progress-bar {
        width: 100%;
        height: 8px;
        background: var(--border-color);
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 8px;
    }
    .progress-fill {
        height: 100%;
        background: var(--primary-color);
        width: 0%;
        transition: width 0.3s ease;
    }
    .progress-text {
        font-size: 14px;
        color: var(--text-medium);
        margin: 0;
        text-align: center;
    }

    /* Contained Items */
    .contained-items-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    .contained-item {
        display: flex;
        align-items: center;
        padding: 12px;
        background: var(--background-light);
        border-radius: 8px;
        text-decoration: none;
        color: var(--text-dark);
        transition: all 0.2s ease;
        border: 1px solid var(--border-color);
    }
    .contained-item:hover {
        background: var(--primary-color);
        color: white;
        transform: translateX(4px);
        box-shadow: 0 2px 8px rgba(0,123,255,0.3);
    }
    .contained-item-thumbnail {
        width: 48px;
        height: 48px;
        object-fit: cover;
        border-radius: 6px;
        background: var(--border-color);
        margin-right: 12px;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .contained-item-placeholder {
        font-size: 20px;
        color: var(--text-light);
    }
    .contained-item-info {
        flex: 1;
        min-width: 0;
    }
    .contained-item-name {
        font-weight: 600;
        margin-bottom: 4px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    .contained-item-meta {
        font-size: 12px;
        opacity: 0.8;
    }

    /* New Item Overlay and Highlight */
    .new-item-overlay {
        position: fixed;
        top: 60px; /* Start below the header */
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.3);
        z-index: 1500;
        pointer-events: auto;
    }
    /* Association Banner Overlay - greys out page while banner is shown */
    .association-overlay {
        position: fixed;
        top: 60px; /* Start below the header */
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.3);
        z-index: 1499; /* Below banner (1500) but above content */
        pointer-events: auto;
    }
    .new-item-highlight {
        background: #fff3cd !important;
        border: 2px solid #ffc107 !important;
        box-shadow: 0 0 0 4px rgba(255,193,7,0.3) !important;
        animation: new-item-pulse 1s ease-in-out;
    }
    @keyframes new-item-pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.02); }
    }

    /* Autocomplete Styles */
    .autocomplete-wrapper {
        position: relative;
        flex: 1;
    }
    .autocomplete-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-radius: 6px;
        margin-top: 4px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .autocomplete-dropdown.show {
        display: block;
    }
    .autocomplete-item {
        display: flex;
        align-items: center;
        padding: 12px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        transition: background-color 0.2s;
    }
    .autocomplete-item:last-child {
        border-bottom: none;
    }
    .autocomplete-item:hover,
    .autocomplete-item.selected {
        background-color: #f8f9fa;
    }
    .autocomplete-item-thumbnail {
        width: 36px;
        height: 36px;
        object-fit: cover;
        border-radius: 4px;
        background: #e9ecef;
        flex-shrink: 0;
        margin-right: 12px;
    }
    .autocomplete-item-info {
        flex: 1;
        min-width: 0;
    }
    .autocomplete-item-name {
        font-weight: 500;
        color: #333;
        margin-bottom: 2px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    .autocomplete-item-meta {
        font-size: 12px;
        color: #666;
    }
    .autocomplete-no-results {
        padding: 12px;
        text-align: center;
        color: #999;
        font-style: italic;
    }
</style>
{% endblock %}

{% block app_content %}

{% if show_association %}
<!-- QR Code Association Banner -->
<div class="association-banner" id="association-banner">
    <div class="association-banner-content">
        <div class="association-banner-icon">üîó</div>
        <div class="association-banner-text">
            <h3>New QR code scanned</h3>
            <p>This QR code hasn't been seen before. What would you like to do?</p>
        </div>
    </div>
    <div class="association-banner-actions">
        <button onclick="dismissAssociation()" class="btn btn-primary" style="font-size: 16px; padding: 12px 20px;">
            Create new item
        </button>
        <button onclick="showAssociationSearch()" class="btn btn-secondary" style="font-size: 14px; padding: 10px 16px;">
            Add to existing item
        </button>
        <button onclick="cancelAndDelete()" class="btn btn-danger" style="font-size: 14px; padding: 10px 16px;">
            Cancel
        </button>
    </div>
    
    <!-- Association Search (hidden by default) -->
    <div class="association-search" id="association-search" style="display: none;">
        <div class="association-search-header">
            <h4>Search for the existing item:</h4>
        </div>
        <div class="association-autocomplete-wrapper">
            <input type="text" 
                   id="association-search-input" 
                   class="form-input" 
                   placeholder="Type item name to search..." 
                   autocomplete="off"
                   style="font-size: 16px; padding: 14px;">
            <div id="association-autocomplete-dropdown" class="autocomplete-dropdown"></div>
        </div>
        <button onclick="cancelAssociation()" class="btn btn-secondary" style="margin-top: 12px; width: 100%;">
            Back
        </button>
    </div>
</div>

<style>
.association-banner {
    background: #e3f2fd;
    border: 1px solid #1976d2;
    border-radius: 12px;
    margin: 16px;
    padding: 20px;
    animation: slideDown 0.3s ease-out;
    position: relative;
    z-index: 1500; /* Above overlay so banner is clickable */
}

@keyframes slideDown {
    from {
        transform: translateY(-20px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.association-banner-content {
    display: flex;
    align-items: flex-start;
    gap: 16px;
    margin-bottom: 20px;
}

.association-banner-icon {
    font-size: 32px;
    line-height: 1;
}

.association-banner-text h3 {
    margin: 0 0 8px 0;
    font-size: 18px;
    color: #1565c0;
}

.association-banner-text p {
    margin: 0;
    color: #555;
    font-size: 14px;
}

.association-banner-actions {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}

.association-search {
    margin-top: 20px;
}

.association-search-header h4 {
    margin: 0 0 12px 0;
    font-size: 16px;
    color: #1565c0;
}

.association-autocomplete-wrapper {
    position: relative;
}

.association-autocomplete-wrapper .autocomplete-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    margin-top: 4px;
    max-height: 300px;
    overflow-y: auto;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 1000;
    display: none;
}

.association-autocomplete-wrapper .autocomplete-dropdown.show {
    display: block;
}

.autocomplete-item {
    padding: 12px;
    cursor: pointer;
    border-bottom: 1px solid #f0f0f0;
    display: flex;
    align-items: center;
    gap: 12px;
}

.autocomplete-item:last-child {
    border-bottom: none;
}

.autocomplete-item:hover {
    background: #f8f9fa;
}

.autocomplete-item-thumbnail {
    width: 48px;
    height: 48px;
    object-fit: cover;
    border-radius: 6px;
    background: #e9ecef;
}

.autocomplete-item-info {
    flex: 1;
}

.autocomplete-item-name {
    font-weight: 600;
    font-size: 14px;
    margin-bottom: 4px;
}

.autocomplete-item-meta {
    font-size: 12px;
    color: #666;
}

.autocomplete-loading {
    padding: 16px;
    text-align: center;
    color: #666;
}
</style>
{% endif %}

<!-- Using sub-header from base.html for consistency -->
<div class="sub-header">
    <div class="sub-header-content">
        <button onclick="goBack()" class="sub-header-back-btn">‚Üê</button>
        <div id="header-name-display" style="flex: 1;">
            <h1 class="sub-header-title">{{ item_data.item[1] or ('Item_' + guid[:8]) }}</h1>
        </div>
        <form class="header-edit-name-form" id="header-edit-name-form" style="display: none;">
            <input type="text" class="header-edit-name-input" id="header-name-input" value="{{ item_data.item[1] or ('Item_' + guid[:8]) }}">
            <button type="submit" class="header-edit-btn">Save</button>
        </form>
        <button onclick="editHeaderName()" class="header-edit-btn" id="header-edit-btn" title="Edit Name">‚úèÔ∏è</button>
    </div>
</div>

<div class="app-content">
    <!-- Breadcrumb Navigation -->
    {% if item_data.breadcrumb %}
    <div class="breadcrumb-nav">
        <a href="/" class="breadcrumb-item">Home</a>
        {% for ancestor in item_data.breadcrumb %}
            <span class="breadcrumb-separator">‚Ä∫</span>
            <a href="/item/{{ ancestor.guid }}" class="breadcrumb-item">{{ ancestor.name }}</a>
        {% endfor %}
        <span class="breadcrumb-separator">‚Ä∫</span>
        <span class="breadcrumb-current">{{ item_data.item[1] or ('Item_' + guid[:8]) }}</span>
    </div>
    {% endif %}

    <!-- Main Content Card -->
    <div class="card" style="border-radius: 0;">
        <!-- Image Gallery -->
        <div class="content-card">
            <div class="section-header">
                <h2 class="section-title">Photos ({{ images|length }})</h2>
                <button onclick="toggleControls()" class="btn btn-secondary" id="controls-toggle" style="padding: 4px 8px; font-size: 12px; background: #ffffff; color: #333; border: 1px solid #ccc; border-radius: 4px;" {% if not images %}disabled{% endif %}>
                    Edit
                </button>
            </div>
            {% if images %}
            <div class="image-gallery" id="image-gallery">
                {% for image in images %}
                <div class="image-item">
                    <a href="#" onclick="showImageModal({{ image[0] }})"><img src="/thumbnail/{{ image[0] }}" loading="lazy"></a>
                    <div class="image-controls">
                        <input type="radio" name="primary-image" value="{{ image[0] }}" class="primary-radio"
                               {% if image[4] %}checked{% endif %} onchange="setPrimaryImage({{ image[0] }})" title="Set as primary">
                        <button onclick="rotateImage({{ image[0] }})" class="image-control-btn" title="Rotate">‚Üª</button>
                        <button onclick="deleteImage({{ image[0] }})" class="image-control-btn" title="Delete">√ó</button>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="empty-content">No photos yet. Add one below.</p>
            {% endif %}
        </div>

        <!-- Description -->
        <div class="content-card">
            <div class="section-header">
                <h2 class="section-title">Description</h2>
                <button onclick="editDescription()" class="btn btn-secondary" id="edit-description-btn" style="padding: 4px 8px; font-size: 12px;">Edit</button>
            </div>
            <div class="content-text" id="description-display">
                {% if item_data.item[2] %}{{ item_data.item[2]|urlize_safe }}{% else %}<p class="empty-content">No description.</p>{% endif %}
            </div>
            <form id="edit-description-form" style="display: none;">
                <textarea class="form-input" id="description-input" rows="4">{{ item_data.item[2] or '' }}</textarea>
                <div style="display: flex; gap: 8px; margin-top: 8px;">
                    <button type="submit" class="btn btn-primary">Save</button>
                    <button type="button" onclick="cancelEditDescription()" class="btn btn-secondary">Cancel</button>
                </div>
            </form>
        </div>

        <!-- Item Number -->
        <div class="content-card">
            <div class="section-header">
                <h2 class="section-title">Item Number</h2>
                <button onclick="editItemNumber()" class="btn btn-secondary" id="edit-number-btn" style="padding: 4px 8px; font-size: 12px;">Edit</button>
            </div>
            <div class="content-text" id="number-display">
                {% if item_data.item[6] %}
                    <span style="font-size: 18px; font-weight: 600; color: var(--primary-color);">#{{ item_data.item[6] }}</span>
                {% else %}
                    <p class="empty-content">No item number assigned.</p>
                {% endif %}
            </div>
            <form id="edit-number-form" style="display: none;">
                <input type="number" class="form-input" id="number-input" value="{{ item_data.item[6] or '' }}" placeholder="Enter item number..." min="1">
                <div style="display: flex; gap: 8px; margin-top: 8px;">
                    <button type="submit" class="btn btn-primary">Save</button>
                    <button type="button" onclick="cancelEditNumber()" class="btn btn-secondary">Cancel</button>
                </div>
            </form>
        </div>

        <!-- Tags -->
        <div class="content-card">
            <h2 class="section-title">Tags</h2>
            <div class="tags-list">
                {% for category in categories %}
                <span class="tag" id="tag-{{ category[0] }}">
                    <span>{{ category[1] }}</span>
                    <button class="tag-delete" onclick="deleteTag({{ category[0] }})">√ó</button>
                </span>
                {% endfor %}
            </div>
            <form method="POST" action="/add-category/{{ guid }}" style="margin-top: 12px;">
                <input type="text" name="category_name" class="form-input" placeholder="Add a new tag..." required>
            </form>
        </div>

        <!-- Add Photo -->
        <div class="content-card">
            <h2 class="section-title">Add Photo</h2>
            <div class="upload-area" id="upload-area">
                <div class="upload-content">
                    <div class="upload-icon">üì∑</div>
                    <p class="upload-text">Drag & drop photos here, or <span class="upload-link">click to choose</span></p>
                    <p class="upload-subtext">Supports JPG, PNG, GIF</p>
                </div>
                <form method="POST" action="/upload-image/{{ guid }}" enctype="multipart/form-data" id="upload-form">
                    <input type="file" name="image" id="file-input" accept="image/*" multiple style="display: none;">
                </form>
            </div>
            <div class="upload-progress" id="upload-progress" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <p class="progress-text" id="progress-text">Uploading...</p>
            </div>
        </div>
    </div>

    <!-- Contained Items Section -->
    {% if item_data.contained_items %}
    <div class="content-card">
        <h2 class="section-title">Items Contained in This Item ({{ item_data.contained_items|length }})</h2>
        <div class="contained-items-list">
            {% for contained_item in item_data.contained_items %}
            <a href="/item/{{ contained_item[0] }}" class="contained-item">
                {% if contained_item[4] %}
                <img src="/thumbnail/{{ contained_item[4] }}" alt="{{ contained_item[1] }}" class="contained-item-thumbnail">
                {% else %}
                <div class="contained-item-thumbnail">
                    <div class="contained-item-placeholder">üì¶</div>
                </div>
                {% endif %}
                <div class="contained-item-info">
                    <div class="contained-item-name">{{ contained_item[1] }}</div>
                    <div class="contained-item-meta">
                        {{ contained_item[3] }} photo{{ 's' if contained_item[3] != 1 else '' }} ‚Ä¢ 
                        Added {{ contained_item[2].strftime('%b %d, %Y') }}
                    </div>
                </div>
            </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Move Item Section -->
    <div class="content-card">
        <h2 class="section-title">Move Item</h2>
        <div id="move-item-section">
            {% if item_data.parent_item %}
            <p style="margin-bottom: 12px; color: #666;">Currently inside: <strong>{{ item_data.parent_item[1] }}</strong></p>
            <button onclick="removeFromContainer()" class="btn btn-secondary" style="margin-bottom: 12px;">Remove from Container</button>
            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #eee;">
                <p style="margin-bottom: 8px; color: #666;">Or move to a different container:</p>
            </div>
            {% endif %}
            
            <form id="move-item-form" style="display: flex; gap: 8px; align-items: flex-end;">
                <div class="autocomplete-wrapper">
                    <input type="text" id="parent-search-input" class="form-input" placeholder="Type to find item to move this into" style="width: 100%;" autocomplete="off">
                    <input type="hidden" id="parent-guid-input" name="parent_guid">
                    <div id="autocomplete-dropdown" class="autocomplete-dropdown"></div>
                </div>
                <button type="submit" class="btn btn-primary" id="move-item-btn" disabled>Move Item</button>
            </form>
            <p style="margin-top: 8px; font-size: 12px; color: #999;">Start typing to search for items by name. Select the container you want to move this item into.</p>
        </div>
    </div>
    
    <!-- QR Code Label (Collapsible) -->
    <div class="content-card">
        <div class="collapsible-header" onclick="toggleQRSection()" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <h2 class="section-title" style="margin: 0;">QR Code & Labels</h2>
            <span id="qr-toggle-icon" style="font-size: 20px; transition: transform 0.3s; color: var(--text-light);">‚ñº</span>
        </div>
        <div id="qr-section-content" style="display: none; overflow: hidden;">
            <p style="font-size: 13px; color: var(--text-light); margin-bottom: 12px;">
                Scan this code to quickly access this item from your phone.
            </p>
            <div style="text-align: center; padding: 20px; background: var(--background-light); border-radius: 8px;">
                <img src="/api/item/{{ guid }}/qr-code.png" 
                     alt="QR Code for {{ item_data.item[1] or guid[:8] }}" 
                     style="max-width: 200px; width: 100%; height: auto; border: 1px solid var(--border-color); border-radius: 4px; background: white; padding: 8px;">
                <div style="margin-top: 8px; font-size: 12px; color: var(--text-light);">
                    {{ guid_display }} {% if item_data.item[1] %}{{ item_data.item[1] }}{% else %}Item # ______{% endif %}
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px;">
                <button onclick="downloadQRCode('png')" class="btn btn-secondary" id="download-png-btn">
                    üì• Download PNG
                </button>
                <button onclick="downloadQRCode('pdf')" class="btn btn-secondary" id="download-pdf-btn">
                    üìÑ Download PDF
                </button>
            </div>
            <div style="margin-top: 8px;">
                <button onclick="downloadFullLabel()" class="btn btn-primary btn-block" id="download-label-btn">
                    üìã Download Full Item Label
                </button>
                <p style="font-size: 11px; color: var(--text-light); margin-top: 4px; text-align: center;">
                    Half-page label with photo, description, location, and QR code
                </p>
            </div>
            
            {% if item_data.contained_items and item_data.contained_items|length > 0 %}
            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);">
                <p style="font-size: 13px; color: var(--text-light); margin-bottom: 8px;">
                    This container has <strong>{{ item_data.contained_items|length }}</strong> direct item{{ 's' if item_data.contained_items|length != 1 else '' }} inside.
                </p>
                
                <div style="margin-bottom: 12px;">
                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer;">
                        <input type="checkbox" id="include-nested-checkbox" onchange="updateContainerQRCount()" style="cursor: pointer;">
                        <span>Include all nested items (children, grandchildren, etc.)</span>
                    </label>
                </div>
                
                <button onclick="downloadContainerQRSheet()" class="btn btn-primary btn-block" id="container-qr-btn">
                    üì¶ <span id="container-qr-text">Print Container QR Codes ({{ item_data.contained_items|length + 1 }} codes)</span>
                </button>
                <p style="font-size: 11px; color: var(--text-light); margin-top: 6px;" id="container-qr-info">
                    <span id="page-count">{{ ((item_data.contained_items|length + 1) / 24)|round(0, 'ceil')|int }}</span>-page PDF with this item + direct children
                </p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Fixed Action Bar -->
<div class="action-bar">
    <button onclick="deleteItem('{{ guid }}')" class="btn btn-danger">Delete Item</button>
</div>

<!-- Image Modal -->
<div id="image-modal" class="image-modal">
    <div class="image-modal-content">
        <button onclick="closeImageModal()" class="image-modal-close">√ó</button>
        <img id="modal-image" src="" alt="Full size image">
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// --- All JavaScript from the original file is preserved here ---
// This includes image controls, editing, deletion, moving, etc.
// Minor adjustments may be made to accommodate new class names if necessary.

function toggleControls() {
    const gallery = document.getElementById('image-gallery');
    const toggleBtn = document.getElementById('controls-toggle');
    
    if (gallery.classList.contains('controls-visible')) {
        // Hide controls
        gallery.classList.remove('controls-visible');
        toggleBtn.textContent = 'Edit';
        toggleBtn.classList.remove('active');
    } else {
        // Show controls
        gallery.classList.add('controls-visible');
        toggleBtn.textContent = 'Done';
        toggleBtn.classList.add('active');
    }
}

function showImageModal(imageId) {
    const modal = document.getElementById('image-modal');
    const modalImg = document.getElementById('modal-image');
    modalImg.src = `/image/${imageId}`;
    modal.classList.add('active');
}

function closeImageModal() {
    document.getElementById('image-modal').classList.remove('active');
}

function deleteImage(imageId) {
    if (!confirm('Delete this image?')) return;
    fetch(`/delete-image/${imageId}`, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            if (data.success) window.location.reload();
            else alert('Delete failed: ' + data.error);
        });
}

function deleteItem(guid) {
    if (!confirm('Delete this entire item and all its images? This cannot be undone.')) return;
    fetch(`/delete-item/${guid}`, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            if (data.success) window.location.href = '/';
            else alert('Delete failed: ' + data.error);
        });
}

function rotateImage(imageId) {
    // Prevent double-clicks and event propagation
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    // Show loading state
    const btn = event.target;
    
    // Check if already processing
    if (btn.disabled) {
        return;
    }
    
    btn.textContent = '...';
    btn.disabled = true;
    
    fetch(`/rotate-image/${imageId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update the thumbnail without reloading the page
            const imgElement = btn.closest('.image-item').querySelector('img');
            if (imgElement) {
                // Force reload the thumbnail by adding a timestamp
                const thumbnailUrl = imgElement.src.split('?')[0];
                imgElement.src = thumbnailUrl + '?t=' + Date.now();
            }
            btn.textContent = '‚Üª';
            btn.disabled = false;
        } else {
            alert('Rotation failed: ' + (data.error || 'Unknown error'));
            btn.textContent = '‚Üª';
            btn.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Rotation failed. Please try again.');
        btn.textContent = '‚Üª';
        btn.disabled = false;
    });
}

function setPrimaryImage(imageId) {
    fetch(`/set-primary-image/${imageId}`, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            if (!data.success) alert('Failed to set primary image: ' + data.error);
        });
}

function editHeaderName() {
    document.getElementById('header-name-display').style.display = 'none';
    document.getElementById('header-edit-name-form').style.display = 'flex';
    document.getElementById('header-edit-btn').style.display = 'none';
    document.getElementById('header-name-input').focus();
}


// Save title function (used by both form submit and Enter key)
function saveItemName() {
    const newName = document.getElementById('header-name-input').value.trim();
    if (!newName) {
        alert('Item name cannot be empty');
        return;
    }
    
    fetch(`/update-item-name/{{ guid }}`, {
        method: 'POST',
        body: new URLSearchParams({ 'item_name': newName })
    }).then(res => res.json()).then(data => {
        if (data.success) {
            // Remove overlay if it exists (for new item creation)
            const overlay = document.getElementById('new-item-overlay');
            if (overlay) {
                overlay.remove();
            }
            // Remove both edit_title and new_item parameters from URL and reload
            const url = new URL(window.location);
            url.searchParams.delete('edit_title');
            url.searchParams.delete('new_item');
            window.location.href = url.toString();
        } else {
            alert('Update failed: ' + data.error);
        }
    }).catch(error => {
        console.error('Error saving item name:', error);
        alert('Failed to save item name. Please try again.');
    });
}

document.getElementById('header-edit-name-form').addEventListener('submit', function(e) {
    e.preventDefault();
    saveItemName();
});

// Also handle Enter key in the title input field
document.getElementById('header-name-input').addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        saveItemName();
    }
});

function editDescription() {
    document.getElementById('description-display').style.display = 'none';
    document.getElementById('edit-description-form').style.display = 'block';
    document.getElementById('edit-description-btn').style.display = 'none';
}

function cancelEditDescription() {
    document.getElementById('description-display').style.display = 'block';
    document.getElementById('edit-description-form').style.display = 'none';
    document.getElementById('edit-description-btn').style.display = 'block';
}

function editItemNumber() {
    document.getElementById('number-display').style.display = 'none';
    document.getElementById('edit-number-form').style.display = 'block';
    document.getElementById('edit-number-btn').style.display = 'none';
}

function cancelEditNumber() {
    document.getElementById('number-display').style.display = 'block';
    document.getElementById('edit-number-form').style.display = 'none';
    document.getElementById('edit-number-btn').style.display = 'block';
}

document.getElementById('edit-description-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const newDesc = document.getElementById('description-input').value;
    fetch(`/update-item-description/{{ guid }}`, {
        method: 'POST',
        body: new URLSearchParams({ 'description': newDesc })
    }).then(res => res.json()).then(data => {
        if (data.success) window.location.reload();
        else alert('Update failed: ' + data.error);
    });
});

document.getElementById('edit-number-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const newNumber = document.getElementById('number-input').value;
    fetch(`/update-item-label/{{ guid }}`, {
        method: 'POST',
        body: new URLSearchParams({ 'label_number': newNumber })
    }).then(res => res.json()).then(data => {
        if (data.success) window.location.reload();
        else alert('Update failed: ' + data.error);
    });
});

function deleteTag(categoryId) {
    fetch(`/remove-category/${categoryId}`, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            if (data.success) document.getElementById(`tag-${categoryId}`).remove();
            else alert('Delete failed: ' + data.error);
        });
}

// Move item functions
function removeFromContainer() {
    if (!confirm('Remove this item from its current container?')) {
        return;
    }
    
    fetch(`/set-parent/{{ guid }}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ parent_guid: '' }) // Empty parent_guid removes the parent relationship
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Failed to remove from container: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to remove from container. Please try again.');
    });
}

// Autocomplete functionality
let autocompleteTimeout;
let selectedIndex = -1;
let autocompleteResults = [];

const searchInput = document.getElementById('parent-search-input');
const guidInput = document.getElementById('parent-guid-input');
const dropdown = document.getElementById('autocomplete-dropdown');
const moveBtn = document.getElementById('move-item-btn');

function showAutocomplete() {
    dropdown.classList.add('show');
}

function hideAutocomplete() {
    dropdown.classList.remove('show');
    selectedIndex = -1;
}

function renderAutocompleteResults(results) {
    if (results.length === 0) {
        dropdown.innerHTML = '<div class="autocomplete-no-results">No items found</div>';
        showAutocomplete();
        return;
    }
    
    dropdown.innerHTML = results.map((item, index) => `
        <div class="autocomplete-item ${index === selectedIndex ? 'selected' : ''}" 
             data-guid="${item.guid}" 
             data-name="${item.name}"
             data-index="${index}">
            ${item.has_image ? 
                `<img src="/thumbnail/${item.image_id}" alt="${item.name}" class="autocomplete-item-thumbnail">` :
                `<div class="autocomplete-item-thumbnail" style="display: flex; align-items: center; justify-content: center; font-size: 16px; color: #adb5bd;">üì¶</div>`
            }
            <div class="autocomplete-item-info">
                <div class="autocomplete-item-name">${item.name}</div>
                <div class="autocomplete-item-meta">
                    ${item.contained_count > 0 ? `Contains ${item.contained_count} item${item.contained_count !== 1 ? 's' : ''}` : 'Empty container'}
                    ${item.matched_tags ? ` ‚Ä¢ Tags: ${item.matched_tags}` : ''}
                </div>
            </div>
        </div>
    `).join('');
    
    showAutocomplete();
    
    // Add click handlers
    dropdown.querySelectorAll('.autocomplete-item').forEach(item => {
        item.addEventListener('click', function() {
            selectAutocompleteItem(this.dataset.guid, this.dataset.name);
        });
    });
}

function selectAutocompleteItem(guid, name) {
    searchInput.value = name;
    guidInput.value = guid;
    moveBtn.disabled = false;
    hideAutocomplete();
}

// Search input event listeners
if (searchInput) {
    searchInput.addEventListener('input', function() {
        const query = this.value.trim();
        
        if (query.length < 2) {
            hideAutocomplete();
            moveBtn.disabled = true;
            return;
        }
        
        clearTimeout(autocompleteTimeout);
        autocompleteTimeout = setTimeout(() => {
            fetch(`/api/semantic-search?q=${encodeURIComponent(query)}&exclude={{ guid }}&limit=15`)
                .then(response => response.json())
                .then(data => {
                    // Semantic search API returns array directly, not wrapped in success object
                    autocompleteResults = data;
                    renderAutocompleteResults(autocompleteResults);
                })
                .catch(error => {
                    console.error('Search error:', error);
                    hideAutocomplete();
                });
        }, 300);
    });

    searchInput.addEventListener('keydown', function(e) {
        if (!dropdown.classList.contains('show')) return;
        
        switch(e.key) {
            case 'ArrowDown':
                e.preventDefault();
                selectedIndex = Math.min(selectedIndex + 1, autocompleteResults.length - 1);
                updateSelection();
                break;
            case 'ArrowUp':
                e.preventDefault();
                selectedIndex = Math.max(selectedIndex - 1, -1);
                updateSelection();
                break;
            case 'Enter':
                e.preventDefault();
                if (selectedIndex >= 0 && autocompleteResults[selectedIndex]) {
                    const item = autocompleteResults[selectedIndex];
                    selectAutocompleteItem(item.guid, item.name);
                }
                break;
            case 'Escape':
                hideAutocomplete();
                break;
        }
    });
}

function updateSelection() {
    const items = dropdown.querySelectorAll('.autocomplete-item');
    items.forEach((item, index) => {
        item.classList.toggle('selected', index === selectedIndex);
    });
}

// Click outside to close
document.addEventListener('click', function(e) {
    if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
        hideAutocomplete();
    }
});

// Handle move item form submission
if (document.getElementById('move-item-form')) {
    document.getElementById('move-item-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const parentGuid = guidInput.value.trim();
        if (!parentGuid) {
            alert('Please select a container from the search results');
            return;
        }
        
        // Check if trying to move item into itself
        if (parentGuid.toLowerCase() === '{{ guid }}'.toLowerCase()) {
            alert('Cannot move an item into itself!');
            return;
        }
        
        // Show loading state
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'Moving...';
        submitBtn.disabled = true;
        
        // Create JSON data
        fetch(`/set-parent/{{ guid }}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ parent_guid: parentGuid })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Failed to move item: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to move item. Please try again.');
        })
        .finally(() => {
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        });
    });
}

// Back button functionality using breadcrumb navigation
function goBack() {
    {% if item_data.breadcrumb and item_data.breadcrumb|length > 0 %}
        // Go to the immediate parent (last item in breadcrumb)
        const parentGuid = '{{ item_data.breadcrumb[-1].guid }}';
        window.location.href = '/item/' + parentGuid;
    {% else %}
        // No parent, go to home
        window.location.href = '/';
    {% endif %}
}

// Function to trigger yellow overlay and forced editing
function triggerNewItemEditMode() {
    // Immediately trigger the edit mode for the title
    editHeaderName();
    
    // A short delay helps ensure the input is visible and ready for focus
    setTimeout(() => {
        const nameInput = document.getElementById('header-name-input');
        if (nameInput) {
            // Add overlay to grey out content
            const overlay = document.createElement('div');
            overlay.className = 'new-item-overlay';
            overlay.id = 'new-item-overlay';
            overlay.onclick = function(e) {
                // Prevent clicking through the overlay
                e.preventDefault();
                e.stopPropagation();
            };
            document.body.appendChild(overlay);
            
            // Add visual highlight to draw attention
            nameInput.classList.add('new-item-highlight');
            nameInput.focus();
            nameInput.select(); // Select the default text for easy replacement
            
            // Remove highlight after animation completes
            setTimeout(() => {
                nameInput.classList.remove('new-item-highlight');
            }, 2000);
        }
    }, 100);
}

// New item forced editing functionality
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('edit_title')) {
        triggerNewItemEditMode();
    }
    
    // Add overlay for association banner if it's shown
    const associationBanner = document.getElementById('association-banner');
    if (associationBanner) {
        const associationOverlay = document.createElement('div');
        associationOverlay.className = 'association-overlay';
        associationOverlay.id = 'association-overlay';
        associationOverlay.onclick = function(e) {
            // Prevent clicking through the overlay, but allow clicks on banner
            // The banner has higher z-index so clicks on it will work
            e.preventDefault();
            e.stopPropagation();
        };
        document.body.appendChild(associationOverlay);
    }
});

// Upload functionality
document.addEventListener('DOMContentLoaded', function() {
    const uploadArea = document.getElementById('upload-area');
    const fileInput = document.getElementById('file-input');
    const uploadForm = document.getElementById('upload-form');
    const uploadProgress = document.getElementById('upload-progress');
    const progressFill = document.getElementById('progress-fill');
    const progressText = document.getElementById('progress-text');

    // Click to upload
    uploadArea.addEventListener('click', () => {
        fileInput.click();
    });

    // File input change
    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            uploadFiles(e.target.files);
        }
    });

    // Drag and drop
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            uploadFiles(files);
        }
    });

    function uploadFiles(files) {
        // Show progress
        uploadProgress.style.display = 'block';
        progressFill.style.width = '0%';
        progressText.textContent = 'Uploading...';

        // Upload each file
        let completed = 0;
        const total = files.length;

        Array.from(files).forEach((file, index) => {
            const formData = new FormData();
            formData.append('image', file);

            fetch('/upload-image/{{ guid }}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                completed++;
                const progress = (completed / total) * 100;
                progressFill.style.width = progress + '%';
                progressText.textContent = `Uploading... ${completed}/${total}`;

                if (completed === total) {
                    progressText.textContent = 'Upload complete!';
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                }
            })
            .catch(error => {
                console.error('Upload error:', error);
                progressText.textContent = 'Upload failed!';
            });
        });
    }
});

{% if show_association %}
// ========================
// QR Code Association Functions
// ========================

function showAssociationSearch() {
    document.querySelector('.association-banner-actions').style.display = 'none';
    document.getElementById('association-search').style.display = 'block';
    document.getElementById('association-search-input').focus();
    
    // Initialize association autocomplete
    initAssociationAutocomplete();
}

function dismissAssociation() {
    // Remove association overlay
    const overlay = document.getElementById('association-overlay');
    if (overlay) {
        overlay.remove();
    }
    
    // User chose to keep as new item - hide banner and trigger edit mode with yellow overlay
    const banner = document.getElementById('association-banner');
    if (banner) {
        banner.style.display = 'none';
        // Remove from DOM so it stays gone
        banner.remove();
    }
    
    // Remove new_item parameter from URL so banner doesn't come back on refresh
    const url = new URL(window.location);
    url.searchParams.delete('new_item');
    // Add edit_title parameter to trigger yellow overlay
    url.searchParams.set('edit_title', 'true');
    window.history.replaceState({}, '', url.toString());
    
    // Trigger edit mode with yellow overlay
    triggerNewItemEditMode();
}

function cancelAndDelete() {
    // Remove association overlay
    const overlay = document.getElementById('association-overlay');
    if (overlay) {
        overlay.remove();
    }
    
    // User chose to cancel - delete the temporary item and go home
    const banner = document.getElementById('association-banner');
    banner.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="loading"></div><p>Cancelling...</p></div>';
    
    fetch(`/delete-item/{{ guid }}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        window.location.href = '/';
    })
    .catch(error => {
        // Silent fail - just go home
        window.location.href = '/';
    });
}

function cancelAssociation() {
    // Go back to main banner (don't delete)
    document.getElementById('association-search').style.display = 'none';
    document.querySelector('.association-banner-actions').style.display = 'flex';
}

// Association autocomplete
let associationTimeout;
let associationResults = [];

function initAssociationAutocomplete() {
    const input = document.getElementById('association-search-input');
    const dropdown = document.getElementById('association-autocomplete-dropdown');
    
    input.addEventListener('input', function() {
        const query = this.value.trim();
        
        if (!query || query.length < 2) {
            dropdown.classList.remove('show');
            return;
        }
        
        clearTimeout(associationTimeout);
        
        // Show loading state
        dropdown.innerHTML = '<div class="autocomplete-loading">Searching...</div>';
        dropdown.classList.add('show');
        
        // Debounce search
        associationTimeout = setTimeout(() => {
            fetch(`/api/semantic-search?q=${encodeURIComponent(query)}&limit=10&exclude={{ guid }}`)
                .then(response => response.json())
                .then(results => {
                    associationResults = results;
                    renderAssociationResults(results);
                })
                .catch(error => {
                    console.error('Search error:', error);
                    dropdown.classList.remove('show');
                });
        }, 300);
    });
}

function renderAssociationResults(results) {
    const dropdown = document.getElementById('association-autocomplete-dropdown');
    
    if (results.length === 0) {
        dropdown.innerHTML = '<div class="autocomplete-loading">No items found</div>';
        return;
    }
    
    dropdown.innerHTML = results.map(item => `
        <div class="autocomplete-item" onclick="associateWithItem('${item.guid}')">
            ${item.has_image ? 
                `<img src="/thumbnail/${item.image_id}" class="autocomplete-item-thumbnail">` :
                `<div class="autocomplete-item-thumbnail" style="display: flex; align-items: center; justify-content: center; font-size: 20px;">üì¶</div>`
            }
            <div class="autocomplete-item-info">
                <div class="autocomplete-item-name">${item.name}</div>
                <div class="autocomplete-item-meta">
                    ${item.label_number ? `#${item.label_number}` : ''}
                    ${item.contained_count > 0 ? ` ‚Ä¢ ${item.contained_count} items inside` : ''}
                </div>
            </div>
        </div>
    `).join('');
    
    dropdown.classList.add('show');
}

function associateWithItem(targetGuid) {
    // Remove association overlay
    const overlay = document.getElementById('association-overlay');
    if (overlay) {
        overlay.remove();
    }
    const banner = document.getElementById('association-banner');
    banner.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="loading"></div><p>Linking QR code...</p></div>';
    
    // Call the association endpoint
    fetch(`/associate-item/{{ guid }}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            target_guid: targetGuid
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Redirect to the target item
            window.location.href = `/item/${targetGuid}`;
        } else {
            alert('Failed to link QR code: ' + (data.error || 'Unknown error'));
            window.location.href = '/';
        }
    })
    .catch(error => {
        console.error('Association error:', error);
        alert('Failed to link QR code. Please try again.');
        window.location.href = '/';
    });
}
{% endif %}

// Toggle QR section expand/collapse
function toggleQRSection() {
    const content = document.getElementById('qr-section-content');
    const icon = document.getElementById('qr-toggle-icon');
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.style.transform = 'rotate(180deg)';
    } else {
        content.style.display = 'none';
        icon.style.transform = 'rotate(0deg)';
    }
}

// Download QR code (PNG or PDF)
function downloadQRCode(format) {
    const btnId = format === 'png' ? 'download-png-btn' : 'download-pdf-btn';
    const btn = document.getElementById(btnId);
    const originalHtml = btn.innerHTML;
    
    btn.disabled = true;
    btn.innerHTML = 'Downloading...';
    
    const url = `/api/item/{{ guid }}/qr-code.${format}`;
    
    fetch(url)
        .then(response => {
            if (!response.ok) throw new Error('Download failed');
            return response.blob();
        })
        .then(blob => {
            // Create object URL and trigger download
            const objectUrl = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = objectUrl;
            
            // Get filename
            const itemName = '{{ item_data.item[1]|replace(" ", "_") }}' || '{{ guid[:8] }}';
            if (format === 'png') {
                a.download = `qr_${itemName}.png`;
            } else {
                a.download = `qr_label_${itemName}.pdf`;
            }
            
            document.body.appendChild(a);
            a.click();
            
            // Cleanup
            setTimeout(() => {
                window.URL.revokeObjectURL(objectUrl);
                document.body.removeChild(a);
            }, 100);
        })
        .catch(error => {
            console.error('Download error:', error);
            alert('Download failed. Please try again.');
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        });
}

// Update container QR count when checkbox changes
function updateContainerQRCount() {
    const checkbox = document.getElementById('include-nested-checkbox');
    const recursive = checkbox.checked;
    
    // Fetch count from server
    fetch(`/api/item/{{ guid }}/container-count?recursive=${recursive}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const total = data.total_count;
                const pages = Math.ceil(total / 24);
                
                document.getElementById('container-qr-text').textContent = 
                    `Print Container QR Codes (${total} code${total !== 1 ? 's' : ''})`;
                document.getElementById('page-count').textContent = pages;
                document.getElementById('container-qr-info').innerHTML = 
                    `${pages}-page PDF with this item + ${recursive ? 'all nested items' : 'direct children'}`;
            }
        })
        .catch(error => {
            console.error('Count error:', error);
        });
}

// Download full item label (comprehensive half-page)
function downloadFullLabel() {
    const btn = document.getElementById('download-label-btn');
    const originalHtml = btn.innerHTML;
    
    btn.disabled = true;
    btn.innerHTML = '‚è≥ Generating...';
    
    const url = `/api/item/{{ guid }}/full-label.pdf`;
    
    fetch(url)
        .then(response => {
            if (!response.ok) throw new Error('Generation failed');
            return response.blob();
        })
        .then(blob => {
            // Create object URL and trigger download
            const objectUrl = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = objectUrl;
            
            const itemName = '{{ item_data.item[1]|replace(" ", "_") }}' || '{{ guid[:8] }}';
            a.download = `label_${itemName}.pdf`;
            
            document.body.appendChild(a);
            a.click();
            
            // Cleanup
            setTimeout(() => {
                window.URL.revokeObjectURL(objectUrl);
                document.body.removeChild(a);
            }, 100);
        })
        .catch(error => {
            console.error('Download error:', error);
            alert('Failed to generate label. Please try again.');
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        });
}

// Download container QR sheet (parent + all children)
function downloadContainerQRSheet() {
    const btn = document.getElementById('container-qr-btn');
    const originalHtml = btn.innerHTML;
    const checkbox = document.getElementById('include-nested-checkbox');
    const recursive = checkbox ? checkbox.checked : false;
    
    btn.disabled = true;
    btn.innerHTML = '‚è≥ Generating...';
    
    const url = `/api/item/{{ guid }}/container-qr-sheet.pdf?recursive=${recursive}`;
    
    fetch(url)
        .then(response => {
            if (!response.ok) throw new Error('Generation failed');
            return response.blob();
        })
        .then(blob => {
            // Create object URL and trigger download
            const objectUrl = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = objectUrl;
            a.download = `qr_container_{{ item_data.item[1]|replace(" ", "_") or guid[:8] }}${recursive ? '_all' : ''}.pdf`;
            
            document.body.appendChild(a);
            a.click();
            
            // Cleanup
            setTimeout(() => {
                window.URL.revokeObjectURL(objectUrl);
                document.body.removeChild(a);
            }, 100);
        })
        .catch(error => {
            console.error('Download error:', error);
            alert('Failed to generate container QR sheet. Please try again.');
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        });
}

</script>
{% endblock %}
