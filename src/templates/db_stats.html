{% extends "base.html" %}

{% block title %}Database Health Report{% endblock %}

{% block styles %}
<style>
    .stats-container {
        max-width: 600px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .stats-header {
        text-align: center;
        margin-bottom: 30px;
    }
    
    .stats-title {
        font-size: 24px;
        font-weight: 700;
        color: #333;
        margin-bottom: 8px;
    }
    
    .stats-subtitle {
        color: #666;
        font-size: 16px;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 16px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border-left: 4px solid #007bff;
    }
    
    .stat-icon {
        font-size: 28px;
        margin-bottom: 8px;
        display: block;
    }
    
    .stat-value {
        font-size: 24px;
        font-weight: 700;
        color: #007bff;
        margin-bottom: 4px;
    }
    
    .stat-label {
        color: #666;
        font-size: 14px;
        margin-bottom: 8px;
    }
    
    .stat-detail {
        color: #999;
        font-size: 12px;
        font-style: italic;
    }
    
    .fun-facts {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .fun-facts h3 {
        font-size: 18px;
        margin-bottom: 16px;
        color: #333;
    }
    
    .fun-fact {
        margin-bottom: 12px;
        padding: 12px;
        background: white;
        border-radius: 8px;
        border-left: 3px solid #28a745;
    }
    
    .fun-fact:last-child {
        margin-bottom: 0;
    }
    
    .back-btn {
        display: inline-block;
        background: #007bff;
        color: white;
        text-decoration: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 500;
        margin-top: 20px;
    }
    
    .back-btn:hover {
        background: #0056b3;
        text-decoration: none;
        color: white;
    }
    
    .database-info {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 16px;
        margin-top: 20px;
        font-size: 12px;
        color: #666;
        text-align: center;
    }
    
    .bulk-assign-btn {
        background: #28a745;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 8px 12px;
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        margin-top: 4px;
        width: 100%;
    }
    
    .bulk-assign-btn:hover {
        background: #218838;
        transform: translateY(-1px);
    }
    
    .bulk-assign-btn:active {
        transform: translateY(0);
    }
    
    .bulk-assign-btn:disabled {
        background: #6c757d;
        cursor: not-allowed;
        transform: none;
    }
    
    .admin-tools {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 30px;
        border: 1px solid #e9ecef;
    }
    
    .admin-tools h3 {
        font-size: 18px;
        margin-bottom: 16px;
        color: #333;
        text-align: center;
    }
    
    .admin-buttons-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 12px;
    }
    
    .admin-btn {
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 16px;
        cursor: pointer;
        transition: all 0.2s;
        text-align: left;
        display: flex;
        flex-direction: column;
        gap: 4px;
        position: relative;
        overflow: hidden;
    }
    
    .admin-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        border-color: #007bff;
    }
    
    .admin-btn:active {
        transform: translateY(0);
    }
    
    .admin-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }
    
    .admin-btn-icon {
        font-size: 24px;
        margin-bottom: 4px;
    }
    
    .admin-btn-text {
        font-weight: 600;
        color: #333;
        font-size: 14px;
    }
    
    .admin-btn-detail {
        font-size: 12px;
        color: #666;
        margin-top: 2px;
    }
    
    .reindex-btn { border-left: 4px solid #6f42c1; }
    .validate-btn { border-left: 4px solid #28a745; }
    .cache-btn { border-left: 4px solid #ffc107; }
    .optimize-btn { border-left: 4px solid #dc3545; }
    
    .admin-progress {
        position: absolute;
        bottom: 0;
        left: 0;
        height: 3px;
        background: #007bff;
        width: 0%;
        transition: width 0.3s ease;
    }
    
    @media (min-width: 768px) {
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .admin-buttons-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
</style>
{% endblock %}

{% block app_content %}
<div class="stats-container">
    <div class="stats-header">
        <h1 class="stats-title">üè• Database Health Report</h1>
        <p class="stats-subtitle">Your inventory's vital signs are looking great!</p>
    </div>
    
    <div class="stats-grid">
        <div class="stat-card">
            <span class="stat-icon">üì¶</span>
            <div class="stat-value">{{ stats.total_items }}</div>
            <div class="stat-label">Total Items</div>
            <div class="stat-detail">
                {% if stats.total_items == 0 %}
                    Ready for your first item!
                {% elif stats.total_items == 1 %}
                    Just getting started!
                {% elif stats.total_items < 10 %}
                    Building up nicely!
                {% elif stats.total_items < 50 %}
                    Great collection!
                {% else %}
                    Wow, impressive inventory!
                {% endif %}
            </div>
        </div>
        
        <div class="stat-card">
            <span class="stat-icon">üì∑</span>
            <div class="stat-value">{{ stats.total_images }}</div>
            <div class="stat-label">Total Images</div>
            <div class="stat-detail">
                {% if stats.total_images == 0 %}
                    Time to snap some photos!
                {% elif stats.total_images < stats.total_items %}
                    Some items need photos
                {% elif stats.total_images == stats.total_items %}
                    Perfect 1:1 ratio!
                {% else %}
                    {{ "%.1f"|format(stats.total_images / stats.total_items if stats.total_items > 0 else 0) }} photos per item
                {% endif %}
            </div>
        </div>
        
        <div class="stat-card">
            <span class="stat-icon">üè∑Ô∏è</span>
            <div class="stat-value">{{ stats.total_tags }}</div>
            <div class="stat-label">Total Tags</div>
            <div class="stat-detail">
                {% if stats.total_tags == 0 %}
                    No tags yet - try adding some!
                {% elif stats.total_tags < 5 %}
                    Good start on organization!
                {% else %}
                    Well organized collection!
                {% endif %}
            </div>
        </div>
        
        <div class="stat-card">
            <span class="stat-icon">‚è±Ô∏è</span>
            <div class="stat-value">{{ (stats.oldest_item[1].strftime('%b %Y') if stats.oldest_item else 'N/A') }}</div>
            <div class="stat-label">Oldest Item</div>
            <div class="stat-detail">
                {% if stats.oldest_item %}
                    {{ stats.oldest_item[0] or 'Unnamed item' }}
                {% else %}
                    No items yet
                {% endif %}
            </div>
        </div>
        
        <div class="stat-card">
            <span class="stat-icon">üè†</span>
            <div class="stat-value">{{ stats.top_level_items }}</div>
            <div class="stat-label">Top-Level Items</div>
            <div class="stat-detail">Items not inside anything else</div>
        </div>
        
        <div class="stat-card">
            <span class="stat-icon">üì¶</span>
            <div class="stat-value">{{ stats.container_items }}</div>
            <div class="stat-label">Container Items</div>
            <div class="stat-detail">Items that hold other items</div>
        </div>
        
        <div class="stat-card">
            <span class="stat-icon">üìÑ</span>
            <div class="stat-value">{{ stats.leaf_items }}</div>
            <div class="stat-label">Leaf Items</div>
            <div class="stat-detail">Items with nothing inside them</div>
        </div>
        
        <div class="stat-card">
            <span class="stat-icon">ü™Ü</span>
            <div class="stat-value">{{ stats.max_nesting_depth }}</div>
            <div class="stat-label">Deepest Nesting</div>
            <div class="stat-detail">
                {% if stats.max_nesting_depth == 0 %}
                    No nested items yet
                {% elif stats.max_nesting_depth == 1 %}
                    One level deep (item in item)
                {% else %}
                    {{ stats.max_nesting_depth }} levels of Russian dolls!
                {% endif %}
            </div>
        </div>
        
        <div class="stat-card">
            <span class="stat-icon">üè∑Ô∏è</span>
            <div class="stat-value">#{{ stats.next_label_number }}</div>
            <div class="stat-label">Next Label Number</div>
            <div class="stat-detail">Auto-assigned to new items (seq: {{ stats.sequence_value }})</div>
        </div>
        
        <div class="stat-card">
            <span class="stat-icon">üî¢</span>
            <div class="stat-value">{{ stats.highest_label_in_use }}</div>
            <div class="stat-label">Highest Label Used</div>
            <div class="stat-detail">
                {% if stats.highest_label_in_use == 0 %}
                    No labels assigned yet
                {% else %}
                    Label #{{ stats.highest_label_in_use }} is in use
                {% endif %}
            </div>
        </div>
        
        <div class="stat-card" style="border-left-color: #28a745;">
            <span class="stat-icon">üè∑Ô∏è</span>
            <div class="stat-value">{{ stats.unlabeled_count or 0 }}</div>
            <div class="stat-label">Unlabeled Items</div>
            <div class="stat-detail">
                {% if stats.unlabeled_count > 0 %}
                    <button onclick="bulkAssignLabels()" class="bulk-assign-btn" id="bulk-assign-btn">
                        Auto-assign starting from #{{ stats.next_label_number }}
                    </button>
                {% else %}
                    All items have labels! üéâ
                {% endif %}
            </div>
        </div>
        
        <div class="stat-card" style="border-left-color: #6f42c1;">
            <span class="stat-icon">üß†</span>
            <div class="stat-value">{{ stats.embedding_stats.with_embeddings }}</div>
            <div class="stat-label">Items with Embeddings</div>
            <div class="stat-detail">
                {% if stats.embedding_stats.missing_embeddings > 0 %}
                    {{ stats.embedding_stats.missing_embeddings }} items need embeddings
                {% else %}
                    All items indexed for semantic search! üéâ
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Admin Tools Section -->
    <div class="admin-tools">
        <h3>üõ†Ô∏è Admin Tools</h3>
        <div class="admin-buttons-grid">
            <button onclick="reindexEmbeddings()" class="admin-btn reindex-btn" id="reindex-btn">
                <span class="admin-btn-icon">üß†</span>
                <span class="admin-btn-text">Reindex All Embeddings</span>
                <span class="admin-btn-detail">Refresh semantic search for all items</span>
            </button>
            
            <button onclick="validateDatabase()" class="admin-btn validate-btn" id="validate-btn">
                <span class="admin-btn-icon">‚úÖ</span>
                <span class="admin-btn-text">Validate Database</span>
                <span class="admin-btn-detail">Check for orphaned records & integrity</span>
            </button>
            
            <button onclick="clearImageCache()" class="admin-btn cache-btn" id="cache-btn">
                <span class="admin-btn-icon">üóëÔ∏è</span>
                <span class="admin-btn-text">Clear Image Cache</span>
                <span class="admin-btn-detail">Force refresh of all cached images</span>
            </button>
            
            <button onclick="optimizeDatabase()" class="admin-btn optimize-btn" id="optimize-btn">
                <span class="admin-btn-icon">‚ö°</span>
                <span class="admin-btn-text">Optimize Database</span>
                <span class="admin-btn-detail">Vacuum & analyze for better performance</span>
            </button>
        </div>
    </div>
    
    {% if stats.total_items > 0 %}
    <div class="fun-facts">
        <h3>üéâ Fun Facts About Your Inventory</h3>
        
        {% if stats.recent_item %}
        <div class="fun-fact">
            <strong>üìÖ Latest Addition:</strong> 
            "{{ stats.recent_item[0] or 'Unnamed item' }}" was added 
            {{ stats.recent_item[1].strftime('%B %d, %Y') }}
        </div>
        {% endif %}
        
        {% if stats.most_images and stats.most_images[1] > 1 %}
        <div class="fun-fact">
            <strong>üì∏ Photo Champion:</strong> 
            "{{ stats.most_images[0] or 'Unnamed item' }}" wins with {{ stats.most_images[1] }} photos!
        </div>
        {% endif %}
        
        {% if stats.popular_tag and stats.popular_tag[1] > 1 %}
        <div class="fun-fact">
            <strong>üèÜ Most Popular Tag:</strong> 
            "{{ stats.popular_tag[0] }}" is used {{ stats.popular_tag[1] }} times
        </div>
        {% endif %}
        
        {% if stats.total_items > 1 %}
        <div class="fun-fact">
            <strong>üìä Collection Span:</strong> 
            Your inventory spans from {{ stats.oldest_item[1].strftime('%B %Y') if stats.oldest_item else 'unknown' }} 
            to {{ stats.recent_item[1].strftime('%B %Y') if stats.recent_item else 'unknown' }}
        </div>
        {% endif %}
        
        {% if stats.longest_chain_depth > 0 %}
        <div class="fun-fact">
            <strong>üîó Longest Chain:</strong> 
            {{ stats.longest_chain_path }}
            <br><small style="color: #999;">{{ stats.longest_chain_depth + 1 }} items deep!</small>
        </div>
        {% endif %}
        
        {% if stats.biggest_container and stats.biggest_container[1] > 1 %}
        <div class="fun-fact">
            <strong>üéí Biggest Container:</strong> 
            "{{ stats.biggest_container[0] or 'Unnamed item' }}" holds {{ stats.biggest_container[1] }} items directly
        </div>
        {% endif %}
        
        {% if stats.avg_items_per_container > 0 %}
        <div class="fun-fact">
            <strong>üìä Container Efficiency:</strong> 
            Your containers hold an average of {{ stats.avg_items_per_container }} items each
        </div>
        {% endif %}
        
        {% if stats.container_items > 0 and stats.leaf_items > 0 %}
        <div class="fun-fact">
            <strong>üå≥ Organization Ratio:</strong> 
            {{ stats.container_items }} containers organizing {{ stats.leaf_items }} leaf items
            ({{ "%.1f"|format((stats.leaf_items / stats.container_items) if stats.container_items > 0 else 0) }}:1 ratio)
        </div>
        {% endif %}
    </div>
    {% endif %}
    
    <div class="database-info">
        <strong>üîß Technical Details:</strong><br>
        {{ stats.db_version.split(' ')[0] }} ‚Ä¢ Connection Pool: Active ‚Ä¢ Cache: Enabled
    </div>
    
    <a href="/" class="back-btn">‚Üê Back to Home</a>
</div>

<script>
function bulkAssignLabels() {
    const btn = document.getElementById('bulk-assign-btn');
    const originalText = btn.textContent;
    
    // Confirm action
    if (!confirm('Auto-assign sequential label numbers to all unlabeled items? This action cannot be undone.')) {
        return;
    }
    
    // Disable button and show loading
    btn.disabled = true;
    btn.textContent = 'Assigning labels...';
    
    fetch('/bulk-assign-labels', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message + '\n\nAssigned labels:\n' + 
                  data.assignments.map(a => `‚Ä¢ ${a.name}: #${a.label}`).join('\n'));
            
            // Refresh the page to show updated stats
            window.location.reload();
        } else {
            alert('Error: ' + (data.error || 'Unknown error occurred'));
            btn.disabled = false;
            btn.textContent = originalText;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to assign labels. Please try again.');
        btn.disabled = false;
        btn.textContent = originalText;
    });
}

// Admin tool functions
function reindexEmbeddings() {
    const btn = document.getElementById('reindex-btn');
    const originalText = btn.innerHTML;
    
    if (!confirm('Reindex embeddings for ALL items? This will regenerate semantic search data and may take a few minutes.')) {
        return;
    }
    
    btn.disabled = true;
    btn.innerHTML = '<span class="admin-btn-icon">‚è≥</span><span class="admin-btn-text">Reindexing...</span><span class="admin-btn-detail">This may take a few minutes</span>';
    
    fetch('/api/reindex-embeddings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`‚úÖ Success!\n\nProcessed: ${data.total_processed} items\nUpdated: ${data.updated_count} embeddings\n\nSemantic search is now refreshed!`);
            window.location.reload();
        } else {
            alert('‚ùå Error: ' + (data.error || 'Unknown error occurred'));
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('‚ùå Failed to reindex embeddings. Please try again.');
        btn.disabled = false;
        btn.innerHTML = originalText;
    });
}

function validateDatabase() {
    const btn = document.getElementById('validate-btn');
    const originalText = btn.innerHTML;
    
    btn.disabled = true;
    btn.innerHTML = '<span class="admin-btn-icon">‚è≥</span><span class="admin-btn-text">Validating...</span><span class="admin-btn-detail">Checking database integrity</span>';
    
    fetch('/api/validate-database', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let message = '‚úÖ Database Validation Complete!\n\n';
            message += `‚Ä¢ Checked ${data.checks_performed} integrity rules\n`;
            message += `‚Ä¢ Found ${data.issues_found} issues\n`;
            if (data.issues_fixed > 0) {
                message += `‚Ä¢ Auto-fixed ${data.issues_fixed} minor issues\n`;
            }
            if (data.issues_found === 0) {
                message += '\nüéâ Your database is in perfect health!';
            } else {
                message += '\nSee console for detailed report.';
                console.log('Database validation details:', data.details);
            }
            alert(message);
        } else {
            alert('‚ùå Error: ' + (data.error || 'Unknown error occurred'));
        }
        btn.disabled = false;
        btn.innerHTML = originalText;
    })
    .catch(error => {
        console.error('Error:', error);
        alert('‚ùå Failed to validate database. Please try again.');
        btn.disabled = false;
        btn.innerHTML = originalText;
    });
}

function clearImageCache() {
    const btn = document.getElementById('cache-btn');
    const originalText = btn.innerHTML;
    
    if (!confirm('Clear all cached images? This will force regeneration of thumbnails and previews on next access.')) {
        return;
    }
    
    btn.disabled = true;
    btn.innerHTML = '<span class="admin-btn-icon">‚è≥</span><span class="admin-btn-text">Clearing...</span><span class="admin-btn-detail">Removing cached data</span>';
    
    fetch('/api/clear-cache', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`‚úÖ Cache Cleared!\n\n‚Ä¢ Removed ${data.items_cleared} cached items\n‚Ä¢ Freed ${data.memory_freed} of memory\n\nImages will regenerate on next access.`);
        } else {
            alert('‚ùå Error: ' + (data.error || 'Unknown error occurred'));
        }
        btn.disabled = false;
        btn.innerHTML = originalText;
    })
    .catch(error => {
        console.error('Error:', error);
        alert('‚ùå Failed to clear cache. Please try again.');
        btn.disabled = false;
        btn.innerHTML = originalText;
    });
}

function optimizeDatabase() {
    const btn = document.getElementById('optimize-btn');
    const originalText = btn.innerHTML;
    
    if (!confirm('Optimize database performance? This will run VACUUM and ANALYZE commands and may take a few minutes.')) {
        return;
    }
    
    btn.disabled = true;
    btn.innerHTML = '<span class="admin-btn-icon">‚è≥</span><span class="admin-btn-text">Optimizing...</span><span class="admin-btn-detail">Running VACUUM and ANALYZE</span>';
    
    fetch('/api/optimize-database', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`‚úÖ Database Optimized!\n\n‚Ä¢ Reclaimed ${data.space_reclaimed} of disk space\n‚Ä¢ Updated ${data.tables_analyzed} table statistics\n‚Ä¢ Performance should be improved!`);
        } else {
            alert('‚ùå Error: ' + (data.error || 'Unknown error occurred'));
        }
        btn.disabled = false;
        btn.innerHTML = originalText;
    })
    .catch(error => {
        console.error('Error:', error);
        alert('‚ùå Failed to optimize database. Please try again.');
        btn.disabled = false;
        btn.innerHTML = originalText;
    });
}
</script>
{% endblock %}