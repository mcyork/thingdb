{% extends "base.html" %}

{% block title %}Remote Access Setup{% endblock %}

{% block styles %}
<style>
    .status-indicator {
        display: inline-block; width: 12px; height: 12px;
        border-radius: 50%; margin-right: 8px;
    }
    .status-active { background: var(--success-color); }
    .status-inactive { background: var(--danger-color); }
    .status-unknown { background: var(--warning-color); }
    .status-not-configured { background: var(--secondary-color); }

    .info-grid {
        display: grid; grid-template-columns: 1fr; gap: 12px;
        margin: 16px 0;
    }
    @media (min-width: 600px) {
        .info-grid { grid-template-columns: 1fr 1fr; }
    }
    .info-item {
        background: var(--background-light); padding: 12px;
        border-radius: 6px;
    }
    .info-label { font-size: 13px; color: var(--text-light); margin-bottom: 4px; }
    .info-value { font-weight: 600; font-family: monospace; word-break: break-all; }
    
    .email-item {
        display: flex; justify-content: space-between; align-items: center;
        padding: 4px 0;
    }
    .remove-email-btn {
        background: var(--danger-color); color: white; border: none;
        border-radius: 50%; width: 24px; height: 24px; cursor: pointer;
        font-size: 16px; line-height: 1;
    }
    .alert {
        padding: 12px; border-radius: 8px; margin: 16px 0;
        border: 1px solid;
    }
    .alert-info { background: #d1ecf1; border-color: #bee5eb; color: #0c5460; }
    .loading { text-align: center; padding: 16px; display: none; }
</style>
{% endblock %}

{% block app_content %}
<div class="sub-header">
    <div class="sub-header-content">
        <button onclick="history.back()" class="sub-header-back-btn">‚Üê</button>
        <h1 class="sub-header-title">Remote Access</h1>
    </div>
</div>

<div class="app-content">
    <!-- Status Card -->
    <div class="card">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
            <span class="status-indicator status-{{ 'active' if tunnel_status.configured and tunnel_status.status == 'Active' else 'inactive' if tunnel_status.configured else 'not-configured' }}"></span>
            <h2 style="margin:0; font-size: 18px;">
                Status: {{ tunnel_status.status if tunnel_status.configured else 'Not Configured' }}
            </h2>
        </div>

        {% if tunnel_status.configured %}
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">Access URL</div>
                    <div class="info-value">{{ tunnel_status.url or 'Unknown' }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Tunnel ID</div>
                    <div class="info-value">{{ tunnel_status.tunnel_id[:8] + '...' if tunnel_status.tunnel_id else 'Unknown' }}</div>
                </div>
            </div>
            <div class="info-item">
                <div class="info-label">Authorized Emails</div>
                {% for email in tunnel_status.emails %}
                    <div class="email-item">
                        <span>{{ email }}</span>
                        <button class="remove-email-btn" onclick="removeEmail('{{ email }}')" title="Remove email">√ó</button>
                    </div>
                {% else %}
                    <div class="info-value">None</div>
                {% endfor %}
            </div>
            <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 16px;">
                <button class="btn btn-secondary" onclick="restartTunnel()">Restart Tunnel</button>
                <button class="btn btn-secondary" onclick="showEmailManagement()">Manage Emails</button>
            </div>
        {% else %}
            <div class="alert alert-info">
                No tunnel configured. Set up remote access to securely access your inventory from anywhere.
            </div>
            <button class="btn btn-primary" onclick="showSetupForm()">üöÄ Setup Remote Access</button>
        {% endif %}
    </div>

    <!-- Setup/Management Forms -->
    <div id="form-container" style="display: none;">
        <div class="card" id="email-management-form">
            <h3>Manage Authorized Emails</h3>
            <div class="form-group">
                <label for="cf_token_email" class="form-label">Cloudflare API Token</label>
                <input type="password" id="cf_token_email" class="form-input" required>
            </div>
            <div class="form-group">
                <label for="new_email" class="form-label">Email Address</label>
                <input type="email" id="new_email" class="form-input" required>
            </div>
            <div style="display: flex; gap: 8px;">
                <button type="button" class="btn btn-primary" onclick="addEmail()">Add Email</button>
                <button type="button" class="btn btn-secondary" onclick="hideForms()">Cancel</button>
            </div>
        </div>

        <div class="card" id="setup-form">
            <h3>Configure New Tunnel</h3>
            <p>You'll need a Cloudflare API token. <a href="https://dash.cloudflare.com/profile/api-tokens" target="_blank">Get one here</a>.</p>
            <form id="tunnel-form">
                <div class="form-group">
                    <label for="cf_token" class="form-label">Cloudflare API Token</label>
                    <input type="password" id="cf_token" class="form-input" required>
                </div>
                <div class="form-group">
                    <label for="email" class="form-label">Your Email Address</label>
                    <input type="email" id="email" class="form-input" required>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button type="submit" class="btn btn-primary">Setup Tunnel</button>
                    <button type="button" class="btn btn-secondary" onclick="hideForms()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <div class="loading" id="loading"><div class="spinner"></div> Processing...</div>
    <div id="messages"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const formContainer = document.getElementById('form-container');
    const setupForm = document.getElementById('setup-form');
    const emailForm = document.getElementById('email-management-form');

    function showSetupForm() {
        formContainer.style.display = 'block';
        setupForm.style.display = 'block';
        emailForm.style.display = 'none';
    }
    function showEmailManagement() {
        formContainer.style.display = 'block';
        setupForm.style.display = 'none';
        emailForm.style.display = 'block';
    }
    function hideForms() {
        formContainer.style.display = 'none';
    }

    function showLoading(show) { document.getElementById('loading').style.display = show ? 'block' : 'none'; }
    function showMessage(text, type) {
        const messagesDiv = document.getElementById('messages');
        messagesDiv.innerHTML = `<div class="alert alert-${type === 'success' ? 'info' : 'danger'}">${text}</div>`;
        setTimeout(() => messagesDiv.innerHTML = '', 5000);
    }

    async function restartTunnel() {
        if (!confirm('Restart the tunnel? This may cause a brief interruption.')) return;
        showLoading(true);
        try {
            const response = await fetch('/api/restart-tunnel', { method: 'POST' });
            const result = await response.json();
            if (response.ok) {
                showMessage('Tunnel restarted successfully!', 'success');
                setTimeout(() => window.location.reload(), 2000);
            } else {
                throw new Error(result.error);
            }
        } catch (error) {
            showMessage('Failed to restart tunnel: ' + error.message, 'danger');
        } finally {
            showLoading(false);
        }
    }

    document.getElementById('tunnel-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        showLoading(true);
        try {
            const response = await fetch('/api/setup-tunnel', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    cf_token: document.getElementById('cf_token').value,
                    email: document.getElementById('email').value
                })
            });
            const result = await response.json();
            if (response.ok) {
                showMessage('Tunnel setup successful!', 'success');
                setTimeout(() => window.location.reload(), 3000);
            } else {
                throw new Error(result.error);
            }
        } catch (error) {
            showMessage('Setup failed: ' + error.message, 'danger');
        } finally {
            showLoading(false);
        }
    });

    async function addEmail() {
        const cfToken = document.getElementById('cf_token_email').value.trim();
        const email = document.getElementById('new_email').value.trim();
        if (!cfToken || !email) return showMessage('API token and email are required.', 'danger');
        
        showLoading(true);
        try {
            const response = await fetch('/api/add-email', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ cf_token: cfToken, email: email })
            });
            const result = await response.json();
            if (response.ok) {
                showMessage(result.message, 'success');
                setTimeout(() => window.location.reload(), 2000);
            } else {
                throw new Error(result.error);
            }
        } catch (error) {
            showMessage('Failed to add email: ' + error.message, 'danger');
        } finally {
            showLoading(false);
        }
    }

    async function removeEmail(email) {
        if (!confirm(`Remove access for ${email}?`)) return;
        const cfToken = prompt('Please enter your Cloudflare API token to confirm:');
        if (!cfToken) return;

        showLoading(true);
        try {
            const response = await fetch('/api/remove-email', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ cf_token: cfToken, email: email })
            });
            const result = await response.json();
            if (response.ok) {
                showMessage(result.message, 'success');
                setTimeout(() => window.location.reload(), 2000);
            } else {
                throw new Error(result.error);
            }
        } catch (error) {
            showMessage('Failed to remove email: ' + error.message, 'danger');
        } finally {
            showLoading(false);
        }
    }
</script>
{% endblock %}
