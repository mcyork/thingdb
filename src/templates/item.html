{% extends "base.html" %}

{% block title %}{{ item_data.item[1] or ('Item_' + guid[:8]) }}{% endblock %}

{% block extra_head %}
{% endblock %}

{% block styles %}
<style>
    /* Item Page Specific Styles */
    .header-edit-btn {
        background: rgba(255,255,255,0.2);
        border: 1px solid rgba(255,255,255,0.3);
        border-radius: 6px;
        padding: 6px 10px;
        cursor: pointer;
        font-size: 14px;
        color: white;
        transition: all 0.2s;
    }
    
    .header-edit-btn:hover {
        background: rgba(255,255,255,0.3);
    }
    
    .header-edit-btn:active {
        transform: scale(0.95);
    }
    
    .header-edit-name-form {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .header-edit-name-input {
        flex: 1;
        padding: 6px 12px;
        border: 1px solid rgba(255,255,255,0.3);
        border-radius: 6px;
        font-size: 18px;
        font-weight: 600;
        background: rgba(255,255,255,0.1);
        color: white;
    }
    
    .header-edit-name-input:focus {
        outline: none;
        background: rgba(255,255,255,0.2);
        border-color: rgba(255,255,255,0.5);
    }
    
    /* GUID at bottom of content */
    .content-guid {
        margin-top: 40px;
        padding-top: 20px;
        border-top: 1px solid #eee;
        text-align: center;
    }
    
    .guid-text {
        font-family: 'SF Mono', Monaco, monospace;
        font-size: 11px;
        color: #999;
        word-break: break-all;
        line-height: 1.3;
    }
    
    .edit-description-btn {
        background: #f8f9fa;
        border: none;
        border-radius: 6px;
        padding: 8px;
        cursor: pointer;
        font-size: 14px;
        color: #666;
        transition: all 0.2s;
    }
    
    .edit-description-btn:active {
        transform: scale(0.95);
        background: #e9ecef;
    }
    
    /* Contained Items Section */
    .contained-items-section {
        background: white;
        padding: 16px;
        margin: 8px 16px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .contained-item {
        display: flex;
        align-items: center;
        padding: 12px;
        background: #f8f9fa;
        border-radius: 6px;
        margin-bottom: 8px;
        text-decoration: none;
        color: #333;
        transition: all 0.2s;
    }
    
    .contained-item:hover {
        background: #e9ecef;
        transform: translateX(4px);
    }
    
    .contained-item:last-child {
        margin-bottom: 0;
    }
    
    .contained-item-thumbnail {
        width: 48px;
        height: 48px;
        object-fit: cover;
        border-radius: 4px;
        background: #ddd;
        margin-right: 12px;
        flex-shrink: 0;
    }
    
    .contained-item-info {
        flex: 1;
        min-width: 0;
    }
    
    .contained-item-name {
        font-weight: 500;
        color: #333;
        margin-bottom: 2px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .contained-item-meta {
        font-size: 12px;
        color: #666;
    }
    
    .parent-item-notice {
        background: #e8f4fd;
        border: 1px solid #bee5eb;
        border-radius: 6px;
        padding: 12px;
        margin: 8px 16px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .parent-item-notice a {
        color: #0066cc;
        text-decoration: none;
        font-weight: 500;
    }
    
    .parent-item-notice a:hover {
        text-decoration: underline;
    }
    
    .empty-contained-items {
        text-align: center;
        padding: 24px;
        color: #999;
        font-style: italic;
    }
    
    /* Breadcrumb Navigation */
    .breadcrumb-nav {
        background: white;
        padding: 12px 16px;
        margin: 0 16px;
        margin-top: 8px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        overflow-x: auto;
        white-space: nowrap;
    }
    
    .breadcrumb-item {
        color: #0066cc;
        text-decoration: none;
        flex-shrink: 0;
    }
    
    .breadcrumb-item:hover {
        text-decoration: underline;
    }
    
    .breadcrumb-separator {
        color: #999;
        flex-shrink: 0;
    }
    
    .breadcrumb-current {
        color: #333;
        font-weight: 500;
        flex-shrink: 0;
    }
    
    /* Autocomplete Styles */
    .autocomplete-wrapper {
        position: relative;
        flex: 1;
    }
    
    .autocomplete-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-radius: 6px;
        margin-top: 4px;
        max-height: 300px;
        overflow-y: auto;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        z-index: 1000;
        display: none;
    }
    
    .autocomplete-dropdown.show {
        display: block;
    }
    
    .autocomplete-item {
        padding: 12px 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 12px;
        border-bottom: 1px solid #f0f0f0;
        transition: background-color 0.2s;
    }
    
    .autocomplete-item:last-child {
        border-bottom: none;
    }
    
    .autocomplete-item:hover,
    .autocomplete-item.selected {
        background-color: #f8f9fa;
    }
    
    .autocomplete-item-thumbnail {
        width: 36px;
        height: 36px;
        object-fit: cover;
        border-radius: 4px;
        background: #e9ecef;
        flex-shrink: 0;
    }
    
    .autocomplete-item-info {
        flex: 1;
        min-width: 0;
    }
    
    .autocomplete-item-name {
        font-weight: 500;
        color: #333;
        margin-bottom: 2px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .autocomplete-item-meta {
        font-size: 12px;
        color: #666;
    }
    
    .autocomplete-no-results {
        padding: 16px;
        text-align: center;
        color: #999;
        font-style: italic;
    }
    
    .autocomplete-loading {
        padding: 16px;
        text-align: center;
        color: #666;
    }
    
    
    /* Image Gallery - Constrained Grid */
    .image-gallery-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px;
        background: white;
        border-bottom: 1px solid #eee;
        margin: 8px 16px 8px 16px;
        box-sizing: border-box;
        overflow: visible;
    }
    
    .gallery-title {
        font-size: 16px;
        font-weight: 700;
        color: #333;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin: 0;
    }
    
    .controls-toggle {
        background: #007bff;
        border: 1px solid #007bff;
        border-radius: 6px;
        padding: 6px 12px;
        font-size: 12px;
        color: white;
        cursor: pointer;
        transition: all 0.2s;
        font-weight: 500;
        white-space: nowrap;
        flex-shrink: 0;
    }
    
    .controls-toggle:hover {
        background: #0056b3;
        border-color: #0056b3;
    }
    
    .controls-toggle.active {
        background: #6c757d;
        color: white;
        border-color: #6c757d;
    }
    
    .image-gallery {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 4px;
        padding: 8px;
        background: #f5f5f5;
    }
    
    .image-item {
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: transform 0.2s;
    }
    
    .image-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .image-container {
        position: relative;
        aspect-ratio: 1;
        overflow: hidden;
        background: #f0f0f0;
    }
    
    .image-container a {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
        text-decoration: none;
    }
    
    .image-container img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        display: block;
    }
    
    .image-controls {
        display: none;
        justify-content: center;
        align-items: center;
        gap: 8px;
        padding: 8px;
        background: rgba(255,255,255,0.95);
        border-top: 1px solid #eee;
        transition: all 0.2s ease;
    }
    
    .controls-visible .image-controls {
        display: flex;
    }
    
    .image-control-btn {
        width: 32px;
        height: 32px;
        border: none;
        border-radius: 50%;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .rotate-btn {
        background: #f8f9fa;
        color: #666;
        border: 1px solid #dee2e6;
    }
    
    .rotate-btn:hover {
        background: #17a2b8;
        color: white;
        transform: scale(1.1);
    }
    
    .delete-btn {
        background: #f8f9fa;
        color: #666;
        border: 1px solid #dee2e6;
    }
    
    .delete-btn:hover {
        background: #dc3545;
        color: white;
        transform: scale(1.1);
    }
    
    .image-control-btn:active {
        transform: scale(0.95);
    }
    
    .primary-radio-label {
        display: flex;
        align-items: center;
        gap: 4px;
        cursor: pointer;
        font-size: 12px;
        color: #666;
        margin-right: auto;
    }
    
    .primary-radio {
        cursor: pointer;
    }
    
    .primary-label {
        font-weight: 500;
    }
    
    /* Content Section */
    .content-section {
        background: white;
        padding: 20px;
        margin-top: 8px;
    }
    
    .section-header {
        font-size: 14px;
        font-weight: 600;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 12px;
    }
    
    .content-text {
        font-size: 16px;
        line-height: 1.5;
        color: #333;
    }
    
    .content-text p {
        margin-bottom: 12px;
    }
    
    .content-text p:last-child {
        margin-bottom: 0;
    }
    
    .empty-content {
        color: #999;
        font-style: italic;
    }
    
    /* Tags Section */
    .tags-section {
        background: white;
        padding: 20px;
        margin-top: 8px;
    }
    
    .tags-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }
    
    .tag {
        background: #007bff;
        color: white;
        padding: 6px 12px;
        border-radius: 16px;
        font-size: 13px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 6px;
        position: relative;
        transition: all 0.3s ease;
    }
    
    .tag-text {
        flex: 1;
    }
    
    .tag-delete {
        background: rgba(255,255,255,0.3);
        border: none;
        color: white;
        border-radius: 50%;
        width: 18px;
        height: 18px;
        font-size: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        opacity: 0.7;
    }
    
    .tag-delete:hover {
        background: rgba(255,255,255,0.5);
        opacity: 1;
    }
    
    .tag-delete:active {
        transform: scale(0.9);
    }
    
    /* Add Content Forms */
    .add-section {
        background: white;
        padding: 20px;
        margin-top: 8px;
        border-top: 1px solid #eee;
    }
    
    .add-forms-container {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    
    .add-form {
        flex: 1;
        margin-bottom: 0;
    }
    
    .add-form:last-child {
        margin-bottom: 0;
    }
    
    .form-textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 16px;
        font-family: inherit;
        resize: vertical;
        min-height: 80px;
        -webkit-appearance: none;
    }
    
    .form-textarea:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
    }
    
    .upload-zone {
        border: 2px dashed #ddd;
        border-radius: 8px;
        padding: 24px;
        text-align: center;
        margin-bottom: 12px;
        transition: all 0.2s;
    }
    
    .upload-zone.drag-over {
        border-color: #007bff;
        background: #f0f8ff;
    }
    
    .file-input {
        display: none;
    }
    
    .file-label {
        display: inline-block;
        padding: 12px 24px;
        background: #f8f9fa;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s;
    }
    
    .file-label:active {
        transform: scale(0.96);
        background: #e9ecef;
    }
    
    /* Action Bar */
    .action-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        border-top: 1px solid #eee;
        padding: 12px 16px;
        padding-bottom: calc(12px + env(safe-area-inset-bottom));
        display: flex;
        gap: 12px;
        z-index: 1000;
    }
    
    .action-bar .btn {
        flex: 1;
    }
    
    /* Adjust content padding for fixed action bar */
    .app-content {
        padding: 0 !important;
        padding-bottom: calc(80px + env(safe-area-inset-bottom)) !important;
        overflow-x: hidden;
        overflow-y: auto;
    }
    
    /* Add padding back to individual sections */
    .content-section,
    .tags-section,
    .add-section {
        margin: 0 16px;
    }
    
    /* Mobile optimizations */
    @media (max-width: 768px) {
        .image-gallery {
            grid-template-columns: repeat(3, 1fr);
        }
        
        /* Always show controls on mobile */
        .image-item-controls {
            opacity: 1;
        }
        
        /* Keep forms stacked on mobile */
        .add-forms-container {
            flex-direction: column;
            gap: 20px;
        }
    }
    
    
    /* Larger screens */
    @media (min-width: 769px) {
        .image-gallery {
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            padding: 12px;
        }
        
        
        /* Two-column layout for add forms on desktop */
        .add-forms-container {
            flex-direction: row;
            gap: 24px;
            align-items: flex-start;
        }
        
        .add-form {
            flex: 1;
            min-width: 0; /* Allow forms to shrink properly */
        }
        
        /* Adjust form elements for narrower columns */
        .upload-zone {
            padding: 16px;
        }
        
        .form-textarea {
            min-height: 60px;
        }
        
        .section-header {
            font-size: 13px;
        }
    }
</style>
{% endblock %}

{% block app_content %}
<!-- App Header -->
<header class="app-header">
    <div class="app-header-content">
        <a href="/" class="btn-icon" style="background: none; color: white; margin-right: 12px;">‚Äπ</a>
        <div style="flex: 1; display: flex; align-items: center; gap: 12px;">
            <h1 id="header-name-display">{{ item_data.item[1] or ('Item_' + guid[:8]) }}</h1>
            {% if item_data.item[6] %}
                <span id="header-label-display" style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 4px; font-size: 14px; font-weight: 500;">#{{ item_data.item[6] }}</span>
            {% endif %}
            <form class="header-edit-name-form" id="header-edit-name-form" style="display: none; flex: 1;">
                <input type="text" class="header-edit-name-input" id="header-name-input" value="{{ item_data.item[1] or ('Item_' + guid[:8]) }}">
                <button type="submit" class="btn btn-light" style="padding: 6px 12px; font-size: 14px;">Save</button>
                <button type="button" onclick="cancelHeaderEditName()" class="btn btn-light" style="padding: 6px 12px; font-size: 14px; opacity: 0.8;">Cancel</button>
            </form>
            <form class="header-edit-label-form" id="header-edit-label-form" style="display: none; align-items: center; gap: 8px;">
                <span style="color: white;">#</span>
                <input type="text" class="header-edit-label-input" id="header-label-input" value="{{ item_data.item[6] or '' }}" placeholder="Number" style="width: 80px; padding: 4px 8px; border: none; border-radius: 4px;">
                <button type="submit" class="btn btn-light" style="padding: 4px 8px; font-size: 12px;">Save</button>
                <button type="button" onclick="cancelHeaderEditLabel()" class="btn btn-light" style="padding: 4px 8px; font-size: 12px; opacity: 0.8;">Cancel</button>
            </form>
        </div>
        <div style="display: flex; gap: 4px;">
            <button onclick="editHeaderName()" class="header-edit-btn" id="header-edit-btn" title="Edit Name">‚úèÔ∏è</button>
            <button onclick="editHeaderLabel()" class="header-edit-btn" id="header-label-edit-btn" title="Edit Label">#</button>
        </div>
    </div>
</header>

{% if show_association %}
<!-- QR Code Association Banner -->
<div class="association-banner" id="association-banner">
    <div class="association-banner-content">
        <div class="association-banner-icon">üîó</div>
        <div class="association-banner-text">
            <h3>New item scanned</h3>
            <p>What would you like to do?</p>
        </div>
    </div>
    <div class="association-banner-actions">
        <button onclick="dismissAssociation()" class="btn btn-primary" style="font-size: 16px; padding: 12px 20px;">
            Create new item
        </button>
        <button onclick="showAssociationSearch()" class="btn btn-secondary" style="font-size: 14px; padding: 10px 16px;">
            Link to existing
        </button>
        <button onclick="cancelAndDelete()" class="btn btn-danger" style="font-size: 14px; padding: 10px 16px;">
            Cancel
        </button>
    </div>
    
    <!-- Association Search (hidden by default) -->
    <div class="association-search" id="association-search" style="display: none;">
        <div class="association-search-header">
            <h4>Search for the existing item:</h4>
        </div>
        <div class="association-autocomplete-wrapper">
            <input type="text" 
                   id="association-search-input" 
                   class="form-input" 
                   placeholder="Type item name to search..." 
                   autocomplete="off"
                   style="font-size: 16px; padding: 14px;">
            <div id="association-autocomplete-dropdown" class="autocomplete-dropdown"></div>
        </div>
        <button onclick="cancelAssociation()" class="btn btn-secondary" style="margin-top: 12px; width: 100%;">
            Cancel
        </button>
    </div>
</div>

<style>
.association-banner {
    background: #e3f2fd;
    border: 1px solid #1976d2;
    border-radius: 12px;
    margin: 16px;
    padding: 20px;
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from {
        transform: translateY(-20px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.association-banner-content {
    display: flex;
    align-items: flex-start;
    gap: 16px;
    margin-bottom: 16px;
}

.association-banner-icon {
    font-size: 32px;
    flex-shrink: 0;
}

.association-banner-text h3 {
    margin: 0 0 4px 0;
    font-size: 18px;
    font-weight: 600;
    color: #1565c0;
}

.association-banner-text p {
    margin: 0;
    color: #424242;
    font-size: 15px;
}

.association-banner-actions {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}

.association-search {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #90caf9;
}

.association-search-header h4 {
    margin: 0 0 12px 0;
    font-size: 16px;
    font-weight: 600;
    color: #1565c0;
}

.association-autocomplete-wrapper {
    position: relative;
}
</style>
{% endif %}

<!-- Main Content -->
<div class="app-content">
    <!-- Breadcrumb Navigation -->
    {% if item_data.breadcrumb %}
    <div class="breadcrumb-nav">
        <a href="/" class="breadcrumb-item">Home</a>
        {% for ancestor in item_data.breadcrumb %}
        <span class="breadcrumb-separator">‚Ä∫</span>
        <a href="/item/{{ ancestor.guid }}" class="breadcrumb-item">{{ ancestor.name }}</a>
        {% endfor %}
        <span class="breadcrumb-separator">‚Ä∫</span>
        <span class="breadcrumb-current">{{ item_data.item[1] or ('Item_' + guid[:8]) }}</span>
    </div>
    {% endif %}
    
    <!-- Image Gallery -->
    {% if images %}
    <div class="image-gallery" id="image-gallery">
        {% for image in images %}
        <div class="image-item">
            <div class="image-container">
                <a href="/image/{{ image[0] }}">
                    <img src="/thumbnail/{{ image[0] }}" alt="{{ image[7] or 'Image' }}" loading="lazy">
                </a>
            </div>
            <div class="image-controls">
                <label class="primary-radio-label">
                    <input type="radio" name="primary-image" value="{{ image[0] }}" 
                           {% if image[8] %}checked{% endif %} 
                           onchange="setPrimaryImage({{ image[0] }})"
                           class="primary-radio"
                           title="Set as primary image">
                </label>
                <button onclick="rotateImage({{ image[0] }})" class="image-control-btn rotate-btn" title="Rotate image">
                    ‚Üª
                </button>
                <button onclick="deleteImage({{ image[0] }})" class="image-control-btn delete-btn" title="Delete image">
                    √ó
                </button>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    
    <!-- Description Section -->
    <div class="content-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <h3 class="section-header" style="margin-bottom: 0;">Description</h3>
            <button onclick="editDescription()" class="edit-description-btn" id="edit-description-btn">‚úèÔ∏è</button>
        </div>
        
        <div class="content-text" id="description-display">
            {% if item_data.item[2] %}
                <p>{{ item_data.item[2] }}</p>
            {% else %}
                <p class="empty-content">No description added yet</p>
            {% endif %}
        </div>
        
        <form class="edit-name-form" id="edit-description-form" style="display: none;">
            <textarea class="form-textarea" id="description-input" rows="4" placeholder="Enter description...">{{ item_data.item[2] or '' }}</textarea>
            <div style="display: flex; gap: 8px; margin-top: 8px;">
                <button type="submit" class="btn btn-primary" style="padding: 8px 16px; font-size: 14px;">Save</button>
                <button type="button" onclick="cancelEditDescription()" class="btn btn-secondary" style="padding: 8px 16px; font-size: 14px;">Cancel</button>
            </div>
        </form>
    </div>
    
    <!-- Parent Item Notice -->
    {% if item_data.parent_item %}
    <div class="parent-item-notice">
        <span>üì¶ This item is contained in:</span>
        <a href="/item/{{ item_data.parent_item[0] }}">{{ item_data.parent_item[1] }}</a>
    </div>
    {% endif %}
    
    <!-- Contained Items Section -->
    {% if item_data.contained_items %}
    <div class="contained-items-section">
        <h3 class="section-header" style="margin-bottom: 12px;">Items Contained in This Item</h3>
        <div class="contained-items-list">
            {% for contained_item in item_data.contained_items %}
            <a href="/item/{{ contained_item[0] }}" class="contained-item">
                {% if contained_item[4] %}
                <img src="/thumbnail/{{ contained_item[4] }}" alt="{{ contained_item[1] }}" class="contained-item-thumbnail">
                {% else %}
                <div class="contained-item-thumbnail" style="background: #e9ecef; display: flex; align-items: center; justify-content: center; font-size: 20px; color: #adb5bd;">üì¶</div>
                {% endif %}
                <div class="contained-item-info">
                    <div class="contained-item-name">{{ contained_item[1] }}</div>
                    <div class="contained-item-meta">
                        {{ contained_item[3] }} photo{{ 's' if contained_item[3] != 1 else '' }} ‚Ä¢ 
                        Added {{ contained_item[2].strftime('%b %d, %Y') }}
                    </div>
                </div>
            </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <!-- Move Item Section -->
    <div class="content-section">
        <div id="move-item-section">
            {% if item_data.parent_item %}
            <p style="margin-bottom: 12px; color: #666;">Currently inside: <strong>{{ item_data.parent_item[1] }}</strong></p>
            <button onclick="removeFromContainer()" class="btn btn-secondary" style="margin-bottom: 12px;">Remove from Container</button>
            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #eee;">
                <p style="margin-bottom: 8px; color: #666;">Or move to a different container:</p>
            </div>
            {% endif %}
            
            <form id="move-item-form" style="display: flex; gap: 8px; align-items: flex-end;">
                <div class="autocomplete-wrapper">
                    <input type="text" id="parent-search-input" class="form-input" placeholder="Type to find item to move this into" style="width: 100%;" autocomplete="off">
                    <input type="hidden" id="parent-guid-input" name="parent_guid">
                    <div id="autocomplete-dropdown" class="autocomplete-dropdown"></div>
                </div>
                <button type="submit" class="btn btn-primary" id="move-item-btn" disabled>Move Item</button>
            </form>
            <p style="margin-top: 8px; font-size: 12px; color: #999;">Start typing to search for items by name. Select the container you want to move this item into.</p>
        </div>
    </div>
    
    <!-- Tags Section -->
    {% if categories %}
    <div class="tags-section">
        <h3 class="section-header">Tags</h3>
        <div class="tags-list">
            {% for category in categories %}
            <span class="tag" id="tag-{{ category[0] }}">
                <span class="tag-text">{{ category[1] }}</span>
                <button class="tag-delete" onclick="deleteTag({{ category[0] }}, '{{ category[1] }}')" title="Remove tag">√ó</button>
            </span>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <!-- Add Content Section -->
    <div class="add-section">
        <div class="add-forms-container">
            <!-- Add Photo -->
            <form method="POST" action="/upload-image/{{ guid }}" enctype="multipart/form-data" class="add-form">
                <h3 class="section-header">Add Photo</h3>
                <div class="upload-zone" id="upload-zone">
                    <input type="file" name="image" id="image-input" class="file-input" accept="image/*" multiple capture="environment" required>
                    <label for="image-input" class="file-label">
                        üì∑ Choose Photos
                    </label>
                    <div style="margin-top: 8px; font-size: 13px; color: #999;">
                        or drag and drop
                    </div>
                </div>
                <input type="hidden" name="description" value="">
                <button type="submit" class="btn btn-primary btn-block" id="upload-button" style="display: none;">Upload Photo</button>
            </form>
            
            
            <!-- Add Tag -->
            <form method="POST" action="/add-category/{{ guid }}" class="add-form">
                <input type="text" name="category_name" class="form-input" placeholder="Type tag name and press Enter..." required>
            </form>
        </div>
        
        <!-- GUID at bottom of content -->
        <div class="content-guid">
            <small class="guid-text">GUID: {{ guid }}</small>
        </div>
    </div>
</div>

<!-- Fixed Action Bar -->
<div class="action-bar">
    <a href="/" class="btn btn-secondary">Back</a>
    <button onclick="toggleControls()" class="btn btn-primary" id="controls-toggle">
        Show Controls
    </button>
    <button onclick="deleteItem('{{ guid }}')" class="btn btn-danger">Delete Item</button>
</div>
{% endblock %}

{% block scripts %}
<script>
// Simple modal image viewer (fallback from PhotoSwipe)
function openImageModal(imageSrc, imageAlt) {
    // Create modal
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.9);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    `;
    
    // Create image
    const img = document.createElement('img');
    img.src = imageSrc;
    img.alt = imageAlt;
    img.style.cssText = `
        max-width: 95%;
        max-height: 95%;
        object-fit: contain;
        border-radius: 8px;
    `;
    
    // Close button
    const closeBtn = document.createElement('button');
    closeBtn.innerHTML = '√ó';
    closeBtn.style.cssText = `
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(255,255,255,0.8);
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        font-size: 24px;
        cursor: pointer;
        z-index: 10000;
    `;
    
    // Close functionality
    const closeModal = () => document.body.removeChild(modal);
    closeBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
    });
    
    // Add to page
    modal.appendChild(img);
    modal.appendChild(closeBtn);
    document.body.appendChild(modal);
}

// Add click handlers to image links
document.addEventListener('DOMContentLoaded', () => {
    const imageLinks = document.querySelectorAll('.image-gallery a');
    imageLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const imageSrc = link.href;
            const imageAlt = link.querySelector('img').alt;
            openImageModal(imageSrc, imageAlt);
        });
    });
});
</script>

<script>
// Image controls toggle functionality
function toggleControls() {
    const gallery = document.getElementById('image-gallery');
    const toggleBtn = document.getElementById('controls-toggle');
    
    if (gallery.classList.contains('controls-visible')) {
        // Hide controls
        gallery.classList.remove('controls-visible');
        toggleBtn.textContent = 'Show Controls';
        toggleBtn.classList.remove('active');
    } else {
        // Show controls
        gallery.classList.add('controls-visible');
        toggleBtn.textContent = 'Hide Controls';
        toggleBtn.classList.add('active');
    }
}

// Image controls
function deleteImage(imageId) {
    if (confirm('Delete this image?')) {
        fetch(`/delete-image/${imageId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Remove the image item from the page without reloading
                const imageItem = document.querySelector(`button[onclick*="${imageId}"]`).closest('.image-item');
                if (imageItem) {
                    imageItem.style.opacity = '0';
                    imageItem.style.transform = 'scale(0.8)';
                    setTimeout(() => {
                        imageItem.remove();
                    }, 300);
                }
            } else {
                alert('Delete failed: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Delete failed. Please try again.');
        });
    }
}

function deleteItem(itemGuid) {
    if (confirm('Delete this entire item and all its images?')) {
        fetch(`/delete-item/${itemGuid}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = '/';
            } else {
                alert('Delete failed: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Delete failed. Please try again.');
        });
    }
}

function rotateImage(imageId) {
    // Prevent double-clicks and event propagation
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    // Show loading state
    const btn = event.target;
    
    // Check if already processing
    if (btn.disabled) {
        return;
    }
    
    btn.textContent = '...';
    btn.disabled = true;
    
    fetch(`/rotate-image/${imageId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update the thumbnail without reloading the page
            const imgElement = btn.closest('.image-item').querySelector('img');
            if (imgElement) {
                // Force reload the thumbnail by adding a timestamp
                const thumbnailUrl = imgElement.src.split('?')[0];
                imgElement.src = thumbnailUrl + '?t=' + Date.now();
            }
            btn.textContent = '‚Üª';
            btn.disabled = false;
        } else {
            alert('Rotation failed: ' + (data.error || 'Unknown error'));
            btn.textContent = '‚Üª';
            btn.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Rotation failed. Please try again.');
        btn.textContent = '‚Üª';
        btn.disabled = false;
    });
}

// Drag and drop support
const uploadZone = document.getElementById('upload-zone');
const imageInput = document.getElementById('image-input');

['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    uploadZone.addEventListener(eventName, preventDefaults, false);
});

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

['dragenter', 'dragover'].forEach(eventName => {
    uploadZone.addEventListener(eventName, highlight, false);
});

['dragleave', 'drop'].forEach(eventName => {
    uploadZone.addEventListener(eventName, unhighlight, false);
});

function highlight(e) {
    uploadZone.classList.add('drag-over');
}

function unhighlight(e) {
    uploadZone.classList.remove('drag-over');
}

uploadZone.addEventListener('drop', handleDrop, false);

function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    
    if (files.length > 0) {
        imageInput.files = files;
        // Trigger the change event to auto-upload
        const event = new Event('change', { bubbles: true });
        imageInput.dispatchEvent(event);
    }
}

// Auto-upload when files are selected
imageInput.addEventListener('change', function() {
    if (this.files.length > 0) {
        // Show uploading status
        const label = uploadZone.querySelector('.file-label');
        label.textContent = `üì§ Uploading ${this.files.length} photo${this.files.length > 1 ? 's' : ''}...`;
        
        // Auto-submit the form for each file
        uploadMultipleFiles(this.files);
    }
});

async function uploadMultipleFiles(files) {
    const form = imageInput.closest('form');
    const formData = new FormData();
    const label = uploadZone.querySelector('.file-label');
    
    let uploaded = 0;
    const total = files.length;
    
    // Upload files sequentially to avoid overwhelming the server
    for (let i = 0; i < files.length && i < 5; i++) { // Limit to 5 files at a time
        const file = files[i];
        const newFormData = new FormData();
        newFormData.append('image', file);
        newFormData.append('description', ''); // Empty description
        
        try {
            label.textContent = `üì§ Uploading ${i + 1} of ${Math.min(total, 5)}...`;
            
            const response = await fetch(form.action, {
                method: 'POST',
                body: newFormData
            });
            
            if (response.ok) {
                uploaded++;
            }
        } catch (error) {
            console.error('Upload failed:', error);
        }
    }
    
    // Reload page to show new images
    if (uploaded > 0) {
        label.textContent = `‚úÖ Uploaded ${uploaded} photo${uploaded > 1 ? 's' : ''}!`;
        setTimeout(() => {
            window.location.reload();
        }, 1000);
    } else {
        label.textContent = '‚ùå Upload failed';
        setTimeout(() => {
            label.textContent = 'üì∑ Choose Photos';
        }, 2000);
    }
}

function updateFileLabel(filename) {
    const label = uploadZone.querySelector('.file-label');
    label.textContent = 'üì∑ ' + filename;
}

// Header name editing functions
function editHeaderName() {
    document.getElementById('header-name-display').style.display = 'none';
    document.getElementById('header-edit-name-form').style.display = 'flex';
    document.getElementById('header-edit-btn').style.display = 'none';
    document.getElementById('header-name-input').focus();
}

function cancelHeaderEditName() {
    document.getElementById('header-name-display').style.display = 'block';
    document.getElementById('header-edit-name-form').style.display = 'none';
    document.getElementById('header-edit-btn').style.display = 'block';
    // Reset input value
    const originalName = document.getElementById('header-name-display').textContent;
    document.getElementById('header-name-input').value = originalName;
}

function editHeaderLabel() {
    const labelDisplay = document.getElementById('header-label-display');
    const editForm = document.getElementById('header-edit-label-form');
    const editBtns = document.querySelector('.header-edit-btn').parentElement;
    
    if (labelDisplay) labelDisplay.style.display = 'none';
    editForm.style.display = 'flex';
    editBtns.style.display = 'none';
    document.getElementById('header-label-input').focus();
}

function cancelHeaderEditLabel() {
    const labelDisplay = document.getElementById('header-label-display');
    const editForm = document.getElementById('header-edit-label-form');
    const editBtns = document.querySelector('.header-edit-btn').parentElement;
    
    if (labelDisplay) labelDisplay.style.display = 'inline';
    editForm.style.display = 'none';
    editBtns.style.display = 'flex';
    
    // Reset input value
    const originalLabel = labelDisplay ? labelDisplay.textContent.replace('#', '') : '';
    document.getElementById('header-label-input').value = originalLabel;
}

// Handle header name edit form submission
document.getElementById('header-edit-name-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const newName = document.getElementById('header-name-input').value.trim();
    if (!newName) {
        alert('Name cannot be empty');
        return;
    }
    
    // Show loading state
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'Saving...';
    submitBtn.disabled = true;
    
    // Create form data
    const formData = new FormData();
    formData.append('item_name', newName);
    
    fetch(`/update-item-name/{{ guid }}`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update display
            document.getElementById('header-name-display').textContent = newName;
            // Also update page title
            document.title = newName;
            cancelHeaderEditName();
        } else {
            alert('Update failed: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Update failed. Please try again.');
    })
    .finally(() => {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    });
});

// Handle header label edit form submission
document.getElementById('header-edit-label-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const newLabel = document.getElementById('header-label-input').value.trim();
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    
    // Validate label number (should be numeric or empty)
    if (newLabel && !/^\d+$/.test(newLabel)) {
        alert('Label number must be numeric');
        return;
    }
    
    submitBtn.textContent = 'Saving...';
    submitBtn.disabled = true;
    
    // Submit the form
    const formData = new FormData();
    formData.append('label_number', newLabel);
    
    fetch(`/update-item-label/{{ guid }}`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update or create the label display
            const labelDisplay = document.getElementById('header-label-display');
            if (data.label_number) {
                if (labelDisplay) {
                    labelDisplay.textContent = `#${data.label_number}`;
                } else {
                    // Create the label display element
                    const headerTitle = document.getElementById('header-name-display');
                    const newLabelDisplay = document.createElement('span');
                    newLabelDisplay.id = 'header-label-display';
                    newLabelDisplay.style.cssText = 'background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 4px; font-size: 14px; font-weight: 500;';
                    newLabelDisplay.textContent = `#${data.label_number}`;
                    headerTitle.parentNode.insertBefore(newLabelDisplay, headerTitle.nextSibling);
                }
            } else {
                // Remove label display if number was cleared
                if (labelDisplay) {
                    labelDisplay.remove();
                }
            }
            cancelHeaderEditLabel();
        } else {
            alert('Update failed: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Update failed. Please try again.');
    })
    .finally(() => {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    });
});

// Tag deletion function
function deleteTag(categoryId, categoryName) {
    // Find the tag element
    const tagElement = document.getElementById(`tag-${categoryId}`);
    
    // Show loading state
    const deleteBtn = tagElement.querySelector('.tag-delete');
    deleteBtn.textContent = '...';
    deleteBtn.disabled = true;
    
    fetch(`/delete-category/${categoryId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove tag element with animation
            tagElement.style.opacity = '0';
            tagElement.style.transform = 'scale(0.8)';
            setTimeout(() => {
                tagElement.remove();
                
                // Check if tags section is empty
                const tagsList = document.querySelector('.tags-list');
                if (tagsList && tagsList.children.length === 0) {
                    const tagsSection = document.querySelector('.tags-section');
                    if (tagsSection) {
                        tagsSection.style.opacity = '0';
                        setTimeout(() => tagsSection.remove(), 300);
                    }
                }
            }, 300);
        } else {
            alert('Delete failed: ' + (data.error || 'Unknown error'));
            deleteBtn.textContent = '√ó';
            deleteBtn.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Delete failed. Please try again.');
        deleteBtn.textContent = '√ó';
        deleteBtn.disabled = false;
    });
}

// Set primary image function
function setPrimaryImage(imageId) {
    fetch(`/set-primary-image/${imageId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            alert('Failed to set primary image: ' + (data.error || 'Unknown error'));
            // Reset radio buttons to previous state
            location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to set primary image. Please try again.');
        location.reload();
    });
}

// Description editing functions
function editDescription() {
    document.getElementById('description-display').style.display = 'none';
    document.getElementById('edit-description-form').style.display = 'block';
    document.getElementById('edit-description-btn').style.display = 'none';
    document.getElementById('description-input').focus();
}

function cancelEditDescription() {
    document.getElementById('description-display').style.display = 'block';
    document.getElementById('edit-description-form').style.display = 'none';
    document.getElementById('edit-description-btn').style.display = 'block';
    // Reset textarea value
    const originalDescription = document.getElementById('description-display').querySelector('p').textContent;
    if (originalDescription !== 'No description added yet') {
        document.getElementById('description-input').value = originalDescription;
    } else {
        document.getElementById('description-input').value = '';
    }
}

// Handle description edit form submission
document.getElementById('edit-description-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const newDescription = document.getElementById('description-input').value.trim();
    
    // Show loading state
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'Saving...';
    submitBtn.disabled = true;
    
    // Create form data
    const formData = new FormData();
    formData.append('description', newDescription);
    
    fetch(`/update-item-description/{{ guid }}`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update display
            const displayElement = document.getElementById('description-display').querySelector('p');
            if (newDescription) {
                displayElement.textContent = newDescription;
                displayElement.classList.remove('empty-content');
            } else {
                displayElement.textContent = 'No description added yet';
                displayElement.classList.add('empty-content');
            }
            cancelEditDescription();
        } else {
            alert('Update failed: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Update failed. Please try again.');
    })
    .finally(() => {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    });
});

// Move item functions
function removeFromContainer() {
    if (!confirm('Remove this item from its current container?')) {
        return;
    }
    
    fetch(`/set-parent/{{ guid }}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ parent_guid: '' }) // Empty parent_guid removes the parent relationship
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Failed to remove from container: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to remove from container. Please try again.');
    });
}

// Autocomplete functionality
let autocompleteTimeout;
let selectedIndex = -1;
let autocompleteResults = [];

const searchInput = document.getElementById('parent-search-input');
const guidInput = document.getElementById('parent-guid-input');
const dropdown = document.getElementById('autocomplete-dropdown');
const moveBtn = document.getElementById('move-item-btn');

function showAutocomplete() {
    dropdown.classList.add('show');
}

function hideAutocomplete() {
    dropdown.classList.remove('show');
    selectedIndex = -1;
}

function renderAutocompleteResults(results) {
    if (results.length === 0) {
        dropdown.innerHTML = '<div class="autocomplete-no-results">No items found</div>';
        showAutocomplete();
        return;
    }
    
    dropdown.innerHTML = results.map((item, index) => `
        <div class="autocomplete-item ${index === selectedIndex ? 'selected' : ''}" 
             data-guid="${item.guid}" 
             data-name="${item.name}"
             data-index="${index}">
            ${item.has_image ? 
                `<img src="/thumbnail/${item.image_id}" alt="${item.name}" class="autocomplete-item-thumbnail">` :
                `<div class="autocomplete-item-thumbnail" style="display: flex; align-items: center; justify-content: center; font-size: 16px; color: #adb5bd;">üì¶</div>`
            }
            <div class="autocomplete-item-info">
                <div class="autocomplete-item-name">${item.name}</div>
                <div class="autocomplete-item-meta">
                    ${item.contained_count > 0 ? `Contains ${item.contained_count} item${item.contained_count !== 1 ? 's' : ''}` : 'Empty container'}
                    ${item.matched_tags ? ` ‚Ä¢ Tags: ${item.matched_tags}` : ''}
                </div>
            </div>
        </div>
    `).join('');
    
    showAutocomplete();
    
    // Add click handlers
    dropdown.querySelectorAll('.autocomplete-item').forEach(item => {
        item.addEventListener('click', function() {
            selectAutocompleteItem(this.dataset.guid, this.dataset.name);
        });
    });
}

function selectAutocompleteItem(guid, name) {
    searchInput.value = name;
    guidInput.value = guid;
    moveBtn.disabled = false;
    hideAutocomplete();
}

// Search input handlers
searchInput.addEventListener('input', function() {
    const query = this.value.trim();
    
    if (!query || query.length < 2) {
        hideAutocomplete();
        guidInput.value = '';
        moveBtn.disabled = true;
        return;
    }
    
    // Clear previous timeout
    clearTimeout(autocompleteTimeout);
    
    // Show loading state
    dropdown.innerHTML = '<div class="autocomplete-loading">Searching...</div>';
    showAutocomplete();
    
    // Debounce the search
    autocompleteTimeout = setTimeout(() => {
        fetch(`/search-items?q=${encodeURIComponent(query)}&exclude={{ guid }}`)
            .then(response => response.json())
            .then(results => {
                autocompleteResults = results;
                renderAutocompleteResults(results);
            })
            .catch(error => {
                console.error('Search error:', error);
                dropdown.innerHTML = '<div class="autocomplete-no-results">Search failed</div>';
            });
    }, 300);
});

// Keyboard navigation
searchInput.addEventListener('keydown', function(e) {
    const items = dropdown.querySelectorAll('.autocomplete-item');
    
    if (e.key === 'ArrowDown') {
        e.preventDefault();
        selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
        updateSelection(items);
    } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        selectedIndex = Math.max(selectedIndex - 1, -1);
        updateSelection(items);
    } else if (e.key === 'Enter' && selectedIndex >= 0) {
        e.preventDefault();
        const selected = autocompleteResults[selectedIndex];
        if (selected) {
            selectAutocompleteItem(selected.guid, selected.name);
        }
    } else if (e.key === 'Escape') {
        hideAutocomplete();
    }
});

function updateSelection(items) {
    items.forEach((item, index) => {
        item.classList.toggle('selected', index === selectedIndex);
    });
}

// Hide dropdown when clicking outside
document.addEventListener('click', function(e) {
    if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
        hideAutocomplete();
    }
});

// Handle move item form submission
document.getElementById('move-item-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const parentGuid = guidInput.value.trim();
    if (!parentGuid) {
        alert('Please select a container from the search results');
        return;
    }
    
    // Check if trying to move item into itself
    if (parentGuid.toLowerCase() === '{{ guid }}'.toLowerCase()) {
        alert('Cannot move an item into itself!');
        return;
    }
    
    // Show loading state
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'Moving...';
    submitBtn.disabled = true;
    
    // Create JSON data
    fetch(`/set-parent/{{ guid }}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ parent_guid: parentGuid })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Failed to move item: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to move item. Please try again.');
    })
    .finally(() => {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    });
});

// QR Code Association Functions
{% if show_association %}
// Association banner stays visible until user interaction - no auto-hide timer

function showAssociationSearch() {
    document.getElementById('association-banner').classList.add('interacted');
    document.querySelector('.association-banner-actions').style.display = 'none';
    document.getElementById('association-search').style.display = 'block';
    document.getElementById('association-search-input').focus();
    
    // Initialize association autocomplete
    initAssociationAutocomplete();
}

function dismissAssociation() {
    document.getElementById('association-banner').style.display = 'none';
}

function cancelAndDelete() {
    // No confirmation - just do it
    const banner = document.getElementById('association-banner');
    banner.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="loading"></div><p>Cancelling...</p></div>';
    
    fetch(`/delete-item/{{ guid }}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.href = '/';
        } else {
            // Silent fail - just go home
            window.location.href = '/';
        }
    })
    .catch(error => {
        // Silent fail - just go home
        window.location.href = '/';
    });
}

function cancelAssociation() {
    document.getElementById('association-search').style.display = 'none';
    document.querySelector('.association-banner-actions').style.display = 'flex';
}

// Association autocomplete
let associationTimeout;
let associationResults = [];
let associationSelectedIndex = -1;

function initAssociationAutocomplete() {
    const input = document.getElementById('association-search-input');
    const dropdown = document.getElementById('association-autocomplete-dropdown');
    
    input.addEventListener('input', function() {
        const query = this.value.trim();
        
        if (!query || query.length < 2) {
            dropdown.classList.remove('show');
            return;
        }
        
        clearTimeout(associationTimeout);
        
        // Show loading state
        dropdown.innerHTML = '<div class="autocomplete-loading">Searching...</div>';
        dropdown.classList.add('show');
        
        // Debounce search
        associationTimeout = setTimeout(() => {
            fetch(`/search-items?q=${encodeURIComponent(query)}&exclude={{ guid }}`)
                .then(response => response.json())
                .then(results => {
                    associationResults = results;
                    renderAssociationResults(results);
                })
                .catch(error => {
                    console.error('Search error:', error);
                    dropdown.classList.remove('show');
                });
        }, 300);
    });
    
    input.addEventListener('keydown', function(e) {
        const items = dropdown.querySelectorAll('.autocomplete-item');
        
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            associationSelectedIndex = Math.min(associationSelectedIndex + 1, items.length - 1);
            updateAssociationSelection(items);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            associationSelectedIndex = Math.max(associationSelectedIndex - 1, -1);
            updateAssociationSelection(items);
        } else if (e.key === 'Enter' && associationSelectedIndex >= 0) {
            e.preventDefault();
            const selected = associationResults[associationSelectedIndex];
            if (selected) {
                associateWithItem(selected.guid, selected.name);
            }
        } else if (e.key === 'Escape') {
            dropdown.classList.remove('show');
        }
    });
}

function renderAssociationResults(results) {
    const dropdown = document.getElementById('association-autocomplete-dropdown');
    
    if (results.length === 0) {
        dropdown.innerHTML = '<div class="autocomplete-no-results">No items found</div>';
        return;
    }
    
    dropdown.innerHTML = results.map((item, index) => `
        <div class="autocomplete-item ${index === associationSelectedIndex ? 'selected' : ''}" 
             onclick="associateWithItem('${item.guid}', '${item.name.replace(/'/g, "\\'")}')"
             data-index="${index}">
            <div class="autocomplete-item-name">${item.name}</div>
            ${item.matched_tags ? `<div class="autocomplete-item-tags">Tags: ${item.matched_tags}</div>` : ''}
            ${item.contained_count > 0 ? `<div class="autocomplete-item-meta">${item.contained_count} item${item.contained_count !== 1 ? 's' : ''} inside</div>` : ''}
        </div>
    `).join('');
}

function updateAssociationSelection(items) {
    items.forEach((item, index) => {
        item.classList.toggle('selected', index === associationSelectedIndex);
    });
}

function associateWithItem(targetGuid, targetName) {
    if (confirm(`Associate this QR code with "${targetName}"?`)) {
        // Show loading state
        const banner = document.getElementById('association-banner');
        banner.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="loading"></div><p>Associating QR code...</p></div>';
        
        fetch(`/associate-item/{{ guid }}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ target_guid: targetGuid })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = data.redirect;
            } else {
                alert('Failed to associate: ' + (data.error || 'Unknown error'));
                location.reload();
            }
        })
        .catch(error => {
            console.error('Association error:', error);
            alert('Failed to associate. Please try again.');
            location.reload();
        });
    }
}
{% endif %}
</script>
{% endblock %}