{% extends "base.html" %}

{% block title %}Inventory - Home{% endblock %}

{% block extra_head %}
<script src="https://unpkg.com/qr-scanner@1.4.2/qr-scanner.umd.min.js"></script>
{% endblock %}

{% block styles %}
<style>
    /* Home Specific Styles */
    .app-header-content {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .header-search-input-group {
        position: relative;
        flex: 1;
    }
    
    .header-search-input {
        width: 100%;
        padding: 10px 12px 10px 36px;
        border: none;
        border-radius: 8px;
        background: rgba(255,255,255,0.15);
        font-size: 16px;
        color: white;
        -webkit-appearance: none;
    }
    
    .header-search-input::placeholder {
        color: rgba(255,255,255,0.7);
    }
    
    .header-search-input:focus {
        outline: none;
        background: rgba(255,255,255,0.25);
    }
    
    .header-search-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: rgba(255,255,255,0.8);
        pointer-events: none;
        font-size: 14px;
    }
    
    .header-scan-btn {
        background: rgba(255,255,255,0.15);
        border: none;
        border-radius: 8px;
        padding: 10px 12px;
        color: white;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .header-scan-btn:hover {
        background: rgba(255,255,255,0.25);
    }
    
    .header-scan-btn:active {
        transform: scale(0.95);
    }
    
    /* Home Page Autocomplete Styles */
    .home-autocomplete-wrapper {
        position: relative;
    }
    
    .home-autocomplete-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-radius: 12px;
        margin-top: 8px;
        max-height: 400px;
        overflow-y: auto;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 2000;
        display: none;
    }
    
    .home-autocomplete-dropdown.show {
        display: block;
    }
    
    .home-autocomplete-item {
        padding: 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 12px;
        border-bottom: 1px solid #f0f0f0;
        transition: background-color 0.2s;
    }
    
    .home-autocomplete-item:last-child {
        border-bottom: none;
    }
    
    .home-autocomplete-item:hover,
    .home-autocomplete-item.selected {
        background-color: #f8f9fa;
    }
    
    .home-autocomplete-item-thumbnail {
        width: 48px;
        height: 48px;
        object-fit: cover;
        border-radius: 8px;
        background: #e9ecef;
        flex-shrink: 0;
    }
    
    .home-autocomplete-item-info {
        flex: 1;
        min-width: 0;
    }
    
    .home-autocomplete-item-name {
        font-weight: 600;
        color: #333;
        margin-bottom: 4px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        font-size: 16px;
    }
    
    .home-autocomplete-item-meta {
        font-size: 14px;
        color: #666;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .home-autocomplete-no-results {
        padding: 20px;
        text-align: center;
        color: #999;
        font-style: italic;
    }
    
    .home-autocomplete-loading {
        padding: 20px;
        text-align: center;
        color: #666;
    }
    
    .action-buttons {
        display: flex;
        gap: 12px;
        margin-top: 16px;
    }
    
    .action-btn {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 16px;
        background: #f8f9fa;
        border: none;
        border-radius: 12px;
        text-decoration: none;
        color: #333;
        transition: all 0.2s;
        min-height: 80px;
    }
    
    .action-btn:active {
        transform: scale(0.96);
        background: #e9ecef;
    }
    
    .action-btn-icon {
        font-size: 28px;
        margin-bottom: 4px;
    }
    
    .action-btn-text {
        font-size: 13px;
        font-weight: 500;
    }
    
    /* Items List */
    .items-header {
        padding: 12px 16px 8px;
        background: #f8f9fa;
        border-bottom: 1px solid #eee;
        margin: 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .items-list {
        margin-top: 0;
    }
    
    .items-header h3 {
        font-size: 14px;
        font-weight: 600;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin: 0;
    }
    
    .view-toggle {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .toggle-switch {
        position: relative;
        width: 48px;
        height: 24px;
        background: #ddd;
        border-radius: 12px;
        cursor: pointer;
        transition: background 0.3s;
    }
    
    .toggle-switch.active {
        background: #007bff;
    }
    
    .toggle-switch::after {
        content: '';
        position: absolute;
        top: 2px;
        left: 2px;
        width: 20px;
        height: 20px;
        background: white;
        border-radius: 50%;
        transition: transform 0.3s;
    }
    
    .toggle-switch.active::after {
        transform: translateX(24px);
    }
    
    .toggle-label {
        font-size: 12px;
        color: #666;
        font-weight: 500;
    }
    
    .items-count {
        font-weight: normal;
        color: #999;
    }
    
    .items-list {
        background: white;
    }
    
    .item-card {
        display: block;
        padding: 16px;
        border-bottom: 1px solid #eee;
        text-decoration: none;
        color: inherit;
        transition: background 0.2s;
        position: relative;
    }
    
    .item-card:active {
        background: #f8f9fa;
    }
    
    .item-card-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
    }
    
    .item-info {
        flex: 1;
    }
    
    .item-name {
        font-size: 16px;
        font-weight: 600;
        color: #333;
        margin-bottom: 2px;
    }
    
    .item-guid {
        font-family: 'SF Mono', Monaco, monospace;
        font-size: 11px;
        color: #999;
        margin-bottom: 4px;
    }
    
    .item-meta {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 12px;
        color: #999;
    }
    
    .item-stat {
        display: flex;
        align-items: center;
        gap: 4px;
    }
    
    .item-thumbnail {
        width: 60px;
        height: 60px;
        border-radius: 8px;
        object-fit: cover;
        background: #f0f0f0;
        flex-shrink: 0;
    }
    
    .item-placeholder {
        width: 60px;
        height: 60px;
        border-radius: 8px;
        background: #f0f0f0;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #999;
        font-size: 24px;
        flex-shrink: 0;
    }
    
    .item-arrow {
        color: #ccc;
        font-size: 20px;
        flex-shrink: 0;
    }
    
    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #999;
    }
    
    .empty-icon {
        font-size: 64px;
        margin-bottom: 16px;
        opacity: 0.3;
    }
    
    .empty-text {
        font-size: 16px;
        margin-bottom: 8px;
    }
    
    .empty-subtext {
        font-size: 14px;
        color: #bbb;
    }
    
    /* QR Scanner Modal */
    .scanner-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.9);
        z-index: 2000;
        display: none;
        flex-direction: column;
    }
    
    .scanner-modal.active {
        display: flex;
    }
    
    .scanner-header {
        background: black;
        color: white;
        padding: env(safe-area-inset-top) 16px 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .scanner-header h2 {
        font-size: 18px;
        margin: 0;
    }
    
    .scanner-controls {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .flashlight-btn {
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        color: white;
        font-size: 18px;
        width: 40px;
        height: 40px;
        display: none; /* Hidden by default until we check support */
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .flashlight-btn:hover {
        background: rgba(255, 255, 255, 0.3);
    }
    
    .flashlight-btn.active {
        background: #ffd700;
        color: #000;
        box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
    }
    
    .scanner-close {
        background: none;
        border: none;
        color: white;
        font-size: 16px;
        padding: 8px;
    }
    
    .scanner-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }
    
    .scanner-video {
        width: 100%;
        max-width: 400px;
        border-radius: 12px;
        overflow: hidden;
    }
    
    .scanner-info {
        color: white;
        text-align: center;
        margin-top: 20px;
        font-size: 14px;
    }
    
    .scanner-error {
        background: #dc3545;
        color: white;
        padding: 16px;
        border-radius: 8px;
        margin: 20px;
        text-align: center;
    }
    
    /* Health Links (for dev) */
    .dev-links {
        padding: 20px;
        text-align: center;
        border-top: 1px solid #eee;
        background: #f8f9fa;
    }
    
    /* Quick Start Guide Modal */
    .modal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
    }
    
    .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 0;
        border-radius: 16px;
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 24px;
        border-bottom: 1px solid #eee;
        background: #f8f9fa;
        border-radius: 16px 16px 0 0;
    }
    
    .modal-header h2 {
        margin: 0;
        color: #333;
        font-size: 20px;
    }
    
    .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #666;
        padding: 4px;
        border-radius: 4px;
        transition: background 0.2s;
    }
    
    .modal-close:hover {
        background: #e9ecef;
    }
    
    .modal-body {
        padding: 24px;
    }
    
    .quick-start-section {
        margin-bottom: 24px;
    }
    
    .quick-start-section:last-child {
        margin-bottom: 0;
    }
    
    .quick-start-section h3 {
        color: #333;
        margin-bottom: 12px;
        font-size: 18px;
    }
    
    .quick-start-section p {
        color: #666;
        line-height: 1.6;
        margin-bottom: 12px;
    }
    
    .quick-start-section ol,
    .quick-start-section ul {
        color: #666;
        line-height: 1.6;
        padding-left: 20px;
    }
    
    .quick-start-section li {
        margin-bottom: 8px;
    }
    
    .quick-start-section strong {
        color: #333;
    }
    
    .dev-links a {
        color: #007bff;
        text-decoration: none;
        font-size: 14px;
        margin: 0 8px;
        white-space: nowrap;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }
    
    /* Tree View Styles */
    .tree-view {
        background: white;
        display: none;
    }
    
    .tree-view.active {
        display: block;
    }
    
    .tree-item {
        border-bottom: 1px solid #eee;
    }
    
    .tree-item-content {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        cursor: pointer;
        transition: background 0.2s;
    }
    
    .tree-item-content:hover {
        background: #f8f9fa;
    }
    
    .tree-item-content:active {
        background: #e9ecef;
    }
    
    .tree-indent {
        width: 20px; /* Each level adds 20px indent */
        flex-shrink: 0;
    }
    
    .tree-expand-icon {
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 8px;
        color: #666;
        font-size: 12px;
        flex-shrink: 0;
        cursor: pointer;
    }
    
    .tree-expand-icon.expandable {
        color: #007bff;
    }
    
    .tree-expand-icon.expandable:hover {
        background: rgba(0, 123, 255, 0.1);
        border-radius: 4px;
    }
    
    .tree-item-thumbnail {
        width: 40px;
        height: 40px;
        border-radius: 6px;
        object-fit: cover;
        background: #f0f0f0;
        flex-shrink: 0;
        margin-right: 12px;
    }
    
    .tree-item-placeholder {
        width: 40px;
        height: 40px;
        border-radius: 6px;
        background: #f0f0f0;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #999;
        font-size: 16px;
        flex-shrink: 0;
        margin-right: 12px;
    }
    
    .tree-item-info {
        flex: 1;
        min-width: 0;
    }
    
    .tree-item-name {
        font-size: 15px;
        font-weight: 500;
        color: #333;
        margin-bottom: 2px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .tree-item-meta {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 11px;
        color: #999;
    }
    
    .tree-item-stat {
        display: flex;
        align-items: center;
        gap: 2px;
    }
    
    .tree-item-arrow {
        color: #ccc;
        font-size: 16px;
        flex-shrink: 0;
        margin-left: 8px;
    }
    
    .tree-children {
        display: none;
    }
    
    .tree-children.expanded {
        display: block;
    }
    
    .tree-loading {
        padding: 16px;
        text-align: center;
        color: #666;
        font-style: italic;
    }
</style>
{% endblock %}

{% block app_content %}
<!-- App Header with Integrated Search -->
<header class="app-header">
    <div class="app-header-content">
        <h1>Inventory</h1>
        <form method="POST" action="/process-guid" id="search-form" style="flex: 1; margin: 0 16px;">
            <div class="home-autocomplete-wrapper">
                <div class="header-search-input-group">
                    <span class="header-search-icon">üîç</span>
                    <input type="text" 
                           id="search-input" 
                           name="guid" 
                           class="header-search-input" 
                           placeholder="Search or scan..." 
                           autocomplete="off"
                           autocorrect="off"
                           spellcheck="false">
                </div>
                <div id="home-autocomplete-dropdown" class="home-autocomplete-dropdown"></div>
            </div>
        </form>
        <button onclick="createNewItem()" class="header-scan-btn" title="Create New Item">‚ûï</button>
        <button onclick="openScanner()" class="header-scan-btn" title="Scan QR Code">üì∑</button>
    </div>
</header>

<!-- Main Content -->
<div class="app-content" style="padding-top: 0;">
    <!-- Items List -->
    <div class="items-header">
        <h3>Recent Items <span class="items-count">({{ items|length }})</span></h3>
        <div class="view-toggle">
            <span class="toggle-label">List</span>
            <div class="toggle-switch" id="view-toggle" onclick="toggleView()"></div>
            <span class="toggle-label">Tree</span>
        </div>
    </div>
    
    <div class="items-list">
        {% if items %}
            {% for item in items %}
            <a href="/item/{{ item[0] }}" class="item-card">
                <div class="item-card-content">
                    {% if item[5] %}
                        <img src="/thumbnail/{{ item[5] }}" alt="Thumbnail" class="item-thumbnail" loading="lazy">
                    {% else %}
                        <div class="item-placeholder">üì∑</div>
                    {% endif %}
                    <div class="item-info">
                        <div class="item-name">{{ item[1] or ('Item ' + item[0][:8]) }}</div>
                        <div class="item-guid">{{ item[0][:8] }}...</div>
                        <div class="item-meta">
                            {% if item[6] %}
                            <span class="item-stat" style="font-weight: 600; color: #007bff;">
                                <span>#{{ item[6] }}</span>
                            </span>
                            {% endif %}
                            <span class="item-stat">
                                <span>üì∑</span>
                                <span>{{ item[3] }}</span>
                            </span>
                            <span class="item-stat">
                                <span>üìù</span>
                                <span>{{ item[4] }}</span>
                            </span>
                            <span class="item-stat">
                                <span>üìÖ</span>
                                <span>{{ item[2].strftime('%b %d') if item[2] else 'Unknown' }}</span>
                            </span>
                        </div>
                    </div>
                    <span class="item-arrow">‚Ä∫</span>
                </div>
            </a>
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <div class="empty-icon">üì¶</div>
                <div class="empty-text">No items yet</div>
                <div class="empty-subtext">Search or scan to add your first item</div>
            </div>
        {% endif %}
    </div>
    
    <!-- Tree View -->
    <div class="tree-view" id="tree-view">
        <div class="tree-loading" id="tree-loading">Loading tree structure...</div>
        <div id="tree-container"></div>
    </div>
    
    <!-- Dev Links -->
    <div class="dev-links">
        <a href="/system-status">üöÄ System Status</a>
        <a href="/db-stats">üìä Inventory Stats</a>
        <a href="/admin">üõ†Ô∏è Admin</a>
        <!-- <a href="/print/inventory-list">üñ®Ô∏è Print List</a>  COMMENTED OUT - BROKE NETWORK -->
        <!-- <a href="/print/qr-codes">üì± Print QR Codes</a>  COMMENTED OUT - BROKE NETWORK -->
        <a href="#" onclick="showQuickStartGuide()">üìñ Quick Start</a>
    </div>
</div>

<!-- QR Scanner Modal -->
<div id="scanner-modal" class="scanner-modal">
    <div class="scanner-header">
        <h2>Scan QR Code</h2>
        <div class="scanner-controls">
            <button id="flashlight-btn" onclick="toggleFlashlight()" class="flashlight-btn" title="Toggle Flashlight">
                üî¶
            </button>
            <button onclick="closeScanner()" class="scanner-close">‚úï</button>
        </div>
    </div>
    <div class="scanner-content">
        <video id="scanner-video" class="scanner-video"></video>
        <div class="scanner-info">Position QR code within the frame</div>
    </div>
</div>

<!-- Quick Start Guide Modal -->
<div id="quick-start-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üìñ Quick Start Guide</h2>
            <button onclick="closeQuickStartGuide()" class="modal-close">‚úï</button>
        </div>
        <div class="modal-body">
            <div class="quick-start-section">
                <h3>üöÄ Getting Started</h3>
                <p>Welcome to your Inventory Management System! Here's how to get started:</p>
            </div>
            
            <div class="quick-start-section">
                <h3>‚ûï Adding Items</h3>
                <ol>
                    <li><strong>Click the + button</strong> in the top right corner to add a new item</li>
                    <li><strong>Edit the title</strong> if you wish (items are automatically named "Item_1", "Item_2", etc.)</li>
                    <li><strong>Add a description</strong> using the pencil icon</li>
                    <li><strong>Take a photo</strong> by clicking "Add photo" to capture what you're inventorying</li>
                </ol>
            </div>
            
            <div class="quick-start-section">
                <h3>üí° Pro Tips</h3>
                <ul>
                    <li><strong>Voice-to-Text:</strong> We recommend using <strong>Whisper Flow</strong> as a tool to add text to descriptions without typing</li>
                    <li><strong>Smart Search:</strong> The system includes comprehensive semantic search - try searching for "camping items" to find tents, sleeping bags, and related gear</li>
                    <li><strong>Organize:</strong> Use the tree view to organize items into categories and subcategories</li>
                    <li><strong>QR Codes:</strong> Generate QR codes for items to quickly access them later</li>
                </ul>
            </div>
            
            <div class="quick-start-section">
                <h3>üîç Search Examples</h3>
                <p>Try these search terms to see semantic search in action:</p>
                <ul>
                    <li>"electronics" ‚Üí finds phones, laptops, chargers</li>
                    <li>"outdoor gear" ‚Üí finds tents, hiking boots, camping equipment</li>
                    <li>"kitchen items" ‚Üí finds pots, pans, utensils</li>
                    <li>"tools" ‚Üí finds hammers, screwdrivers, power tools</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let qrScanner = null;

function openScanner() {
    const modal = document.getElementById('scanner-modal');
    const video = document.getElementById('scanner-video');
    
    modal.classList.add('active');
    
    // Check if QrScanner is loaded
    if (typeof QrScanner === 'undefined') {
        showScannerError('QR Scanner not loaded. Please refresh the page.');
        return;
    }
    
    // Initialize scanner with optimized settings for small QR codes
    qrScanner = new QrScanner(
        video,
        result => {
            console.log('QR Code detected:', result.data);
            handleQRCode(result.data);
        },
        {
            onDecodeError: error => {
                // This is normal when no QR code is in view
                console.log('Scanning...');
            },
            preferredCamera: 'environment',
            highlightScanRegion: true,
            highlightCodeOutline: true,
            maxScansPerSecond: 5,  // Increase scan frequency for small codes
            returnDetailedScanResult: false,
            calculateScanRegion: (video) => {
                // Smaller scan region for better focus on small codes
                const smallerRegion = Math.min(video.videoWidth, video.videoHeight) * 0.6;
                return {
                    x: Math.round((video.videoWidth - smallerRegion) / 2),
                    y: Math.round((video.videoHeight - smallerRegion) / 2),
                    width: Math.round(smallerRegion),
                    height: Math.round(smallerRegion),
                };
            }
        }
    );
    
    // Start scanning with camera constraints for better focus
    qrScanner.start().then(() => {
        // Apply camera constraints for better focus on small objects
        const stream = video.srcObject;
        if (stream) {
            const videoTrack = stream.getVideoTracks()[0];
            if (videoTrack) {
                // Store video track for flashlight control
                currentVideoTrack = videoTrack;
                
                // Check if flashlight is supported and show/hide button accordingly
                const flashlightBtn = document.getElementById('flashlight-btn');
                if (flashlightBtn) {
                    if (videoTrack.getCapabilities && videoTrack.getCapabilities().torch) {
                        flashlightBtn.style.display = 'flex';
                        flashlightBtn.title = 'Toggle Flashlight';
                    } else {
                        flashlightBtn.style.display = 'none';
                        console.log('Flashlight not supported on this device');
                    }
                }
                
                // Apply constraints for better close-up focus
                const constraints = {
                    focusMode: 'continuous',
                    focusDistance: 0.1,  // Focus closer for small QR codes
                    advanced: [
                        { focusMode: 'continuous' },
                        { focusDistance: { min: 0.1, max: 1.0 } },
                        { exposureMode: 'continuous' },
                        { whiteBalanceMode: 'continuous' }
                    ]
                };
                
                videoTrack.applyConstraints({ video: constraints }).catch(err => {
                    console.log('Focus constraints not supported:', err);
                    // Try simpler constraints
                    videoTrack.applyConstraints({
                        video: {
                            focusMode: 'continuous',
                            exposureMode: 'continuous'
                        }
                    }).catch(err2 => {
                        console.log('Basic constraints not supported:', err2);
                    });
                });
                
                // Manually trigger focus sweep every 2 seconds for small QR codes
                const focusSweepInterval = setInterval(() => {
                    if (!qrScanner || !qrScanner._active) {
                        clearInterval(focusSweepInterval);
                        return;
                    }
                    
                    // Cycle through different focus distances to help find small codes
                    const focusDistances = [0.1, 0.3, 0.5, 0.1]; // Close, medium-close, medium, back to close
                    const currentTime = Date.now();
                    const cycleIndex = Math.floor((currentTime / 2000) % focusDistances.length);
                    
                    videoTrack.applyConstraints({
                        video: {
                            focusMode: 'manual',
                            focusDistance: focusDistances[cycleIndex]
                        }
                    }).then(() => {
                        // After manual focus, switch back to continuous
                        setTimeout(() => {
                            if (qrScanner && qrScanner._active) {
                                videoTrack.applyConstraints({
                                    video: { focusMode: 'continuous' }
                                }).catch(() => {});
                            }
                        }, 500);
                    }).catch(() => {
                        // Manual focus not supported, just continue
                    });
                }, 2000);
                
                // Store interval for cleanup
                qrScanner._focusInterval = focusSweepInterval;
            }
        }
    }).catch(err => {
        console.error('Failed to start scanner:', err);
        showScannerError('Failed to access camera. Please check permissions.');
    });
}

function closeScanner() {
    const modal = document.getElementById('scanner-modal');
    modal.classList.remove('active');
    
    // Turn off flashlight if it's on
    if (flashlightEnabled && currentVideoTrack) {
        try {
            currentVideoTrack.applyConstraints({
                advanced: [{ torch: false }]
            }).catch(err => {
                console.log('Failed to turn off flashlight on close:', err);
            });
        } catch (err) {
            console.log('Error turning off flashlight on close:', err);
        }
        flashlightEnabled = false;
        const flashlightBtn = document.getElementById('flashlight-btn');
        if (flashlightBtn) {
            flashlightBtn.classList.remove('active');
            flashlightBtn.textContent = 'üî¶';
        }
    }
    
    if (qrScanner) {
        // Clear focus sweep interval
        if (qrScanner._focusInterval) {
            clearInterval(qrScanner._focusInterval);
            qrScanner._focusInterval = null;
        }
        qrScanner.stop();
        qrScanner = null;
    }
    
    // Clear video track reference
    currentVideoTrack = null;
}

function handleQRCode(data) {
    // Extract GUID from QR data
    const guidPattern = /[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/i;
    const match = data.match(guidPattern);
    
    if (match) {
        // Close scanner
        closeScanner();
        
        // Fill form and submit
        document.getElementById('search-input').value = data;
        document.getElementById('search-form').submit();
    } else {
        showScannerError('Invalid QR code format');
        setTimeout(() => {
            // Resume scanning
            if (qrScanner) {
                const errorEl = document.querySelector('.scanner-error');
                if (errorEl) errorEl.remove();
            }
        }, 3000);
    }
}

function showScannerError(message) {
    const content = document.querySelector('.scanner-content');
    const existingError = content.querySelector('.scanner-error');
    
    if (existingError) {
        existingError.textContent = message;
    } else {
        const error = document.createElement('div');
        error.className = 'scanner-error';
        error.textContent = message;
        content.appendChild(error);
    }
}

// Flashlight functionality
let currentVideoTrack = null;
let flashlightEnabled = false;

function toggleFlashlight() {
    const flashlightBtn = document.getElementById('flashlight-btn');
    
    if (!currentVideoTrack) {
        console.log('No video track available for flashlight');
        return;
    }
    
    // Check if torch is supported
    if (!currentVideoTrack.getCapabilities || !currentVideoTrack.getCapabilities().torch) {
        console.log('Flashlight/torch not supported on this device');
        showScannerError('Flashlight not supported on this device');
        return;
    }
    
    try {
        if (flashlightEnabled) {
            // Turn off flashlight
            currentVideoTrack.applyConstraints({
                advanced: [{ torch: false }]
            }).then(() => {
                flashlightEnabled = false;
                flashlightBtn.classList.remove('active');
                flashlightBtn.textContent = 'üî¶';
                console.log('Flashlight turned off');
            }).catch(err => {
                console.error('Failed to turn off flashlight:', err);
            });
        } else {
            // Turn on flashlight
            currentVideoTrack.applyConstraints({
                advanced: [{ torch: true }]
            }).then(() => {
                flashlightEnabled = true;
                flashlightBtn.classList.add('active');
                flashlightBtn.textContent = 'üí°';
                console.log('Flashlight turned on');
            }).catch(err => {
                console.error('Failed to turn on flashlight:', err);
                showScannerError('Failed to enable flashlight');
            });
        }
    } catch (err) {
        console.error('Flashlight toggle error:', err);
        showScannerError('Flashlight not available');
    }
}

// Home page autocomplete functionality
let homeAutocompleteTimeout;
let homeSelectedIndex = -1;
let homeAutocompleteResults = [];

const homeSearchInput = document.getElementById('search-input');
const homeDropdown = document.getElementById('home-autocomplete-dropdown');

function showHomeAutocomplete() {
    homeDropdown.classList.add('show');
}

function hideHomeAutocomplete() {
    homeDropdown.classList.remove('show');
    homeSelectedIndex = -1;
}

function renderHomeAutocompleteResults(results) {
    if (results.length === 0) {
        hideHomeAutocomplete();
        return;
    }
    
    homeDropdown.innerHTML = results.map((item, index) => `
        <div class="home-autocomplete-item ${index === homeSelectedIndex ? 'selected' : ''}" 
             data-guid="${item.guid}" 
             data-name="${item.name}"
             data-index="${index}">
            ${item.has_image ? 
                `<img src="/thumbnail/${item.image_id}" alt="${item.name}" class="home-autocomplete-item-thumbnail">` :
                `<div class="home-autocomplete-item-thumbnail" style="display: flex; align-items: center; justify-content: center; font-size: 20px; color: #adb5bd;">üì¶</div>`
            }
            <div class="home-autocomplete-item-info">
                <div class="home-autocomplete-item-name">${item.name}</div>
                <div class="home-autocomplete-item-meta">
                    ${item.label_number ? `<span style="font-weight: 600; color: #007bff;">#${item.label_number}</span>` : ''}
                    <span>${item.contained_count > 0 ? `${item.contained_count} item${item.contained_count !== 1 ? 's' : ''} inside` : 'Empty'}</span>
                    ${item.matched_tags ? `<span>‚Ä¢ Tags: ${item.matched_tags}</span>` : ''}
                    ${item.description && item.description.length > 0 ? `<span>‚Ä¢ ${item.description.substring(0, 50)}${item.description.length > 50 ? '...' : ''}</span>` : ''}
                    ${item.similarity !== undefined && item.match_type === 'semantic' ? `<span>‚Ä¢ ${Math.round(item.similarity * 100)}% match</span>` : ''}
                    <span>‚Ä¢ Click to view</span>
                </div>
            </div>
        </div>
    `).join('');
    
    showHomeAutocomplete();
    
    // Add click handlers
    homeDropdown.querySelectorAll('.home-autocomplete-item').forEach(item => {
        item.addEventListener('click', function() {
            navigateToItem(this.dataset.guid);
        });
    });
}

function navigateToItem(guid) {
    window.location.href = `/item/${guid}`;
}

function isGuidOrUrl(input) {
    // Check if it looks like a GUID or URL
    const guidPattern = /[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/i;
    return guidPattern.test(input) || input.startsWith('http');
}

// Disable form submission on Enter key for search
homeSearchInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        // Only allow Enter if it looks like a GUID or URL
        const value = this.value.trim();
        if (!isGuidOrUrl(value)) {
            e.preventDefault(); // Prevent form submission for search terms
            return false;
        }
    }
});

// Search input handlers
homeSearchInput.addEventListener('input', function() {
    const query = this.value.trim();
    
    // If it looks like a GUID or URL, don't show autocomplete
    if (isGuidOrUrl(query)) {
        hideHomeAutocomplete();
        return;
    }
    
    if (!query || query.length < 2) {
        hideHomeAutocomplete();
        return;
    }
    
    // Clear previous timeout
    clearTimeout(homeAutocompleteTimeout);
    
    // Show loading state
    homeDropdown.innerHTML = '<div class="home-autocomplete-loading">Searching...</div>';
    showHomeAutocomplete();
    
    // Debounce the search
    homeAutocompleteTimeout = setTimeout(() => {
        fetch(`/api/semantic-search?q=${encodeURIComponent(query)}&limit=10`)
            .then(response => response.json())
            .then(results => {
                homeAutocompleteResults = results;
                renderHomeAutocompleteResults(results);
            })
            .catch(error => {
                console.error('Search error:', error);
                // Fallback to traditional search
                fetch(`/search-items?q=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(results => {
                        homeAutocompleteResults = results;
                        renderHomeAutocompleteResults(results);
                    })
                    .catch(error2 => {
                        console.error('Fallback search error:', error2);
                        hideHomeAutocomplete();
                    });
            });
    }, 300);
});

// Keyboard navigation
homeSearchInput.addEventListener('keydown', function(e) {
    const items = homeDropdown.querySelectorAll('.home-autocomplete-item');
    
    if (e.key === 'ArrowDown') {
        e.preventDefault();
        homeSelectedIndex = Math.min(homeSelectedIndex + 1, items.length - 1);
        updateHomeSelection(items);
    } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        homeSelectedIndex = Math.max(homeSelectedIndex - 1, -1);
        updateHomeSelection(items);
    } else if (e.key === 'Enter' && homeSelectedIndex >= 0) {
        e.preventDefault();
        const selected = homeAutocompleteResults[homeSelectedIndex];
        if (selected) {
            navigateToItem(selected.guid);
        }
    } else if (e.key === 'Escape') {
        hideHomeAutocomplete();
    }
});

function updateHomeSelection(items) {
    items.forEach((item, index) => {
        item.classList.toggle('selected', index === homeSelectedIndex);
    });
}

// Hide dropdown when clicking outside
document.addEventListener('click', function(e) {
    if (!homeSearchInput.contains(e.target) && !homeDropdown.contains(e.target)) {
        hideHomeAutocomplete();
    }
});

// Auto-submit form when GUID is pasted
homeSearchInput.addEventListener('paste', (e) => {
    setTimeout(() => {
        const value = e.target.value.trim();
        if (value.length > 30) { // Likely a GUID or URL
            document.getElementById('search-form').submit();
        }
    }, 100);
});

// Tree View Functionality
let isTreeView = localStorage.getItem('viewMode') === 'tree' || false;
let treeData = [];

function toggleView() {
    const toggle = document.getElementById('view-toggle');
    const itemsList = document.querySelector('.items-list');
    const treeView = document.getElementById('tree-view');
    
    isTreeView = !isTreeView;
    
    // Save preference to localStorage
    localStorage.setItem('viewMode', isTreeView ? 'tree' : 'list');
    
    if (isTreeView) {
        toggle.classList.add('active');
        itemsList.style.display = 'none';
        treeView.classList.add('active');
        loadTreeData();
    } else {
        toggle.classList.remove('active');
        itemsList.style.display = 'block';
        treeView.classList.remove('active');
    }
}

// Initialize view mode on page load
function initializeViewMode() {
    const toggle = document.getElementById('view-toggle');
    const itemsList = document.querySelector('.items-list');
    const treeView = document.getElementById('tree-view');
    
    if (isTreeView) {
        toggle.classList.add('active');
        itemsList.style.display = 'none';
        treeView.classList.add('active');
        loadTreeData();
    } else {
        toggle.classList.remove('active');
        itemsList.style.display = 'block';
        treeView.classList.remove('active');
    }
}

// Initialize view mode when page loads
document.addEventListener('DOMContentLoaded', initializeViewMode);

function loadTreeData() {
    const loading = document.getElementById('tree-loading');
    const container = document.getElementById('tree-container');
    
    loading.style.display = 'block';
    container.innerHTML = '';
    
    fetch('/api/tree-data')
        .then(response => response.json())
        .then(data => {
            loading.style.display = 'none';
            if (data.success) {
                treeData = data.data;
                renderTree(treeData, container, 0);
            } else {
                container.innerHTML = `<div class="tree-loading">Error loading tree: ${data.error}</div>`;
            }
        })
        .catch(error => {
            loading.style.display = 'none';
            console.error('Tree loading error:', error);
            container.innerHTML = '<div class="tree-loading">Failed to load tree structure</div>';
        });
}

function renderTree(items, container, level) {
    items.forEach(item => {
        const treeItem = createTreeItem(item, level);
        container.appendChild(treeItem);
        
        // Create children container (initially hidden)
        if (item.child_count > 0) {
            const childrenContainer = document.createElement('div');
            childrenContainer.className = 'tree-children';
            childrenContainer.id = `children-${item.guid}`;
            container.appendChild(childrenContainer);
        }
    });
}

function createTreeItem(item, level) {
    const itemDiv = document.createElement('div');
    itemDiv.className = 'tree-item';
    itemDiv.setAttribute('data-guid', item.guid);
    itemDiv.setAttribute('data-level', level);
    
    // Create indentation
    let indentHtml = '';
    for (let i = 0; i < level; i++) {
        indentHtml += '<div class="tree-indent"></div>';
    }
    
    // Expand icon
    const expandIcon = item.child_count > 0 ? 
        `<div class="tree-expand-icon expandable" onclick="event.stopPropagation(); toggleTreeItem('${item.guid}')" title="Expand/Collapse">‚ñ∂</div>` :
        '<div class="tree-expand-icon">‚Ä¢</div>';
    
    // Thumbnail or placeholder
    const thumbnail = item.primary_image_id ?
        `<img src="/thumbnail/${item.primary_image_id}" alt="${item.name}" class="tree-item-thumbnail" loading="lazy">` :
        '<div class="tree-item-placeholder">üì¶</div>';
    
    // Meta information
    const label = item.label_number ? `<span class="tree-item-stat" style="font-weight: 600; color: #007bff;">#${item.label_number}</span>` : '';
    const childrenInfo = item.child_count > 0 ? `<span class="tree-item-stat">üìÅ ${item.child_count}</span>` : '';
    
    itemDiv.innerHTML = `
        <div class="tree-item-content" onclick="navigateToTreeItem('${item.guid}')">
            ${indentHtml}
            ${expandIcon}
            ${thumbnail}
            <div class="tree-item-info">
                <div class="tree-item-name">${item.name}</div>
                <div class="tree-item-meta">
                    ${label}
                    <span class="tree-item-stat">üì∑ ${item.image_count}</span>
                    <span class="tree-item-stat">üìù ${item.text_count}</span>
                    ${childrenInfo}
                </div>
            </div>
            <span class="tree-item-arrow">‚Ä∫</span>
        </div>
    `;
    
    return itemDiv;
}

function toggleTreeItem(guid) {
    const childrenContainer = document.getElementById(`children-${guid}`);
    const expandIcon = document.querySelector(`[data-guid="${guid}"] .tree-expand-icon`);
    
    if (!childrenContainer) return;
    
    if (childrenContainer.classList.contains('expanded')) {
        // Collapse
        childrenContainer.classList.remove('expanded');
        expandIcon.innerHTML = '‚ñ∂';
        expandIcon.title = 'Expand';
    } else {
        // Expand
        if (childrenContainer.children.length === 0) {
            // Load children
            loadTreeChildren(guid, childrenContainer);
        }
        childrenContainer.classList.add('expanded');
        expandIcon.innerHTML = '‚ñº';
        expandIcon.title = 'Collapse';
    }
}

function loadTreeChildren(parentGuid, container) {
    container.innerHTML = '<div class="tree-loading">Loading...</div>';
    
    fetch(`/api/tree-children/${parentGuid}`)
        .then(response => response.json())
        .then(data => {
            container.innerHTML = '';
            if (data.success) {
                const parentLevel = parseInt(document.querySelector(`[data-guid="${parentGuid}"]`).getAttribute('data-level'));
                renderTree(data.data, container, parentLevel + 1);
            } else {
                container.innerHTML = `<div class="tree-loading">Error: ${data.error}</div>`;
            }
        })
        .catch(error => {
            console.error('Error loading children:', error);
            container.innerHTML = '<div class="tree-loading">Failed to load children</div>';
        });
}

function navigateToTreeItem(guid) {
    window.location.href = `/item/${guid}`;
}

// Quick Start Guide functions
function showQuickStartGuide() {
    const modal = document.getElementById('quick-start-modal');
    modal.style.display = 'block';
    document.body.style.overflow = 'hidden'; // Prevent background scrolling
}

function closeQuickStartGuide() {
    const modal = document.getElementById('quick-start-modal');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto'; // Restore scrolling
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('quick-start-modal');
    if (event.target === modal) {
        closeQuickStartGuide();
    }
}

// Create new item function
function createNewItem() {
    // Call the backend to create a new item
    fetch('/create-item', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            description: ''
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Navigate to the new item
            window.location.href = `/item/${data.guid}`;
        } else {
            alert('Failed to create new item: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error creating item:', error);
        alert('Failed to create new item. Please try again.');
    });
}
</script>
{% endblock %}