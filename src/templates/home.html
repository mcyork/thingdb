{% extends "base.html" %}

{% block title %}Inventory - Home{% endblock %}

{% block extra_head %}
<script src="https://unpkg.com/qr-scanner@1.4.2/qr-scanner.umd.min.js" defer></script>
{% endblock %}

{% block styles %}
<style>
    /* Header Search */
    .header-search-input {
        width: 100%; padding: 10px 12px 10px 36px; border: none;
        border-radius: 8px; background: rgba(255,255,255,0.15);
        font-size: 16px; color: white; -webkit-appearance: none;
    }
    .header-search-input::placeholder { color: rgba(255,255,255,0.7); }
    .header-search-input:focus { outline: none; background: rgba(255,255,255,0.25); }
    .header-search-icon {
        position: absolute; left: 12px; top: 50%;
        transform: translateY(-50%); color: rgba(255,255,255,0.8);
        pointer-events: none; font-size: 14px;
    }
    .header-action-btn {
        background: rgba(255,255,255,0.15); border: none; border-radius: 8px;
        padding: 10px 12px; color: white; font-size: 16px; cursor: pointer;
        transition: all 0.2s;
    }
    .header-action-btn:hover { background: rgba(255,255,255,0.25); }

    /* Action Grid */
    .action-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 12px;
        padding: 16px;
    }
    .action-grid-item {
        display: flex; flex-direction: column; align-items: center;
        justify-content: center; padding: 12px; background: var(--background-light);
        border-radius: 8px; text-decoration: none; color: var(--text-dark);
        font-size: 13px; font-weight: 500; text-align: center;
        border: 1px solid var(--border-color); transition: all 0.2s;
    }
    .action-grid-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px var(--shadow-color);
        border-color: var(--primary-color);
    }
    .action-grid-icon { font-size: 24px; margin-bottom: 8px; color: var(--primary-color); }

    /* View Toggle */
    .items-header {
        padding: 12px 16px; background: var(--background-light);
        border-bottom: 1px solid var(--border-color);
        display: flex; justify-content: space-between; align-items: center;
    }
    .items-header h3 {
        font-size: 14px; font-weight: 600; color: var(--text-light);
        text-transform: uppercase; letter-spacing: 0.5px; margin: 0;
    }
    .toggle-switch {
        position: relative; width: 48px; height: 24px; background: #ccc;
        border-radius: 12px; cursor: pointer; transition: background 0.3s;
    }
    .toggle-switch.active { background: var(--primary-color); }
    .toggle-switch::after {
        content: ''; position: absolute; top: 2px; left: 2px;
        width: 20px; height: 20px; background: white; border-radius: 50%;
        transition: transform 0.3s;
    }
    .toggle-switch.active::after { transform: translateX(24px); }

    /* List & Tree Views */
    .items-list, .tree-view { background: var(--background-white); }
    .item-card, .tree-item-content {
        display: flex; align-items: center; padding: 12px 16px;
        text-decoration: none; color: inherit;
        border-bottom: 1px solid var(--border-color);
    }
    .item-thumbnail, .tree-item-thumbnail {
        width: 48px; height: 48px; border-radius: 6px; object-fit: cover;
        background: var(--background-light); flex-shrink: 0; margin-right: 12px;
    }
    .item-placeholder, .tree-item-placeholder {
        width: 48px; height: 48px; border-radius: 6px; background: var(--background-light);
        display: flex; align-items: center; justify-content: center;
        color: #ccc; font-size: 24px; flex-shrink: 0; margin-right: 12px;
    }
    .item-info, .tree-item-info { flex: 1; min-width: 0; }
    .item-name, .tree-item-name {
        font-size: 16px; font-weight: 600; color: var(--text-dark);
        overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .item-meta, .tree-item-meta {
        font-size: 12px; color: var(--text-light); display: flex;
        align-items: center; gap: 8px; margin-top: 4px;
    }
    .item-arrow, .tree-item-arrow { color: #ccc; font-size: 20px; }
    .tree-indent { width: 20px; flex-shrink: 0; }
    .tree-expand-icon {
        width: 24px; height: 24px; display: flex; align-items: center;
        justify-content: center; margin-right: 4px; color: var(--text-light);
        font-size: 12px; flex-shrink: 0; cursor: pointer;
    }
    .tree-expand-icon.expandable { color: var(--primary-color); }
    .tree-children { display: none; }
    .tree-children.expanded { display: block; }
    .tree-loading { padding: 16px; text-align: center; color: var(--text-light); }

    /* Empty State */
    .empty-state { text-align: center; padding: 60px 20px; color: var(--text-light); }
    .empty-icon { font-size: 64px; margin-bottom: 16px; opacity: 0.3; }

    /* Modals (Scanner, Quick Start) */
    .scanner-modal, .modal {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.8); z-index: 2000; display: none;
    }
    .scanner-modal.active, .modal.active { display: flex; }
    .scanner-header {
        padding: env(safe-area-inset-top) 16px 16px; display: flex;
        justify-content: space-between; align-items: center; color: white;
    }
    .scanner-video { width: 100%; max-width: 400px; border-radius: 12px; }
    .modal-content {
        background: white; margin: auto; border-radius: 16px; width: 90%;
        max-width: 600px; max-height: 80vh; overflow-y: auto;
    }
    .modal-header {
        padding: 20px 24px; border-bottom: 1px solid var(--border-color);
        display: flex; justify-content: space-between; align-items: center;
    }
    .modal-body { padding: 24px; }
    .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; }

    /* Admin Menu */
    .admin-menu-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
    }
    .admin-menu-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
        background: var(--background-light);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        text-decoration: none;
        color: var(--text-dark);
        transition: all 0.2s;
    }
    .admin-menu-item:hover {
        background: var(--primary-color);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px var(--shadow-color);
    }
    .admin-menu-icon {
        font-size: 32px;
        margin-bottom: 8px;
    }
    .admin-menu-text {
        font-size: 14px;
        font-weight: 600;
    }

    /* New Item Confirmation Modal */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }
    .modal.active {
        display: flex;
    }
    .modal-content {
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        max-width: 90vw;
        max-height: 90vh;
        overflow: auto;
    }
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .modal-close {
        background: none;
        border: none;
        font-size: 20px;
        cursor: pointer;
        padding: 4px;
        color: #666;
    }
    .modal-close:hover {
        color: #333;
    }

    /* Home Page Autocomplete Styles */
    .home-autocomplete-wrapper {
        position: relative;
    }
    .home-autocomplete-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        min-width: 100%;
        width: max-content;
        max-width: 90vw;
        background: white;
        border: 1px solid #ddd;
        border-radius: 12px;
        margin-top: 8px;
        max-height: 400px;
        overflow-y: auto;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 2000;
        display: none;
    }
    .home-autocomplete-dropdown.show {
        display: block;
    }
    .home-autocomplete-item {
        padding: 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 12px;
        border-bottom: 1px solid #f0f0f0;
        transition: background-color 0.2s;
    }
    .home-autocomplete-item:last-child {
        border-bottom: none;
    }
    .home-autocomplete-item:hover,
    .home-autocomplete-item.selected {
        background-color: #f8f9fa;
    }
    .home-autocomplete-item-thumbnail {
        width: 48px;
        height: 48px;
        object-fit: cover;
        border-radius: 8px;
        background: #e9ecef;
        flex-shrink: 0;
    }
    .home-autocomplete-item-info {
        flex: 1;
        min-width: 0;
    }
    .home-autocomplete-item-name {
        font-weight: 600;
        color: #333;
        margin-bottom: 4px;
        font-size: 16px;
        line-height: 1.3;
        word-wrap: break-word;
    }
    .home-autocomplete-item-meta {
        font-size: 14px;
        color: #666;
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
        line-height: 1.4;
    }
    .home-autocomplete-no-results {
        padding: 20px;
        text-align: center;
        color: #999;
        font-style: italic;
    }
    .home-autocomplete-loading {
        padding: 20px;
        text-align: center;
        color: #666;
    }
</style>
{% endblock %}

{% block app_content %}
<!-- App Header with Integrated Search -->
<header class="app-header">
    <div class="app-header-content">
        <h1 style="margin-right: 16px; cursor: pointer;" onclick="showAdminMenu()" title="Admin Menu">Inventory</h1>
        <form method="POST" action="/process-guid" id="search-form" style="flex: 1; position: relative;">
            <div class="home-autocomplete-wrapper">
                <div class="header-search-input-group">
                    <span class="header-search-icon">üîç</span>
                    <input type="text" id="search-input" name="guid" class="header-search-input" placeholder="Search or scan..." autocomplete="off" autocorrect="off" spellcheck="false">
                </div>
                <div id="home-autocomplete-dropdown" class="home-autocomplete-dropdown"></div>
            </div>
        </form>
        <button onclick="createNewItem()" class="header-action-btn" title="Create New Item">‚ûï</button>
        <button onclick="openScanner()" class="header-action-btn" title="Scan QR Code">üì∑</button>
    </div>
</header>

<!-- Main Content -->
<div class="app-content">

    <!-- Items List / Tree View Container -->
    <div class="items-container card" style="padding: 0; margin: 0 16px;">
        <div class="items-header">
            <h3>Inventory <span style="font-weight: normal; color: #999;">({{ items|length }})</span></h3>
            <div style="display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 12px; color: #666;">List</span>
                <div class="toggle-switch" id="view-toggle" onclick="toggleView()"></div>
                <span style="font-size: 12px; color: #666;">Tree</span>
            </div>
        </div>
        
        <div class="items-list" id="items-list">
            {% if items %}
                {% for item in items %}
                <a href="/item/{{ item[0] }}" class="item-card">
                    {% if item[5] %}
                        <img src="/thumbnail/{{ item[5] }}" alt="Thumbnail" class="item-thumbnail">
                    {% else %}
                        <div class="item-placeholder">üì¶</div>
                    {% endif %}
                    <div class="item-info">
                        <div class="item-name">{{ item[1] or ('Item ' + item[0][:8]) }}</div>
                        <div class="item-meta">
                            {% if item[6] %}<span style="font-weight: 600; color: var(--primary-color);">#{{ item[6] }}</span>{% endif %}
                            <span>üì∑ {{ item[3] }}</span>
                            <span>üìÖ {{ item[2].strftime('%b %d, %Y') if item[2] }}</span>
                        </div>
                    </div>
                    <span class="item-arrow">‚Ä∫</span>
                </a>
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <div class="empty-icon">üì¶</div>
                    <p>No items yet. Scan or search to add one!</p>
                </div>
            {% endif %}
        </div>
        
        <div class="tree-view" id="tree-view">
            <div class="tree-loading" id="tree-loading">Loading tree...</div>
            <div id="tree-container"></div>
        </div>
    </div>
</div>

<!-- QR Scanner Modal -->
<div id="scanner-modal" class="scanner-modal">
    <div class="scanner-header">
        <h2>Scan QR Code</h2>
        <button onclick="closeScanner()" class="modal-close">‚úï</button>
    </div>
    <div style="flex: 1; display: flex; align-items: center; justify-content: center; padding: 16px;">
        <video id="scanner-video" class="scanner-video"></video>
    </div>
</div>

<!-- Quick Start Guide Modal -->
<div id="quick-start-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üìñ Quick Start Guide</h2>
            <button onclick="closeQuickStartGuide()" class="modal-close">‚úï</button>
        </div>
        <div class="modal-body">
            <h3>üöÄ Getting Started</h3>
            <p>Welcome! Here's how to add your first item:</p>
            <ol>
                <li>Click the <strong>‚ûï button</strong> in the top right.</li>
                <li>Give your new item a name.</li>
                <li>Add a description and photos.</li>
                <li>Use the <strong>Tree View</strong> to organize items inside one another.</li>
            </ol>
            <h3>üîç Smart Search</h3>
            <p>Try searching for concepts like "camping gear" or "electronics" to see semantic search in action.</p>
        </div>
    </div>
</div>

<!-- Admin Menu Modal -->
<div id="admin-menu-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Admin Menu</h2>
            <button onclick="closeAdminMenu()" class="modal-close">‚úï</button>
        </div>
        <div class="modal-body">
            <div class="admin-menu-grid">
                <a href="/admin" class="admin-menu-item">
                    <span class="admin-menu-icon">üõ†Ô∏è</span>
                    <span class="admin-menu-text">Admin Panel</span>
                </a>
                <a href="/system-status" class="admin-menu-item">
                    <span class="admin-menu-icon">üöÄ</span>
                    <span class="admin-menu-text">System Status</span>
                </a>
                <a href="/db-stats" class="admin-menu-item">
                    <span class="admin-menu-icon">üìä</span>
                    <span class="admin-menu-text">Database Stats</span>
                </a>
                <a href="#" onclick="showQuickStartGuide(); closeAdminMenu();" class="admin-menu-item">
                    <span class="admin-menu-icon">üìñ</span>
                    <span class="admin-menu-text">Quick Start Guide</span>
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// --- Core App Logic ---
let qrScanner;
let isTreeView = localStorage.getItem('viewMode') === 'tree';

// --- View Toggle ---
function toggleView() {
    isTreeView = !isTreeView;
    localStorage.setItem('viewMode', isTreeView ? 'tree' : 'list');
    updateView();
}

function updateView() {
    const toggle = document.getElementById('view-toggle');
    const itemsList = document.getElementById('items-list');
    const treeView = document.getElementById('tree-view');
    
    if (isTreeView) {
        toggle.classList.add('active');
        itemsList.style.display = 'none';
        treeView.style.display = 'block';
        if (!treeView.dataset.loaded) {
            loadTreeData();
        }
    } else {
        toggle.classList.remove('active');
        itemsList.style.display = 'block';
        treeView.style.display = 'none';
    }
}

// --- Tree View ---
function loadTreeData() {
    const loading = document.getElementById('tree-loading');
    const container = document.getElementById('tree-container');
    loading.style.display = 'block';
    container.innerHTML = '';
    
    fetch('/api/tree-data')
        .then(res => res.json())
        .then(data => {
            loading.style.display = 'none';
            if (data.success && data.data.length > 0) {
                container.dataset.loaded = true;
                renderTree(data.data, container, 0);
            } else if (data.success) {
                container.innerHTML = `<div class="empty-state" style="padding: 20px;"><p>No top-level items to display in tree view.</p></div>`;
            } else {
                container.innerHTML = `<div class="tree-loading">Error: ${data.error}</div>`;
            }
        })
        .catch(err => {
            loading.style.display = 'none';
            container.innerHTML = '<div class="tree-loading">Failed to load tree.</div>';
        });
}

function renderTree(items, container, level) {
    items.forEach(item => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'tree-item';
        itemDiv.dataset.guid = item.guid;
        itemDiv.dataset.level = level;

        const indentHtml = Array(level).fill('<div class="tree-indent"></div>').join('');
        const expandIcon = item.child_count > 0 ? `<div class="tree-expand-icon expandable">‚ñ∂</div>` : '<div class="tree-expand-icon">‚Ä¢</div>';
        const thumbnail = item.primary_image_id ? `<img src="/thumbnail/${item.primary_image_id}" class="tree-item-thumbnail">` : '<div class="tree-item-placeholder">üì¶</div>';
        const label = item.label_number ? `<span style="font-weight: 600; color: var(--primary-color);">#${item.label_number}</span>` : '';
        
        itemDiv.innerHTML = `
            <div class="tree-item-content">
                ${indentHtml}${expandIcon}${thumbnail}
                <div class="tree-item-info">
                    <div class="tree-item-name">${item.name}</div>
                    <div class="tree-item-meta">${label}<span>üì∑ ${item.image_count}</span>${item.child_count > 0 ? `<span>üìÅ ${item.child_count}</span>` : ''}</div>
                </div>
                <span class="tree-item-arrow">‚Ä∫</span>
            </div>
            ${item.child_count > 0 ? `<div class="tree-children" id="children-${item.guid}"></div>` : ''}
        `;
        container.appendChild(itemDiv);
    });
}

document.getElementById('tree-container').addEventListener('click', e => {
    const target = e.target;
    if (target.classList.contains('tree-expand-icon')) {
        const itemDiv = target.closest('.tree-item');
        toggleTreeItem(itemDiv.dataset.guid);
    } else if (target.closest('.tree-item-content')) {
        window.location.href = `/item/${target.closest('.tree-item').dataset.guid}`;
    }
});

function toggleTreeItem(guid) {
    const childrenContainer = document.getElementById(`children-${guid}`);
    const expandIcon = document.querySelector(`.tree-item[data-guid="${guid}"] .tree-expand-icon`);
    
    if (childrenContainer.classList.toggle('expanded')) {
        expandIcon.innerHTML = '‚ñº';
        if (!childrenContainer.dataset.loaded) {
            childrenContainer.innerHTML = '<div class="tree-loading">Loading...</div>';
            fetch(`/api/tree-children/${guid}`)
                .then(res => res.json())
                .then(data => {
                    childrenContainer.innerHTML = '';
                    if (data.success) {
                        childrenContainer.dataset.loaded = true;
                        const level = parseInt(expandIcon.closest('.tree-item').dataset.level);
                        renderTree(data.data, childrenContainer, level + 1);
                    }
                });
        }
    } else {
        expandIcon.innerHTML = '‚ñ∂';
    }
}

// --- QR Scanner ---
function openScanner() {
    const modal = document.getElementById('scanner-modal');
    modal.classList.add('active');
    qrScanner = new QrScanner(document.getElementById('scanner-video'), result => handleQRCode(result.data), {
        highlightScanRegion: true,
        highlightCodeOutline: true,
    });
    qrScanner.start().catch(err => showScannerError('Could not start scanner.'));
}

function closeScanner() {
    if (qrScanner) qrScanner.stop();
    document.getElementById('scanner-modal').classList.remove('active');
}

function handleQRCode(data) {
    closeScanner();
    document.getElementById('search-input').value = data;
    document.getElementById('search-form').submit();
}

// --- New Item & Quick Start ---
function createNewItem() {
    // Show confirmation dialog instead of creating immediately
    showNewItemConfirmation();
}

// Show confirmation dialog for new item creation
function showNewItemConfirmation() {
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.id = 'new-item-confirmation-modal';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 320px; padding: 0;">
            <div class="modal-header" style="padding: 16px 20px 12px 20px; border-bottom: 1px solid #eee;">
                <h2 style="margin: 0; font-size: 18px;">Create New Item</h2>
                <button onclick="hideNewItemConfirmation()" class="modal-close" style="font-size: 16px; padding: 4px;">‚úï</button>
            </div>
            <div class="modal-body" style="padding: 16px 20px;">
                <div style="text-align: center;">
                    <div style="font-size: 32px; margin-bottom: 8px;">üì¶</div>
                    <h3 style="margin: 0 0 8px 0; font-size: 16px; font-weight: 600;">Ready to add a new item?</h3>
                    <p style="margin: 0; font-size: 14px; color: #666;">This will create a new item in your inventory.</p>
                </div>
            </div>
            <div class="modal-footer" style="display: flex; gap: 8px; justify-content: center; padding: 12px 20px 16px 20px; border-top: 1px solid #eee;">
                <button onclick="confirmCreateNewItem()" class="btn btn-primary" style="font-size: 14px; padding: 8px 16px; flex: 1;">
                    Add New Item
                </button>
                <button onclick="hideNewItemConfirmation()" class="btn btn-secondary" style="font-size: 14px; padding: 8px 16px; flex: 1;">
                    Cancel
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

// Hide the confirmation dialog
function hideNewItemConfirmation() {
    const modal = document.getElementById('new-item-confirmation-modal');
    if (modal) {
        modal.remove();
    }
}

// Confirm and create new item
function confirmCreateNewItem() {
    hideNewItemConfirmation();
    
    // Call the backend to create a new item
    fetch('/create-item', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            description: ''
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Navigate to the new item with edit mode parameter
            window.location.href = `/item/${data.guid}?edit_title=true`;
        } else {
            alert('Failed to create new item: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error creating item:', error);
        alert('Failed to create new item. Please try again.');
    });
}

function showQuickStartGuide() { document.getElementById('quick-start-modal').classList.add('active'); }
function closeQuickStartGuide() { document.getElementById('quick-start-modal').classList.remove('active'); }

function showAdminMenu() { document.getElementById('admin-menu-modal').classList.add('active'); }
function closeAdminMenu() { document.getElementById('admin-menu-modal').classList.remove('active'); }

// Home page autocomplete functionality
let homeAutocompleteTimeout;
let homeSelectedIndex = -1;
let homeAutocompleteResults = [];

const homeSearchInput = document.getElementById('search-input');
const homeDropdown = document.getElementById('home-autocomplete-dropdown');

function showHomeAutocomplete() {
    homeDropdown.classList.add('show');
}

function hideHomeAutocomplete() {
    homeDropdown.classList.remove('show');
    homeSelectedIndex = -1;
}

function renderHomeAutocompleteResults(results) {
    if (results.length === 0) {
        hideHomeAutocomplete();
        return;
    }
    
    homeDropdown.innerHTML = results.map((item, index) => `
        <div class="home-autocomplete-item ${index === homeSelectedIndex ? 'selected' : ''}" 
             data-guid="${item.guid}" 
             data-name="${item.name}"
             data-index="${index}">
            ${item.has_image ? 
                `<img src="/thumbnail/${item.image_id}" alt="${item.name}" class="home-autocomplete-item-thumbnail">` :
                `<div class="home-autocomplete-item-thumbnail" style="display: flex; align-items: center; justify-content: center; font-size: 20px; color: #adb5bd;">üì¶</div>`
            }
            <div class="home-autocomplete-item-info">
                <div class="home-autocomplete-item-name">${item.name}</div>
                <div class="home-autocomplete-item-meta">
                    ${item.label_number ? `<span style="font-weight: 600; color: #007bff;">#${item.label_number}</span>` : ''}
                    <span>${item.contained_count > 0 ? `${item.contained_count} item${item.contained_count !== 1 ? 's' : ''} inside` : 'Empty'}</span>
                    ${item.matched_tags ? `<span>‚Ä¢ Tags: ${item.matched_tags}</span>` : ''}
                    ${item.description && item.description.length > 0 ? `<span>‚Ä¢ ${item.description.substring(0, 50)}${item.description.length > 50 ? '...' : ''}</span>` : ''}
                    ${item.similarity !== undefined && item.match_type === 'semantic' ? `<span>‚Ä¢ ${Math.round(item.similarity * 100)}% match</span>` : ''}
                    <span>‚Ä¢ Click to view</span>
                </div>
            </div>
        </div>
    `).join('');
    
    showHomeAutocomplete();
    
    // Add click handlers
    homeDropdown.querySelectorAll('.home-autocomplete-item').forEach(item => {
        item.addEventListener('click', function() {
            navigateToItem(this.dataset.guid);
        });
    });
}

function navigateToItem(guid) {
    window.location.href = `/item/${guid}`;
}

function isGuidOrUrl(input) {
    // Check if it looks like a GUID or URL
    const guidPattern = /[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/i;
    return guidPattern.test(input) || input.startsWith('http');
}

// Search input handlers
homeSearchInput.addEventListener('input', function() {
    const query = this.value.trim();
    
    // If it looks like a GUID or URL, don't show autocomplete
    if (isGuidOrUrl(query)) {
        hideHomeAutocomplete();
        return;
    }
    
    if (!query || query.length < 2) {
        hideHomeAutocomplete();
        return;
    }
    
    // Clear previous timeout
    clearTimeout(homeAutocompleteTimeout);
    
    // Show loading state
    homeDropdown.innerHTML = '<div class="home-autocomplete-loading">Searching...</div>';
    showHomeAutocomplete();
    
    // Debounce the search
    homeAutocompleteTimeout = setTimeout(() => {
        fetch(`/api/semantic-search?q=${encodeURIComponent(query)}&limit=15`)
            .then(response => response.json())
            .then(results => {
                homeAutocompleteResults = results;
                renderHomeAutocompleteResults(results);
            })
            .catch(error => {
                console.error('Search error:', error);
                // Fallback to traditional search
                fetch(`/search-items?q=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(results => {
                        homeAutocompleteResults = results;
                        renderHomeAutocompleteResults(results);
                    })
                    .catch(error2 => {
                        console.error('Fallback search error:', error2);
                        hideHomeAutocomplete();
                    });
            });
    }, 300);
});

// Keyboard navigation
homeSearchInput.addEventListener('keydown', function(e) {
    const items = homeDropdown.querySelectorAll('.home-autocomplete-item');
    
    if (e.key === 'ArrowDown') {
        e.preventDefault();
        homeSelectedIndex = Math.min(homeSelectedIndex + 1, items.length - 1);
        updateHomeSelection(items);
    } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        homeSelectedIndex = Math.max(homeSelectedIndex - 1, -1);
        updateHomeSelection(items);
    } else if (e.key === 'Enter' && homeSelectedIndex >= 0) {
        e.preventDefault();
        const selected = homeAutocompleteResults[homeSelectedIndex];
        if (selected) {
            navigateToItem(selected.guid);
        }
    } else if (e.key === 'Escape') {
        hideHomeAutocomplete();
    }
});

function updateHomeSelection(items) {
    items.forEach((item, index) => {
        item.classList.toggle('selected', index === homeSelectedIndex);
    });
}

// Click outside to close
document.addEventListener('click', function(e) {
    if (!homeSearchInput.contains(e.target) && !homeDropdown.contains(e.target)) {
        hideHomeAutocomplete();
    }
});

// --- Init ---
document.addEventListener('DOMContentLoaded', updateView);
</script>
{% endblock %}
