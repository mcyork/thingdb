{% extends "base.html" %}

{% block title %}Inventory - Home{% endblock %}

{% block extra_head %}
<script src="https://unpkg.com/qr-scanner@1.4.2/qr-scanner.umd.min.js" defer></script>
{% endblock %}

{% block styles %}
<style>
    /* Header Search */
    .header-search-input {
        width: 100%; padding: 10px 12px 10px 36px; border: none;
        border-radius: 8px; background: rgba(255,255,255,0.15);
        font-size: 16px; color: white; -webkit-appearance: none;
    }
    .header-search-input::placeholder { color: rgba(255,255,255,0.7); }
    .header-search-input:focus { outline: none; background: rgba(255,255,255,0.25); }
    .header-search-icon {
        position: absolute; left: 12px; top: 50%;
        transform: translateY(-50%); color: rgba(255,255,255,0.8);
        pointer-events: none; font-size: 14px;
    }
    .header-action-btn {
        background: rgba(255,255,255,0.15); border: none; border-radius: 8px;
        padding: 10px 12px; color: white; font-size: 16px; cursor: pointer;
        transition: all 0.2s;
    }
    .header-action-btn:hover { background: rgba(255,255,255,0.25); }

    /* Action Grid */
    .action-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 12px;
        padding: 16px;
    }
    .action-grid-item {
        display: flex; flex-direction: column; align-items: center;
        justify-content: center; padding: 12px; background: var(--background-light);
        border-radius: 8px; text-decoration: none; color: var(--text-dark);
        font-size: 13px; font-weight: 500; text-align: center;
        border: 1px solid var(--border-color); transition: all 0.2s;
    }
    .action-grid-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px var(--shadow-color);
        border-color: var(--primary-color);
    }
    .action-grid-icon { font-size: 24px; margin-bottom: 8px; color: var(--primary-color); }

    /* View Toggle */
    .items-header {
        padding: 12px 16px; background: var(--background-light);
        border-bottom: 1px solid var(--border-color);
        display: flex; justify-content: space-between; align-items: center;
    }
    .items-header h3 {
        font-size: 14px; font-weight: 600; color: var(--text-light);
        text-transform: uppercase; letter-spacing: 0.5px; margin: 0;
    }
    .toggle-switch {
        position: relative; width: 48px; height: 24px; background: #ccc;
        border-radius: 12px; cursor: pointer; transition: background 0.3s;
    }
    .toggle-switch.active { background: var(--primary-color); }
    .toggle-switch::after {
        content: ''; position: absolute; top: 2px; left: 2px;
        width: 20px; height: 20px; background: white; border-radius: 50%;
        transition: transform 0.3s;
    }
    .toggle-switch.active::after { transform: translateX(24px); }

    /* List & Tree Views */
    .items-list, .tree-view { background: var(--background-white); }
    .item-card, .tree-item-content {
        display: flex; align-items: center; padding: 12px 16px;
        text-decoration: none; color: inherit;
        border-bottom: 1px solid var(--border-color);
    }
    .item-thumbnail, .tree-item-thumbnail {
        width: 48px; height: 48px; border-radius: 6px; object-fit: cover;
        background: var(--background-light); flex-shrink: 0; margin-right: 12px;
    }
    .item-placeholder, .tree-item-placeholder {
        width: 48px; height: 48px; border-radius: 6px; background: var(--background-light);
        display: flex; align-items: center; justify-content: center;
        color: #ccc; font-size: 24px; flex-shrink: 0; margin-right: 12px;
    }
    .item-info, .tree-item-info { flex: 1; min-width: 0; }
    .item-name, .tree-item-name {
        font-size: 16px; font-weight: 600; color: var(--text-dark);
        overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .item-meta, .tree-item-meta {
        font-size: 12px; color: var(--text-light); display: flex;
        align-items: center; gap: 8px; margin-top: 4px;
    }
    .item-arrow, .tree-item-arrow { color: #ccc; font-size: 20px; }
    .tree-indent { width: 20px; flex-shrink: 0; }
    .tree-expand-icon {
        width: 24px; height: 24px; display: flex; align-items: center;
        justify-content: center; margin-right: 4px; color: var(--text-light);
        font-size: 12px; flex-shrink: 0; cursor: pointer;
    }
    .tree-expand-icon.expandable { color: var(--primary-color); }
    .tree-children { display: none; }
    .tree-children.expanded { display: block; }
    .tree-loading { padding: 16px; text-align: center; color: var(--text-light); }

    /* Empty State */
    .empty-state { text-align: center; padding: 60px 20px; color: var(--text-light); }
    .empty-icon { font-size: 64px; margin-bottom: 16px; opacity: 0.3; }

    /* Modals (Scanner, Quick Start) */
    .scanner-modal, .modal {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.8); z-index: 2000; display: none;
    }
    .scanner-modal.active, .modal.active { display: flex; }
    .scanner-header {
        padding: env(safe-area-inset-top) 16px 16px; display: flex;
        justify-content: space-between; align-items: center; color: white;
    }
    .scanner-video { width: 100%; max-width: 400px; border-radius: 12px; }
    .modal-content {
        background: white; margin: auto; border-radius: 16px; width: 90%;
        max-width: 600px; max-height: 80vh; overflow-y: auto;
    }
    .modal-header {
        padding: 20px 24px; border-bottom: 1px solid var(--border-color);
        display: flex; justify-content: space-between; align-items: center;
    }
    .modal-body { padding: 24px; }
    .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; }
</style>
{% endblock %}

{% block app_content %}
<!-- App Header with Integrated Search -->
<header class="app-header">
    <div class="app-header-content">
        <h1 style="margin-right: 16px;">Inventory</h1>
        <form method="POST" action="/process-guid" id="search-form" style="flex: 1; position: relative;">
            <div class="header-search-input-group">
                <span class="header-search-icon">üîç</span>
                <input type="text" id="search-input" name="guid" class="header-search-input" placeholder="Search or scan..." autocomplete="off">
            </div>
        </form>
        <button onclick="createNewItem()" class="header-action-btn" title="Create New Item">‚ûï</button>
        <button onclick="openScanner()" class="header-action-btn" title="Scan QR Code">üì∑</button>
    </div>
</header>

<!-- Main Content -->
<div class="app-content">
    <div class="action-grid">
        <a href="/admin" class="action-grid-item">
            <span class="action-grid-icon">üõ†Ô∏è</span> Admin
        </a>
        <a href="/system-status" class="action-grid-item">
            <span class="action-grid-icon">üöÄ</span> Status
        </a>
        <a href="/db-stats" class="action-grid-item">
            <span class="action-grid-icon">üìä</span> Stats
        </a>
        <a href="#" onclick="showQuickStartGuide()" class="action-grid-item">
            <span class="action-grid-icon">üìñ</span> Guide
        </a>
    </div>

    <!-- Items List / Tree View Container -->
    <div class="items-container card" style="padding: 0; margin: 0 16px;">
        <div class="items-header">
            <h3>Inventory <span style="font-weight: normal; color: #999;">({{ items|length }})</span></h3>
            <div style="display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 12px; color: #666;">List</span>
                <div class="toggle-switch" id="view-toggle" onclick="toggleView()"></div>
                <span style="font-size: 12px; color: #666;">Tree</span>
            </div>
        </div>
        
        <div class="items-list" id="items-list">
            {% if items %}
                {% for item in items %}
                <a href="/item/{{ item[0] }}" class="item-card">
                    {% if item[5] %}
                        <img src="/thumbnail/{{ item[5] }}" alt="Thumbnail" class="item-thumbnail">
                    {% else %}
                        <div class="item-placeholder">üì¶</div>
                    {% endif %}
                    <div class="item-info">
                        <div class="item-name">{{ item[1] or ('Item ' + item[0][:8]) }}</div>
                        <div class="item-meta">
                            {% if item[6] %}<span style="font-weight: 600; color: var(--primary-color);">#{{ item[6] }}</span>{% endif %}
                            <span>üì∑ {{ item[3] }}</span>
                            <span>üìÖ {{ item[2].strftime('%b %d, %Y') if item[2] }}</span>
                        </div>
                    </div>
                    <span class="item-arrow">‚Ä∫</span>
                </a>
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <div class="empty-icon">üì¶</div>
                    <p>No items yet. Scan or search to add one!</p>
                </div>
            {% endif %}
        </div>
        
        <div class="tree-view" id="tree-view">
            <div class="tree-loading" id="tree-loading">Loading tree...</div>
            <div id="tree-container"></div>
        </div>
    </div>
</div>

<!-- QR Scanner Modal -->
<div id="scanner-modal" class="scanner-modal">
    <div class="scanner-header">
        <h2>Scan QR Code</h2>
        <button onclick="closeScanner()" class="modal-close">‚úï</button>
    </div>
    <div style="flex: 1; display: flex; align-items: center; justify-content: center; padding: 16px;">
        <video id="scanner-video" class="scanner-video"></video>
    </div>
</div>

<!-- Quick Start Guide Modal -->
<div id="quick-start-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üìñ Quick Start Guide</h2>
            <button onclick="closeQuickStartGuide()" class="modal-close">‚úï</button>
        </div>
        <div class="modal-body">
            <h3>üöÄ Getting Started</h3>
            <p>Welcome! Here's how to add your first item:</p>
            <ol>
                <li>Click the <strong>‚ûï button</strong> in the top right.</li>
                <li>Give your new item a name.</li>
                <li>Add a description and photos.</li>
                <li>Use the <strong>Tree View</strong> to organize items inside one another.</li>
            </ol>
            <h3>üîç Smart Search</h3>
            <p>Try searching for concepts like "camping gear" or "electronics" to see semantic search in action.</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// --- Core App Logic ---
let qrScanner;
let isTreeView = localStorage.getItem('viewMode') === 'tree';

// --- View Toggle ---
function toggleView() {
    isTreeView = !isTreeView;
    localStorage.setItem('viewMode', isTreeView ? 'tree' : 'list');
    updateView();
}

function updateView() {
    const toggle = document.getElementById('view-toggle');
    const itemsList = document.getElementById('items-list');
    const treeView = document.getElementById('tree-view');
    
    if (isTreeView) {
        toggle.classList.add('active');
        itemsList.style.display = 'none';
        treeView.style.display = 'block';
        if (!treeView.dataset.loaded) {
            loadTreeData();
        }
    } else {
        toggle.classList.remove('active');
        itemsList.style.display = 'block';
        treeView.style.display = 'none';
    }
}

// --- Tree View ---
function loadTreeData() {
    const loading = document.getElementById('tree-loading');
    const container = document.getElementById('tree-container');
    loading.style.display = 'block';
    container.innerHTML = '';
    
    fetch('/api/tree-data')
        .then(res => res.json())
        .then(data => {
            loading.style.display = 'none';
            if (data.success && data.data.length > 0) {
                container.dataset.loaded = true;
                renderTree(data.data, container, 0);
            } else if (data.success) {
                container.innerHTML = `<div class="empty-state" style="padding: 20px;"><p>No top-level items to display in tree view.</p></div>`;
            } else {
                container.innerHTML = `<div class="tree-loading">Error: ${data.error}</div>`;
            }
        })
        .catch(err => {
            loading.style.display = 'none';
            container.innerHTML = '<div class="tree-loading">Failed to load tree.</div>';
        });
}

function renderTree(items, container, level) {
    items.forEach(item => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'tree-item';
        itemDiv.dataset.guid = item.guid;
        itemDiv.dataset.level = level;

        const indentHtml = Array(level).fill('<div class="tree-indent"></div>').join('');
        const expandIcon = item.child_count > 0 ? `<div class="tree-expand-icon expandable">‚ñ∂</div>` : '<div class="tree-expand-icon">‚Ä¢</div>';
        const thumbnail = item.primary_image_id ? `<img src="/thumbnail/${item.primary_image_id}" class="tree-item-thumbnail">` : '<div class="tree-item-placeholder">üì¶</div>';
        const label = item.label_number ? `<span style="font-weight: 600; color: var(--primary-color);">#${item.label_number}</span>` : '';
        
        itemDiv.innerHTML = `
            <div class="tree-item-content">
                ${indentHtml}${expandIcon}${thumbnail}
                <div class="tree-item-info">
                    <div class="tree-item-name">${item.name}</div>
                    <div class="tree-item-meta">${label}<span>üì∑ ${item.image_count}</span>${item.child_count > 0 ? `<span>üìÅ ${item.child_count}</span>` : ''}</div>
                </div>
                <span class="tree-item-arrow">‚Ä∫</span>
            </div>
            ${item.child_count > 0 ? `<div class="tree-children" id="children-${item.guid}"></div>` : ''}
        `;
        container.appendChild(itemDiv);
    });
}

document.getElementById('tree-container').addEventListener('click', e => {
    const target = e.target;
    if (target.classList.contains('tree-expand-icon')) {
        const itemDiv = target.closest('.tree-item');
        toggleTreeItem(itemDiv.dataset.guid);
    } else if (target.closest('.tree-item-content')) {
        window.location.href = `/item/${target.closest('.tree-item').dataset.guid}`;
    }
});

function toggleTreeItem(guid) {
    const childrenContainer = document.getElementById(`children-${guid}`);
    const expandIcon = document.querySelector(`.tree-item[data-guid="${guid}"] .tree-expand-icon`);
    
    if (childrenContainer.classList.toggle('expanded')) {
        expandIcon.innerHTML = '‚ñº';
        if (!childrenContainer.dataset.loaded) {
            childrenContainer.innerHTML = '<div class="tree-loading">Loading...</div>';
            fetch(`/api/tree-children/${guid}`)
                .then(res => res.json())
                .then(data => {
                    childrenContainer.innerHTML = '';
                    if (data.success) {
                        childrenContainer.dataset.loaded = true;
                        const level = parseInt(expandIcon.closest('.tree-item').dataset.level);
                        renderTree(data.data, childrenContainer, level + 1);
                    }
                });
        }
    } else {
        expandIcon.innerHTML = '‚ñ∂';
    }
}

// --- QR Scanner ---
function openScanner() {
    const modal = document.getElementById('scanner-modal');
    modal.classList.add('active');
    qrScanner = new QrScanner(document.getElementById('scanner-video'), result => handleQRCode(result.data), {
        highlightScanRegion: true,
        highlightCodeOutline: true,
    });
    qrScanner.start().catch(err => showScannerError('Could not start scanner.'));
}

function closeScanner() {
    if (qrScanner) qrScanner.stop();
    document.getElementById('scanner-modal').classList.remove('active');
}

function handleQRCode(data) {
    closeScanner();
    document.getElementById('search-input').value = data;
    document.getElementById('search-form').submit();
}

// --- New Item & Quick Start ---
function createNewItem() {
    fetch('/create-item', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({})
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            window.location.href = `/item/${data.guid}?new_item=1`;
        } else {
            alert('Error creating item: ' + data.error);
        }
    });
}

function showQuickStartGuide() { document.getElementById('quick-start-modal').classList.add('active'); }
function closeQuickStartGuide() { document.getElementById('quick-start-modal').classList.remove('active'); }

// --- Init ---
document.addEventListener('DOMContentLoaded', updateView);
</script>
{% endblock %}
