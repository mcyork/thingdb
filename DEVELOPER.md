# ThingDB - Developer Guide

This guide is for developers who want to contribute, test experimental features, or understand ThingDB internals.

## ğŸ§ª Development Branch (Bleeding Edge)

Want to test new features before they're released? Use the `dev` branch:

### Quick Install (Dev Branch)

```bash
# Dev branch one-liner:
wget -qO- https://raw.githubusercontent.com/mcyork/thingdb/dev/bootstrap.sh | bash
```

### Manual Install (Dev Branch)

```bash
wget https://github.com/mcyork/thingdb/archive/refs/heads/dev.zip
unzip dev.zip
cd thingdb-dev
./install.sh
```

**Note:** Dev branch may have experimental features. Use `main` branch for stability.

---

## Branching Strategy

- **`main`** - Stable, production-ready code. Tested on real hardware.
- **`dev`** - Active development. New features, improvements, bug fixes.

### Workflow

1. All development happens on `dev`
2. Features are tested thoroughly
3. When stable, `dev` is merged to `main`
4. Users get stable, tested code from `main`

---

## Configuration

The one-liner install auto-generates secure secrets. For manual configuration or advanced setups:

### .env File

```bash
# Database Configuration (auto-generated on install)
POSTGRES_HOST=localhost
POSTGRES_PORT=5432
POSTGRES_DB=thingdb
POSTGRES_USER=thingdb
POSTGRES_PASSWORD=<auto-generated-32-char-password>

# Flask Configuration (auto-generated on install)
FLASK_DEBUG=0
SECRET_KEY=<auto-generated-128-char-key>

# Image Storage
IMAGE_STORAGE_METHOD=filesystem
IMAGE_DIR=/var/lib/thingdb/images

# Optional: External PostgreSQL
# POSTGRES_HOST=your_external_host
# POSTGRES_DB=thingdb
# POSTGRES_USER=thingdb
# POSTGRES_PASSWORD=secure_password
```

**Security Note:** The installer generates unique secrets for each installation. Never commit `.env` to Git!

---

## Architecture

### Directory Structure

```
thingdb/
â”œâ”€â”€ src/thingdb/
â”‚   â”œâ”€â”€ main.py              # Flask application entry point
â”‚   â”œâ”€â”€ config.py            # Configuration settings
â”‚   â”œâ”€â”€ database.py          # Database connection & migrations
â”‚   â”œâ”€â”€ models.py            # Data models
â”‚   â”œâ”€â”€ cli.py               # CLI commands
â”‚   â”œâ”€â”€ routes/              # API routes
â”‚   â”‚   â”œâ”€â”€ core_routes.py   # Home, GUID processing
â”‚   â”‚   â”œâ”€â”€ item_routes.py   # Item CRUD
â”‚   â”‚   â”œâ”€â”€ search_routes.py # Search endpoints
â”‚   â”‚   â”œâ”€â”€ admin_routes.py  # Admin panel
â”‚   â”‚   â””â”€â”€ backup_routes.py # Backup/restore
â”‚   â”œâ”€â”€ services/            # Business logic
â”‚   â”‚   â”œâ”€â”€ embedding_service.py  # ML semantic search
â”‚   â”‚   â”œâ”€â”€ image_service.py      # Image processing
â”‚   â”‚   â””â”€â”€ qr_pdf_service.py     # QR code generation
â”‚   â””â”€â”€ templates/           # HTML templates
â”œâ”€â”€ docker/                  # Docker configuration
â”œâ”€â”€ install.sh               # Complete installation script
â”œâ”€â”€ install_system_deps.sh   # System dependencies
â”œâ”€â”€ setup_ssl.sh             # HTTPS setup
â”œâ”€â”€ bootstrap.sh             # One-liner bootstrap
â””â”€â”€ thingdb.service          # Systemd service file
```

---

## Database Schema

### Core Tables

- **`items`** - Main inventory items
  - `guid` (PRIMARY KEY): Unique identifier
  - `item_name`: Item title
  - `description`: Full text description
  - `parent_guid`: For hierarchical organization
  - `embedding_vector`: ML search embeddings
  - `label_number`: Sequential label number
  
- **`images`** - Item photos
  - `item_guid` (FOREIGN KEY): Reference to items
  - `image_data` or `image_path`: Image storage (configurable)
  - `thumbnail_data/path`: Thumbnail version
  - `is_primary`: Primary image flag
  
- **`qr_aliases`** - QR code mappings
  - `qr_code`: Scanned GUID/code
  - `item_guid` (FOREIGN KEY): Associated item
  - Enables multiple QR codes per item
  
- **`categories`** - Tags/categories
  - `item_guid` (FOREIGN KEY): Associated item
  - `category_name`: Category text
  
- **`_schema_version`** - Migration tracking
  - `version`: Schema version number
  - `applied_at`: Migration timestamp

---

## API Endpoints

### Items

- `GET /` - Home page with item list
- `GET /item/<guid>` - Item detail page
- `POST /api/create-item` - Create new item
- `PUT /api/update-item/<guid>` - Update item
- `DELETE /api/delete-item/<guid>` - Delete item
- `POST /api/set-parent` - Move item in hierarchy

### Search

- `GET /api/search?q=<query>` - Semantic search
- `GET /api/search?traditional=<query>` - Traditional text search

### Images

- `POST /api/upload-image` - Upload item image
- `GET /api/image/<id>` - Get full image
- `GET /api/thumbnail/<id>` - Get thumbnail
- `POST /api/rotate-image` - Rotate image

### QR Codes

- `POST /process-guid` - Process scanned QR code
- `GET /api/print-qr-codes` - Generate QR code PDF

### Admin

- `GET /admin` - Admin panel
- `POST /api/reindex-embeddings` - Regenerate search indexes
- `GET /api/db-stats` - Database statistics
- `POST /api/reboot-system` - Reboot Pi
- `POST /api/shutdown-system` - Shutdown Pi

### Backup

- `GET /backup` - Backup management page
- `POST /api/backup/create` - Create backup
- `POST /api/backup/restore` - Restore from uploaded file
- `POST /api/backup/restore-existing/<filename>` - Restore from saved backup
- `GET /api/backup/download/<filename>` - Download backup
- `DELETE /api/backup/delete/<filename>` - Delete backup

---

## Semantic Search

ThingDB uses [sentence-transformers](https://www.sbert.net/) for semantic search:

- **Model**: `all-MiniLM-L6-v2` (80MB download)
- **Vector Size**: 384 dimensions
- **Search Method**: Cosine similarity
- **Cache Location**: `/var/lib/thingdb/cache/models`
- **Performance**: Sub-second searches on 10,000+ items

### How It Works

1. Item descriptions are converted to 384-d vectors
2. Search queries are converted to same vector space
3. Cosine similarity finds semantically similar items
4. Better descriptions = better search results

### Re-indexing

When you update item descriptions:
1. Visit Admin Panel
2. Click "Reindex Embeddings"
3. Wait for processing to complete

---

## Installation Info

### What the Installer Does

1. **System Dependencies** (`install_system_deps.sh`)
   - Installs PostgreSQL, Python, build tools
   - Creates `thingdb` system user
   - Generates unique secrets (SECRET_KEY, POSTGRES_PASSWORD)
   - Sets up sudo permissions for power management
   - Creates data directories

2. **Application Deployment** (`install.sh`)
   - Copies code to `/var/lib/thingdb/app`
   - Creates Python virtual environment
   - Installs dependencies (PyTorch, Flask, etc.)
   - Initializes database schema
   - Sets up systemd service
   - Generates SSL certificates

3. **HTTPS Setup** (`setup_ssl.sh`)
   - Generates self-signed SSL certificate (365 days)
   - Updates service to use Gunicorn with SSL
   - Preserves existing custom certificates
   - Smart regeneration (only when needed)

### Idempotent Installation

The installer is safe to run multiple times:

- **Preserves:**
  - Database and all items
  - .env configuration (with backups)
  - SSL certificates (if valid)
  - Uploaded images
  - Saved backups

- **Updates:**
  - Application code
  - Python dependencies
  - System packages
  - Service configuration

### Installation Modes

- **FRESH** - New installation with generated secrets
- **UPGRADE** - Preserves data, updates code

### Files Created

```
/var/lib/thingdb/
â”œâ”€â”€ app/                    # Application code
â”‚   â”œâ”€â”€ .env               # Configuration (preserved on upgrade)
â”‚   â”œâ”€â”€ venv/              # Python virtual environment
â”‚   â””â”€â”€ src/thingdb/       # Source code
â”œâ”€â”€ ssl/                   # SSL certificates
â”‚   â”œâ”€â”€ cert.pem          # Certificate
â”‚   â”œâ”€â”€ key.pem           # Private key
â”‚   â””â”€â”€ .thingdb_marker   # Identifies our certs
â”œâ”€â”€ images/                # Uploaded images
â”œâ”€â”€ backups/               # Database backups
â”œâ”€â”€ cache/models/          # ML models (200MB)
â””â”€â”€ INSTALL_INFO           # Version tracking
```

---

## Testing

### Manual Testing on Pi

```bash
# SSH to your Pi
ssh pi@YOUR_PI_IP

# Check service status
sudo systemctl status thingdb

# View logs
sudo journalctl -u thingdb -f

# Test web interface
curl -k https://localhost:5000/

# Test API
curl -k https://localhost:5000/api/backup/status
```

### Testing Upgrades

```bash
# Install main branch
wget -qO- https://raw.githubusercontent.com/mcyork/thingdb/main/bootstrap.sh | bash

# Upgrade to dev
cd /tmp
wget https://github.com/mcyork/thingdb/archive/refs/heads/dev.zip
unzip dev.zip
cd thingdb-dev
sudo ./install.sh

# Verify data preserved
# Check INSTALL_INFO updated
```

---

## Contributing

Contributions welcome! Please:

1. **Fork the repository**
2. **Create a feature branch** (from `dev`, not `main`)
3. **Make your changes**
4. **Test on actual Raspberry Pi hardware** if possible
5. **Submit a pull request** to `dev` branch

### Code Style

- Python: Follow PEP 8
- Keep functions focused and documented
- Use type hints where helpful
- Comment complex logic

### Commit Messages

Use descriptive commits with emoji prefixes:
- âœ¨ New feature
- ğŸ”§ Bug fix
- ğŸ“ Documentation
- ğŸ¨ UI/UX improvements
- ğŸ”’ Security improvements

---

## Troubleshooting

### Service Won't Start

```bash
# Check logs
sudo journalctl -u thingdb -n 50

# Check database connection
sudo -u thingdb psql -U thingdb -d thingdb -h localhost

# Verify .env file
cat /var/lib/thingdb/app/.env
```

### Large Backup Restore Fails

- Check Gunicorn timeout: `grep timeout /etc/systemd/system/thingdb.service`
- Should be 600s minimum
- Update with: `cd /var/lib/thingdb/app && sudo ./setup_ssl.sh --service-only`

### SSL Certificate Issues

```bash
# Check certificate validity
openssl x509 -in /var/lib/thingdb/ssl/cert.pem -noout -dates

# Force regenerate
cd /var/lib/thingdb/app
sudo ./setup_ssl.sh --force

# Update service only (preserve certs)
sudo ./setup_ssl.sh --service-only
```

---

## Support

- **Issues**: [GitHub Issues](https://github.com/mcyork/thingdb/issues)
- **Discussions**: [GitHub Discussions](https://github.com/mcyork/thingdb/discussions)

---

**Happy Developing!** ğŸš€

