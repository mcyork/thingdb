version: '3.8'

services:
  nginx:
    build:
      context: .
      dockerfile: Dockerfile.nginx
    image: flask-filesystem-nginx:latest
    container_name: flask-filesystem-nginx
    ports:
      - "8080:80"      # HTTP (redirects to HTTPS)
      - "8443:443"     # HTTPS (different ports to avoid conflicts)
      - "8405:8404"    # Nginx stats
    volumes:
      - ../config/ssl-certs:/ssl-certs  # SSL certificates
      - flask-images:/var/lib/inventory/images:ro  # Read-only access to images
    depends_on:
      - flask-app
    restart: unless-stopped
    networks:
      - flask-filesystem-network

  flask-app:
    build:
      context: ..
      dockerfile: docker/Dockerfile.flask-prod
    image: flask-filesystem:latest
    container_name: flask-filesystem-app
    volumes:
      - ../config:/config                    # All configuration
      - ../config/ssl-certs:/ssl-certs      # SSL certificates
      - flask-images:/var/lib/inventory/images  # Read-write access to images
      - flask-filesystem-uploads:/app/uploads          # Temporary uploads
    environment:
      - FLASK_ENV=${FLASK_ENV:-production}
      - FLASK_DEBUG=${FLASK_DEBUG:-0}
      - SSL_ENABLED=${SSL_ENABLED:-true}
      
      # Image Storage Configuration
      - IMAGE_STORAGE_METHOD=filesystem
      - IMAGE_DIR=/var/lib/inventory/images
      - SERVE_IMAGES_FROM_FILES=true
      
      # Internal PostgreSQL settings (default)
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-flask_prod_pass}
      
      # External PostgreSQL settings (optional)
      - EXTERNAL_POSTGRES_HOST=${EXTERNAL_POSTGRES_HOST:-flask-filesystem-postgres}
      - EXTERNAL_POSTGRES_PORT=${EXTERNAL_POSTGRES_PORT:-5432}
      - EXTERNAL_POSTGRES_USER=${EXTERNAL_POSTGRES_USER:-inventory}
      - EXTERNAL_POSTGRES_PASSWORD=${EXTERNAL_POSTGRES_PASSWORD:-inventory_filesystem_pass}
      - EXTERNAL_POSTGRES_DB=${EXTERNAL_POSTGRES_DB:-inventory_filesystem}
    restart: unless-stopped
    expose:
      - "5000"
    networks:
      - flask-filesystem-network

  # PostgreSQL for filesystem storage version
  postgres:
    image: postgres:15
    container_name: flask-filesystem-postgres
    ports:
      - "5434:5432"  # Different port to avoid conflicts
    environment:
      - POSTGRES_DB=inventory_filesystem
      - POSTGRES_USER=inventory
      - POSTGRES_PASSWORD=inventory_filesystem_pass
    volumes:
      - postgres-filesystem-data:/var/lib/postgresql/data
    restart: unless-stopped
    networks:
      - flask-filesystem-network

volumes:
  flask-images:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /tmp/inventory-images  # Local directory for testing
  flask-filesystem-uploads:
    driver: local
  postgres-filesystem-data:
    driver: local

networks:
  flask-filesystem-network:
    driver: bridge
