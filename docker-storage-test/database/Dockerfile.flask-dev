FROM python:3.11-slim

# Install PostgreSQL and essential packages
RUN apt-get update && apt-get install -y \
    postgresql \
    postgresql-contrib \
    postgresql-client \
    sudo \
    curl \
    openssl \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# Ensure postgres user exists with correct home directory
RUN usermod -d /var/lib/postgresql postgres

# Create app directory
WORKDIR /app

# Copy Python requirements
COPY requirements/base-requirements.txt /tmp/base-requirements.txt
COPY requirements/ml-requirements.txt /tmp/ml-requirements.txt

# Install Python packages
RUN pip install --no-cache-dir -r /tmp/base-requirements.txt
RUN pip install --no-cache-dir -r /tmp/ml-requirements.txt

# Copy startup script to /startup.sh (not in /app since we mount over /app)
COPY startup/startup-dev.sh /startup.sh

# Create necessary directories
RUN mkdir -p /app/uploads /app/logs /postgres-data

# Make startup script executable
RUN chmod +x /startup.sh

# Set permissions for postgres directories
RUN chown -R postgres:postgres /postgres-data
RUN chmod 700 /postgres-data

# Environment variables for development
ENV FLASK_ENV=development
ENV FLASK_DEBUG=1

# Expose Flask port
EXPOSE 5000

# Use startup script to handle PostgreSQL initialization and Flask startup
CMD ["/startup.sh"]