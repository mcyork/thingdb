#!/usr/bin/env python3
"""
Interactive Installer for Raspberry Pi Components
================================================

This script provides an interactive menu to install different components:
1. Deploy Serial Agent
2. Deploy Network Components  
3. Deploy Application
4. Show Status
5. Exit

Usage: ./install
"""

import os
import sys
import subprocess
import shutil
from pathlib import Path

# Colors for output
class Colors:
    RED = '\033[0;31m'
    GREEN = '\033[0;32m'
    YELLOW = '\033[1;33m'
    BLUE = '\033[0;34m'
    PURPLE = '\033[0;35m'
    CYAN = '\033[0;36m'
    NC = '\033[0m'  # No Color

def print_colored(text, color):
    """Print colored text"""
    print(f"{color}{text}{Colors.NC}")

def print_status(text):
    print_colored(f"[INFO] {text}", Colors.BLUE)

def print_success(text):
    print_colored(f"[SUCCESS] {text}", Colors.GREEN)

def print_warning(text):
    print_colored(f"[WARNING] {text}", Colors.YELLOW)

def print_error(text):
    print_colored(f"[ERROR] {text}", Colors.RED)

def print_header(text):
    print_colored(f"\n{text}", Colors.CYAN)
    print("=" * len(text))

def check_pi_cli():
    """Check if pi CLI tool is available"""
    if shutil.which("pi"):
        return "pi"
    elif os.path.exists("/Users/ianmccutcheon/projects/pi-shell/pi"):
        return "/Users/ianmccurcheon/projects/pi-shell/pi"
    else:
        return None

def check_pi_status():
    """Check if default Pi is online"""
    pi_cli = check_pi_cli()
    if not pi_cli:
        return False, "pi CLI tool not found"
    
    try:
        result = subprocess.run([pi_cli, "list"], capture_output=True, text=True, check=True)
        if "Yes" not in result.stdout:
            return False, "No default Pi configured"
        
        # Get default Pi name
        lines = result.stdout.strip().split('\n')
        default_pi = None
        for line in lines:
            if "Yes" in line:
                default_pi = line.split()[0]
                break
        
        if not default_pi:
            return False, "Could not determine default Pi"
        
        # Check if Pi is online
        status_result = subprocess.run([pi_cli, "status", default_pi], capture_output=True, text=True, check=True)
        if "ONLINE" in status_result.stdout:
            return True, f"Pi '{default_pi}' is online"
        else:
            return False, f"Pi '{default_pi}' is offline"
            
    except subprocess.CalledProcessError as e:
        return False, f"Error checking Pi status: {e}"
    except Exception as e:
        return False, f"Unexpected error: {e}"

def deploy_serial():
    """Deploy serial agent"""
    print_header("Deploying Serial Agent")
    
    pi_cli = check_pi_cli()
    if not pi_cli:
        print_error("pi CLI tool not found. Please install it first.")
        return False
    
    # Check Pi status
    is_online, status_msg = check_pi_status()
    if not is_online:
        print_error(f"Pi is not ready: {status_msg}")
        return False
    
    print_success(f"Pi status: {status_msg}")
    
    # Run serial installation
    script_path = Path(__file__).parent / "serial" / "install-serial-agent.sh"
    if not script_path.exists():
        print_error(f"Serial installation script not found: {script_path}")
        return False
    
    print_status("Running serial agent installation...")
    try:
        result = subprocess.run([str(script_path)], check=True)
        print_success("Serial agent deployment completed!")
        return True
    except subprocess.CalledProcessError as e:
        print_error(f"Serial agent deployment failed: {e}")
        return False

def deploy_network():
    """Deploy network components"""
    print_header("Deploying Network Components")
    
    pi_cli = check_pi_cli()
    if not pi_cli:
        print_error("pi CLI tool not found. Please install it first.")
        return False
    
    # Check Pi status
    is_online, status_msg = check_pi_status()
    if not is_online:
        print_error(f"Pi is not ready: {status_msg}")
        return False
    
    print_success(f"Pi status: {status_msg}")
    
    print_warning("Network installation requires direct access to the Pi.")
    print_status("You have two options:")
    print("1. Run this script directly on the Pi")
    print("2. Use remote installation via pi CLI")
    
    choice = input("\nChoose option (1 or 2): ").strip()
    
    if choice == "1":
        print_status("Please run this script directly on the Pi:")
        script_path = Path(__file__).parent / "network" / "install-network.sh"
        print_colored(f"  sudo {script_path}", Colors.YELLOW)
        return True
    elif choice == "2":
        print_status("Using remote network installation...")
        script_path = Path(__file__).parent / "network" / "install-network-remote.sh"
        if not script_path.exists():
            print_error(f"Remote network installation script not found: {script_path}")
            return False
        
        try:
            result = subprocess.run([str(script_path)], check=True)
            print_success("Network components deployment completed!")
            return True
        except subprocess.CalledProcessError as e:
            print_error(f"Network components deployment failed: {e}")
            return False
    else:
        print_error("Invalid choice")
        return False

def deploy_application():
    """Deploy the main application"""
    print_header("Deploying Application")
    
    pi_cli = check_pi_cli()
    if not pi_cli:
        print_error("pi CLI tool not found. Please install it first.")
        return False
    
    # Check Pi status
    is_online, status_msg = check_pi_status()
    if not is_online:
        print_error(f"Pi is not ready: {status_msg}")
        return False
    
    print_success(f"Pi status: {status_msg}")
    
    print_status("This will deploy the full inventory application.")
    print_warning("Make sure you have prepared the deployment package first.")
    
    # Check if deployment package exists
    deploy_package = Path.home() / "inventory-deploy-build" / "inventory-deploy.tar.gz"
    if not deploy_package.exists():
        print_error(f"Deployment package not found: {deploy_package}")
        print_status("Please run the deployment preparation first:")
        prep_script = Path(__file__).parent / "deploy" / "deploy-prepare-clean.sh"
        print_colored(f"  {prep_script}", Colors.YELLOW)
        return False
    
    print_success(f"Found deployment package: {deploy_package}")
    
    # Run deployment
    print_status("Starting application deployment...")
    deploy_script = Path(__file__).parent / "deploy" / "deploy-remote-clean.sh"
    
    try:
        result = subprocess.run([str(deploy_script)], check=True)
        print_success("Application deployment completed!")
        return True
    except subprocess.CalledProcessError as e:
        print_error(f"Application deployment failed: {e}")
        return False

def show_status():
    """Show current status"""
    print_header("System Status")
    
    # Check pi CLI
    pi_cli = check_pi_cli()
    if pi_cli:
        print_success(f"pi CLI tool: {pi_cli}")
    else:
        print_error("pi CLI tool: Not found")
    
    # Check Pi status
    is_online, status_msg = check_pi_status()
    if is_online:
        print_success(f"Pi status: {status_msg}")
    else:
        print_warning(f"Pi status: {status_msg}")
    
    # Check deployment package
    deploy_package = Path.home() / "inventory-deploy-build" / "inventory-deploy.tar.gz"
    if deploy_package.exists():
        size_mb = deploy_package.stat().st_size / (1024 * 1024)
        print_success(f"Deployment package: {deploy_package.name} ({size_mb:.1f} MB)")
    else:
        print_warning("Deployment package: Not found")
    
    # Check available scripts
    print_status("\nAvailable installation scripts:")
    scripts = {
        "Serial": Path(__file__).parent / "serial" / "install-serial-agent.sh",
        "Network": Path(__file__).parent / "network" / "install-network.sh",
        "Network Remote": Path(__file__).parent / "network" / "install-network-remote.sh",
        "Deploy Prepare": Path(__file__).parent / "deploy" / "deploy-prepare-clean.sh",
        "Deploy Remote": Path(__file__).parent / "deploy" / "deploy-remote-clean.sh"
    }
    
    for name, path in scripts.items():
        if path.exists():
            print_success(f"  ✓ {name}: {path.name}")
        else:
            print_error(f"  ✗ {name}: {path.name} (missing)")

def quick_deploy():
    """Quick deploy serial and network components"""
    print_header("Quick Deploy (Serial + Network)")
    print_status("This will deploy both serial and network components in sequence.")
    
    # Deploy serial first
    print_status("Step 1: Deploying Serial Agent...")
    if not deploy_serial():
        print_error("Serial deployment failed. Stopping quick deploy.")
        return False
    
    print_success("Serial deployment completed successfully!")
    
    # Deploy network
    print_status("Step 2: Deploying Network Components...")
    if not deploy_network():
        print_error("Network deployment failed. Quick deploy incomplete.")
        return False
    
    print_success("Network deployment completed successfully!")
    
    print_header("Quick Deploy Complete!")
    print_success("✅ Serial Agent: Installed and configured")
    print_success("✅ Network Components: Installed and configured")
    print_warning("⚠️  IMPORTANT: Reboot required for UART configuration to take effect")
    print_status("Your Pi now has both serial communication and network management capabilities!")
    
    return True

def reboot_pi():
    """Reboot the Raspberry Pi"""
    print_header("Reboot Raspberry Pi")
    
    pi_cli = check_pi_cli()
    if not pi_cli:
        print_error("pi CLI tool not found. Please install it first.")
        return False
    
    # Check Pi status
    is_online, status_msg = check_pi_status()
    if not is_online:
        print_error(f"Pi is not ready: {status_msg}")
        return False
    
    print_success(f"Pi status: {status_msg}")
    
    # Get default Pi name for confirmation
    try:
        result = subprocess.run([pi_cli, "list"], capture_output=True, text=True, check=True)
        lines = result.stdout.strip().split('\n')
        default_pi = None
        for line in lines:
            if "Yes" in line:
                default_pi = line.split()[0]
                break
        
        if not default_pi:
            print_error("Could not determine default Pi")
            return False
            
        print_warning(f"This will reboot Pi '{default_pi}' immediately!")
        print_status("Make sure you have saved any work and closed any active connections.")
        
        confirm = input(f"\nAre you sure you want to reboot {default_pi}? (yes/no): ").strip().lower()
        
        if confirm in ['yes', 'y']:
            print_status(f"Rebooting {default_pi}...")
            try:
                result = subprocess.run([pi_cli, "run-stream", "--pi", default_pi, "sudo reboot"], check=True)
                print_success(f"Reboot command sent to {default_pi}")
                print_status("The Pi will restart in a few moments.")
                print_warning("Note: You may lose connection temporarily during reboot.")
            except subprocess.CalledProcessError as e:
                print_error(f"Failed to send reboot command: {e}")
                return False
        else:
            print_status("Reboot cancelled.")
            return True
            
    except subprocess.CalledProcessError as e:
        print_error(f"Error getting Pi information: {e}")
        return False
    except Exception as e:
        print_error(f"Unexpected error: {e}")
        return False
    
    return True

def main_menu():
    """Display main menu and handle user input"""
    while True:
        print_header("Raspberry Pi Component Installer")
        print("Choose what you want to install:")
        print("1. Deploy Serial Agent")
        print("2. Deploy Network Components")
        print("3. Deploy Application")
        print("4. Show Status")
        print("5. Quick Deploy (Serial + Network)")
        print("6. Reboot Pi")
        print("7. Exit")
        
        choice = input("\nEnter your choice (1-7): ").strip()
        
        if choice == "1":
            deploy_serial()
        elif choice == "2":
            deploy_network()
        elif choice == "3":
            deploy_application()
        elif choice == "4":
            show_status()
        elif choice == "5":
            quick_deploy()
        elif choice == "6":
            reboot_pi()
        elif choice == "7":
            print_success("Goodbye!")
            break
        else:
            print_error("Invalid choice. Please enter 1-7.")
        
        if choice in ["1", "2", "3", "5", "6"]:
            input("\nPress Enter to continue...")

if __name__ == "__main__":
    try:
        main_menu()
    except KeyboardInterrupt:
        print("\n\nInterrupted by user")
        sys.exit(0)
    except Exception as e:
        print_error(f"Unexpected error: {e}")
        sys.exit(1)
